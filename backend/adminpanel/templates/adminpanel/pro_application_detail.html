{% extends 'adminpanel/base.html' %}

{% block title %}Détail de la Demande - Coucou Beauté{% endblock %}

{% block extra_css %}
<style>
    /* ==========================
       RESPONSIVE MOBILE OPTIMIZATIONS
       ========================== */
    @media (max-width: 768px) {

        /* Container mobile */
        .p-6 {
            padding: 1rem !important;
        }

        .space-y-6>*+* {
            margin-top: 1rem !important;
        }

        /* Header mobile */
        .flex.items-center.justify-between {
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 1rem !important;
        }

        .w-12.h-12 {
            width: 2.5rem !important;
            height: 2.5rem !important;
        }

        h1 {
            font-size: 1.5rem !important;
        }

        p {
            font-size: 0.875rem !important;
        }

        /* Grid mobile */
        .grid.lg\\:grid-cols-3 {
            grid-template-columns: 1fr !important;
            gap: 1rem !important;
        }

        .lg\\:col-span-2 {
            grid-column: span 1 !important;
        }

        /* Glass containers mobile */
        .glass.p-6 {
            padding: 1rem !important;
        }

        /* Profile section mobile */
        .flex.items-start.gap-5 {
            flex-direction: column !important;
            gap: 1rem !important;
            align-items: center !important;
            text-align: center;
        }

        .flex.items-start.gap-5 img {
            width: 5rem !important;
            height: 5rem !important;
        }

        .flex-1 {
            width: 100%;
        }

        .text-2xl {
            font-size: 1.25rem !important;
        }

        .flex.items-center.gap-4 {
            flex-direction: column !important;
            align-items: center !important;
            gap: 0.5rem !important;
        }

        .flex.flex-wrap.gap-2 {
            justify-content: center;
        }

        /* Info grid mobile */
        .grid.md\\:grid-cols-2 {
            grid-template-columns: 1fr !important;
            gap: 0.75rem !important;
        }

        .p-4.rounded-xl.border {
            padding: 0.875rem !important;
        }

        /* Map link mobile */
        a.text-pink-600 {
            font-size: 0.8125rem !important;
        }

        /* Historique mobile */
        .space-y-2>* {
            margin-top: 0.5rem !important;
        }

        .p-3.rounded-xl.border.bg-white\\/60 {
            padding: 0.75rem !important;
        }

        /* Sidebar mobile */
        .glass.p-6:last-child {
            padding: 1rem !important;
        }

        .glass.p-6:last-child img {
            max-height: 12rem !important;
        }

        /* Textarea mobile - 16px font */
        #notes {
            font-size: 16px !important;
            padding: 0.75rem !important;
        }

        /* Buttons mobile */
        .flex.gap-2:has(#approveBtn) {
            flex-direction: column;
            gap: 0.75rem !important;
        }

        #approveBtn,
        #rejectBtn {
            width: 100%;
            font-size: 0.9375rem !important;
            padding: 0.875rem !important;
            min-height: 48px;
        }
    }

    /* Small mobile (iPhone SE) */
    @media (max-width: 375px) {
        h1 {
            font-size: 1.25rem !important;
        }

        .w-12.h-12 {
            width: 2rem !important;
            height: 2rem !important;
        }

        .flex.items-start.gap-5 img {
            width: 4rem !important;
            height: 4rem !important;
        }

        .text-2xl {
            font-size: 1.125rem !important;
        }
    }

    /* Landscape mobile */
    @media (max-width: 768px) and (orientation: landscape) {
        .glass.p-6:last-child img {
            max-height: 10rem !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="p-6 space-y-6">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div
                class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-300 to-rose-400 flex items-center justify-center text-white shadow">
                <i data-lucide="sparkles" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Validation d'une inscription</h1>
                <p class="text-gray-600">Interface claire et accueillante pour centres de beauté</p>
            </div>
        </div>
        <a href="{% url 'adminpanel:pros_pending' %}" class="btn-secondary-glass">Retour</a>
    </div>

    <div class="grid lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 glass p-6">
            <div class="flex items-start gap-5">
                <img src="{{ app.profile_photo|default:'/static/images/placeholder-avatar.png' }}"
                    class="w-24 h-24 rounded-2xl object-cover ring-1 ring-pink-100" alt="Photo profil" />
                <div class="flex-1">
                    <div class="text-2xl font-semibold text-gray-900">{{ app.first_name }} {{ app.last_name }}</div>
                    <div class="mt-1 text-gray-600 flex items-center gap-4">
                        <span class="inline-flex items-center gap-1"><i data-lucide="mail" class="w-4 h-4"></i>
                            {{ app.email }}</span>
                        <span class="inline-flex items-center gap-1"><i data-lucide="phone" class="w-4 h-4"></i>
                            {{ app.phone_number }}</span>
                    </div>
                    <div class="mt-2 flex items-center gap-2 text-sm text-gray-600">
                        <span class="inline-flex items-center gap-1">
                            <i data-lucide="user" class="w-4 h-4"></i>
                            {% if app.gender == 'male' %}Homme{% else %}Femme{% endif %}
                        </span>
                    </div>
                    <div class="mt-3 flex flex-wrap gap-2">
                        <span class="px-2 py-1 text-xs rounded-full bg-pink-50 text-pink-700 border" id="categoryBadge">
                            {{ app.activity_category }}</span>
                        <span class="px-2 py-1 text-xs rounded-full bg-blue-50 text-blue-700 border"
                            id="serviceTypeBadge">
                            {{ app.service_type }}</span>
                        {% if app.service_type == 'salon' and app.salon_name %}
                        <span class="px-2 py-1 text-xs rounded-full bg-violet-50 text-violet-700 border">
                            {{ app.salon_name }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Services proposés -->
            <div class="mt-6">
                <div class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                    <i data-lucide="scissors" class="w-4 h-4"></i> Services proposés
                </div>
                <div id="servicesList" class="grid md:grid-cols-2 gap-2">
                    <!-- Les services seront chargés dynamiquement -->
                    <div class="text-gray-500 text-sm">Chargement...</div>
                </div>
            </div>

            <div class="mt-6 grid md:grid-cols-2 gap-4">
                <div class="p-4 rounded-xl border bg-white/60">
                    <div class="text-xs text-gray-500 inline-flex items-center gap-1"><i data-lucide="map-pin"
                            class="w-4 h-4"></i>Adresse professionnelle</div>
                    <div class="text-gray-900 mt-1">{{ app.address }}</div>
                    {% if app.latitude and app.longitude %}
                    <a class="text-pink-600 text-sm mt-2 inline-block" target="_blank"
                        href="https://www.google.com/maps/search/?api=1&query={{ app.latitude }},{{ app.longitude }}">Ouvrir
                        dans Google Maps</a>
                    {% endif %}
                </div>
                <div class="p-4 rounded-xl border bg-white/60">
                    <div class="text-xs text-gray-500 inline-flex items-center gap-1"><i data-lucide="globe"
                            class="w-4 h-4"></i>Langues parlées</div>
                    <div class="text-gray-900 mt-1">{{ app.spoken_languages|join:', ' }}</div>
                </div>
            </div>

            <div class="mt-6">
                <div class="text-sm font-medium text-gray-700 mb-2">Historique</div>
                <div class="space-y-2">
                    {% for a in app.actions %}
                    <div class="p-3 rounded-xl border bg-white/60 flex items-center justify-between">
                        <div>
                            <div class="font-medium text-gray-800">{{ a.action|capfirst }}</div>
                            <div class="text-xs text-gray-500">{{ a.actor|default:'—' }}</div>
                        </div>
                        <div class="text-xs text-gray-500">{{ a.created_at }}</div>
                    </div>
                    {% empty %}
                    <div class="text-gray-500 text-sm">Aucun événement pour l'instant.</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="glass p-6">
            <div>
                <div class="text-sm text-gray-600 mb-2 inline-flex items-center gap-2"><i data-lucide="badge-check"
                        class="w-5 h-5"></i>Pièce d'identité</div>
                <div class="rounded-xl border bg-white/60 p-2">
                    <img src="{{ app.id_document|default:'/static/images/placeholder-doc.png' }}"
                        class="w-full max-h-56 object-cover rounded-lg" alt="Pièce d'identité" />
                </div>
            </div>

            <div class="mt-6">
                <label class="block text-sm text-gray-600 mb-2 inline-flex items-center gap-2"><i
                        data-lucide="sticky-note" class="w-5 h-5"></i>Notes</label>
                <textarea id="notes" class="w-full border rounded-xl p-3" rows="4"
                    placeholder="Laisser une note (visible seulement par l'équipe)"></textarea>
            </div>

            <div class="mt-4 flex gap-2">
                <button id="approveBtn" class="btn-glass text-green-700">Approuver</button>
                <button id="rejectBtn" class="btn-secondary-glass text-red-700">Refuser</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Traduction des catégories en français
    const categoryLabels = {
        'hairdressing': 'Coiffure', 'haircut_women': 'Coupe femme', 'haircut_men': 'Coupe homme',
        'haircut_children': 'Coupe enfant', 'hair_coloring': 'Coloration', 'highlights': 'Mèches & Balayage',
        'hair_styling': 'Brushing & Coiffage', 'hair_treatment': 'Soins capillaires', 'keratin': 'Lissage & Kératine',
        'hair_extensions': 'Extensions cheveux', 'braiding': 'Tresses & Nattes', 'bridal_hair': 'Coiffure mariée',
        'makeup': 'Maquillage', 'bridal_makeup': 'Maquillage mariée', 'evening_makeup': 'Maquillage soirée',
        'natural_makeup': 'Maquillage naturel', 'makeup_lesson': 'Cours de maquillage',
        'manicure': 'Manucure', 'pedicure': 'Pédicure', 'nail_art': 'Nail art', 'gel_nails': 'Pose gel',
        'acrylic_nails': 'Pose résine', 'semi_permanent': 'Semi-permanent', 'nail_care': 'Soins des ongles',
        'esthetics': 'Esthétique', 'facial': 'Soin du visage', 'deep_cleansing': 'Nettoyage de peau',
        'anti_aging': 'Soin anti-âge', 'hydration': 'Soin hydratant', 'acne_treatment': 'Traitement acné',
        'microdermabrasion': 'Microdermabrasion', 'chemical_peel': 'Peeling', 'led_therapy': 'Luminothérapie LED',
        'waxing': 'Épilation cire', 'waxing_face': 'Épilation visage', 'waxing_body': 'Épilation corps',
        'waxing_bikini': 'Épilation maillot', 'threading': 'Épilation au fil', 'laser_hair': 'Épilation laser',
        'sugaring': 'Épilation au sucre', 'eyebrows': 'Épilation sourcils', 'eyebrow_tint': 'Teinture sourcils',
        'eyebrow_lamination': 'Brow lamination', 'microblading': 'Microblading', 'eyelash_extensions': 'Extension de cils',
        'eyelash_lift': 'Rehaussement de cils', 'eyelash_tint': 'Teinture de cils',
        'massage': 'Massage', 'relaxing_massage': 'Massage relaxant', 'deep_tissue': 'Massage deep tissue',
        'hot_stone': 'Massage pierres chaudes', 'aromatherapy': 'Aromathérapie', 'reflexology': 'Réflexologie',
        'lymphatic_drainage': 'Drainage lymphatique', 'prenatal_massage': 'Massage prénatal',
        'body_treatment': 'Soin du corps', 'body_scrub': 'Gommage corps', 'body_wrap': 'Enveloppement',
        'slimming': 'Soin minceur', 'cellulite': 'Traitement cellulite', 'tanning': 'Bronzage', 'spray_tan': 'Autobronzant',
        'spa': 'Spa', 'hammam': 'Hammam', 'sauna': 'Sauna', 'jacuzzi': 'Jacuzzi',
        'permanent_makeup': 'Maquillage permanent', 'lip_tattoo': 'Tatouage lèvres', 'eyeliner_tattoo': 'Tatouage eye-liner',
        'barber': 'Barbier', 'beard_trim': 'Taille de barbe', 'beard_care': 'Soins barbe', 'men_facial': 'Soin visage homme',
        'henna': 'Henné', 'teeth_whitening': 'Blanchiment dentaire', 'piercing': 'Piercing', 'other': 'Autre'
    };

    const serviceTypeLabels = {
        'mobile': 'Se déplace',
        'home': 'Reçoit chez soi',
        'salon': 'Salon'
    };

    // Traduire les badges
    document.addEventListener('DOMContentLoaded', function () {
        const categoryBadge = document.getElementById('categoryBadge');
        const serviceTypeBadge = document.getElementById('serviceTypeBadge');

        if (categoryBadge) {
            const code = categoryBadge.textContent.trim().toLowerCase();
            categoryBadge.textContent = categoryLabels[code] || categoryBadge.textContent;
        }

        if (serviceTypeBadge) {
            const code = serviceTypeBadge.textContent.trim().toLowerCase();
            serviceTypeBadge.textContent = serviceTypeLabels[code] || serviceTypeBadge.textContent;
        }

        // Charger les services
        loadServices();
    });

    async function loadServices() {
        const servicesList = document.getElementById('servicesList');
        try {
            const res = await fetch('/api/applications/professionals/{{ app.id }}/');
            if (res.ok) {
                const data = await res.json();
                if (data.services && Array.isArray(data.services) && data.services.length > 0) {
                    servicesList.innerHTML = data.services.map(s => `
                        <div class="p-3 rounded-xl border bg-white/60 flex items-center justify-between">
                            <div>
                                <div class="font-medium text-gray-800">${s.name || 'Service'}</div>
                                <div class="text-xs text-gray-500">${s.duration_min || 60} min</div>
                            </div>
                            <div class="text-sm font-semibold text-pink-600">${s.price || 0} DT</div>
                        </div>
                    `).join('');
                } else {
                    servicesList.innerHTML = '<div class="text-gray-500 text-sm col-span-2">Aucun service spécifié</div>';
                }
            }
        } catch (e) {
            servicesList.innerHTML = '<div class="text-gray-500 text-sm col-span-2">Impossible de charger les services</div>';
        }
    }

    async function decide(action) {
        const btn = action === 'approve' ? document.getElementById('approveBtn') : document.getElementById('rejectBtn');
        btn.disabled = true; btn.classList.add('opacity-60');
        try {
            const notes = document.getElementById('notes').value || '';
            const res = await fetch(`/api/applications/professionals/{{ app.id }}/${action}/`, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' }, body: JSON.stringify({ notes }) });
            if (res.ok) {
                window.location.href = "{% url 'adminpanel:pros_pending' %}";
            }
        } finally {
            btn.disabled = false; btn.classList.remove('opacity-60');
        }
    }
    document.getElementById('approveBtn').addEventListener('click', () => decide('approve'));
    document.getElementById('rejectBtn').addEventListener('click', () => decide('reject'));
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}