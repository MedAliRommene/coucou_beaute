{% extends 'adminpanel/base.html' %}

{% block title %}Détail du Professionnel - Coucou Beauté{% endblock %}

{% block extra_css %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    .animate-pulse-slow {
        animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    .animate-fade-in {
        animation: fadeIn 0.6s ease-out;
    }

    .animate-slide-up {
        animation: slideUp 0.4s ease-out;
    }

    .animate-bounce-in {
        animation: bounceIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes bounceIn {
        0% {
            opacity: 0;
            transform: scale(0.3);
        }

        50% {
            opacity: 1;
            transform: scale(1.05);
        }

        70% {
            transform: scale(0.9);
        }

        100% {
            opacity: 1;
            transform: scale(1);
        }
    }

    .schedule-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .schedule-card:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .schedule-card.confirmed {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        box-shadow: 0 8px 32px rgba(239, 68, 68, 0.3);
    }

    .schedule-card.pending {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        box-shadow: 0 8px 32px rgba(245, 158, 11, 0.3);
    }

    .schedule-card.completed {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
    }

    .schedule-card.cancelled {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        box-shadow: 0 8px 32px rgba(107, 114, 128, 0.3);
    }

    .schedule-card.available {
        background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
        border: 2px dashed #9ca3af;
    }

    .schedule-card.available:hover {
        background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
        border-color: #6b7280;
    }

    .glassmorphism {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .particle-bg {
        position: relative;
        overflow: hidden;
    }

    .particle-bg::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
        animation: float 6s ease-in-out infinite;
    }

    @keyframes float {

        0%,
        100% {
            transform: translateY(0px) rotate(0deg);
        }

        33% {
            transform: translateY(-10px) rotate(1deg);
        }

        66% {
            transform: translateY(5px) rotate(-1deg);
        }
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        animation: pulse 2s infinite;
    }

    .status-indicator.confirmed {
        background-color: #ef4444;
    }

    .status-indicator.pending {
        background-color: #f59e0b;
    }

    .status-indicator.completed {
        background-color: #10b981;
    }

    .status-indicator.cancelled {
        background-color: #6b7280;
    }

    .time-slot {
        font-family: 'Inter', sans-serif;
        font-weight: 500;
    }

    .service-name {
        font-family: 'Inter', sans-serif;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .client-name {
        font-family: 'Inter', sans-serif;
        font-weight: 400;
        font-size: 0.75rem;
        opacity: 0.9;
    }

    .duration-badge {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="p-6 space-y-6">
    <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
            <div
                class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-400 to-blue-400 flex items-center justify-center text-white">
                <i data-lucide="factory" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Centre professionnel</h1>
                <p class="text-gray-600 mt-1">Vue analytique et informations clés</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <a href="{% url 'adminpanel:pros' %}" class="btn-secondary-glass">Retour</a>
            <button class="btn-glass text-blue-700">Éditer le profil</button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="kpi-glass flex items-center gap-4 p-5">
            <div
                class="w-12 h-12 rounded-xl bg-gradient-to-br from-pink-300 to-blue-300 flex items-center justify-center text-white">
                <i data-lucide="building-2" class="w-6 h-6"></i>
            </div>
            <div class="flex-1">
                <div class="text-sm text-gray-600">Nom du centre</div>
                <div class="text-xl font-semibold">{{ pro.business_name|default:'—' }}</div>
            </div>
        </div>
        <div class="kpi-glass flex items-center gap-4 p-5">
            <div
                class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-300 to-teal-300 flex items-center justify-center text-white">
                <i data-lucide="badge-check" class="w-6 h-6"></i>
            </div>
            <div class="flex-1">
                <div class="text-sm text-gray-600">Vérifié</div>
                <div class="text-xl font-semibold">{{ pro.is_verified|yesno:'Oui,Non' }}</div>
            </div>
        </div>
        <div class="kpi-glass flex items-center gap-4 p-5">
            <div
                class="w-12 h-12 rounded-xl bg-gradient-to-br from-yellow-200 to-amber-300 flex items-center justify-center text-white">
                <i data-lucide="calendar-days" class="w-6 h-6"></i>
            </div>
            <div class="flex-1">
                <div class="text-sm text-gray-600">Créé le</div>
                <div class="text-xl font-semibold">{{ pro.created_at }}</div>
            </div>
        </div>
        <div class="kpi-glass flex items-center gap-4 p-5">
            <div
                class="w-12 h-12 rounded-xl bg-gradient-to-br from-violet-300 to-pink-300 flex items-center justify-center text-white">
                <i data-lucide="mail" class="w-6 h-6"></i>
            </div>
            <div class="flex-1">
                <div class="text-sm text-gray-600">Email</div>
                <div class="text-xl font-semibold">{{ pro.email }}</div>
            </div>
        </div>
    </div>

    <div class="glass p-6">
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-xl font-semibold text-gray-900">Analytique</h2>
            <div class="flex items-center gap-2 text-sm">
                <input id="anFrom" type="date" class="border rounded-lg px-2 py-1" />
                <span>→</span>
                <input id="anTo" type="date" class="border rounded-lg px-2 py-1" />
                <button class="btn-secondary-glass" onclick="reloadAnalytics()">Appliquer</button>
            </div>
        </div>
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <div class="bg-white/40 rounded-xl border p-4 xl:col-span-2">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-medium text-gray-700">Tendance quotidienne</h3>
                    <div class="text-xs text-gray-500">Réservations par jour</div>
                </div>
                <canvas id="chartTrend" height="120"></canvas>
            </div>
            <div class="bg-white/40 rounded-xl border p-4">
                <h3 class="text-sm font-medium text-gray-700 mb-2">Répartition des services</h3>
                <canvas id="chartServices" height="120"></canvas>
            </div>
        </div>
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mt-6">
            <div class="bg-white/40 rounded-xl border p-4">
                <h3 class="text-sm font-medium text-gray-700 mb-2">Par heure de la journée</h3>
                <canvas id="chartHourly" height="120"></canvas>
            </div>
            <div class="bg-white/40 rounded-xl border p-4">
                <h3 class="text-sm font-medium text-gray-700 mb-2">Réservations par semaine</h3>
                <canvas id="chartReservations" height="120"></canvas>
            </div>
            <div class="bg-white/40 rounded-xl border p-4">
                <h3 class="text-sm font-medium text-gray-700 mb-2">Chiffre d'affaires</h3>
                <canvas id="chartRevenue" height="120"></canvas>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
            <div class="kpi-glass p-4">
                <div class="text-xs text-gray-500">En attente</div>
                <div id="kpiPending" class="text-2xl font-semibold">—</div>
            </div>
            <div class="kpi-glass p-4">
                <div class="text-xs text-gray-500">Confirmés</div>
                <div id="kpiConfirmed" class="text-2xl font-semibold">—</div>
            </div>
            <div class="kpi-glass p-4">
                <div class="text-xs text-gray-500">Annulés</div>
                <div id="kpiCancelled" class="text-2xl font-semibold">—</div>
            </div>
            <div class="kpi-glass p-4">
                <div class="text-xs text-gray-500">Terminés</div>
                <div id="kpiCompleted" class="text-2xl font-semibold">—</div>
            </div>
        </div>
    </div>
    <div class="glass p-6">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-900 mb-1">Agenda du jour</h2>
                <p class="text-gray-600 text-sm">Gestion des créneaux horaires en temps réel</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="relative">
                    <input id="dayPicker" type="date"
                        class="bg-white/80 backdrop-blur-sm border-2 border-gray-200 rounded-xl px-4 py-2.5 text-gray-700 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 transition-all duration-200 shadow-sm hover:shadow-md" />
                    <i data-lucide="calendar"
                        class="w-5 h-5 text-gray-400 absolute right-3 top-3 pointer-events-none"></i>
                </div>
                <button onclick="reloadAgenda()"
                    class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-2.5 rounded-xl font-medium shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 flex items-center gap-2 animate-pulse-slow">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    Charger
                </button>
            </div>
        </div>

        <!-- Modern Timeline Container -->
        <div id="timeline"
            class="relative bg-gradient-to-br from-gray-50 to-blue-50 rounded-2xl p-6 border border-gray-100 shadow-inner particle-bg">
            <!-- Compact Layout -->
            <div class="space-y-1">
                <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-4">Agenda du jour</div>
                <div id="scheduleGrid" class="relative space-y-1">
                    <!-- Schedule slots will be rendered here -->
                </div>
            </div>
        </div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="glass p-6 lg:col-span-2">
            <h2 class="text-xl font-semibold text-gray-900 mb-3">Informations du centre</h2>
            <div class="grid md:grid-cols-2 gap-4">
                <div class="p-4 rounded-xl border bg-white/50">
                    <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="map-pin"
                            class="w-4 h-4"></i> Adresse</div>
                    <div class="text-gray-900 mt-1">{{ pro.address|default:'—' }}</div>
                </div>
                <div class="p-4 rounded-xl border bg-white/50">
                    <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="phone"
                            class="w-4 h-4"></i> Téléphone</div>
                    <div class="text-gray-900 mt-1">{{ pro.phone|default:'—' }}</div>
                </div>
                <div class="p-4 rounded-xl border bg-white/50">
                    <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="mail"
                            class="w-4 h-4"></i> Email</div>
                    <div class="text-gray-900 mt-1">{{ pro.email }}</div>
                </div>
                <div class="p-4 rounded-xl border bg-white/50">
                    <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="calendar"
                            class="w-4 h-4"></i> Créé le</div>
                    <div class="text-gray-900 mt-1">{{ pro.created_at }}</div>
                </div>
                {% if pro.extra %}
                <div class="md:col-span-2 p-4 rounded-xl border bg-white/50">
                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="user-round"
                                class="w-4 h-4"></i> Biographie</div>
                        <button class="btn-secondary-glass" onclick="openModal('modalBio')">Modifier</button>
                    </div>
                    <div id="bioText" class="text-gray-900 mt-1">{{ pro.extra.bio|default:'—' }}</div>
                </div>
                <div class="p-4 rounded-xl border bg-white/50">
                    <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="calendar-check"
                            class="w-4 h-4"></i> Jours de travail</div>
                    <div class="text-gray-900 mt-2 flex flex-wrap gap-2">
                        {% for d in pro.extra.working_days %}
                        <span class="px-2 py-1 rounded-full text-xs bg-pink-50 text-pink-700 border border-pink-200">
                            {{ d|upper }}</span>
                        {% empty %}
                        <span class="text-gray-500">—</span>
                        {% endfor %}
                    </div>
                </div>
                <div class="p-4 rounded-xl border bg-white/50">
                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="clock-8"
                                class="w-4 h-4"></i> Horaires</div>
                        <button class="btn-secondary-glass" onclick="openModal('modalHours')">Modifier</button>
                    </div>
                    <div id="hoursText" class="text-gray-900 mt-1">{{ pro.extra.working_hours.start }} - {{
                        pro.extra.working_hours.end }}</div>


                </div>
                <div class="md:col-span-2 p-4 rounded-xl border bg-white/50">
                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="share-2"
                                class="w-4 h-4"></i> Réseaux sociaux</div>
                        <button class="btn-secondary-glass" onclick="openModal('modalSocials')">Modifier</button>
                    </div>
                    <div class="text-gray-900 mt-1 space-y-1">
                        <div class="flex items-center gap-2"><i data-lucide="instagram"
                                class="w-4 h-4 text-pink-600"></i> Instagram : <a class="text-blue-600"
                                href="{{ pro.extra.social_instagram }}" target="_blank">
                                {{ pro.extra.social_instagram|default:'—' }}</a></div>
                        <div class="flex items-center gap-2"><i data-lucide="facebook"
                                class="w-4 h-4 text-blue-600"></i> Facebook : <a class="text-blue-600"
                                href="{{ pro.extra.social_facebook }}" target="_blank">
                                {{ pro.extra.social_facebook|default:'—' }}</a></div>
                        <div class="flex items-center gap-2"><i data-lucide="music-2" class="w-4 h-4 text-gray-700"></i>
                            TikTok : <a class="text-blue-600" href="{{ pro.extra.social_tiktok }}" target="_blank">
                                {{pro.extra.social_tiktok|default:'—' }}</a></div>
                    </div>
                </div>
                <div class="md:col-span-2 p-4 rounded-xl border bg-white/50">
                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="sparkles"
                                class="w-4 h-4"></i> Services proposés</div>
                        <button class="btn-secondary-glass" onclick="openModal('modalServices')">Modifier</button>
                    </div>
                    <div class="mt-2 grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
                        {% for s in pro.extra.services %}
                        <div class="p-3 rounded-lg border bg-white/60 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i data-lucide="scissors" class="w-4 h-4 text-pink-600"></i>
                                <div>
                                    <div class="font-medium">{{ s.name }}</div>
                                    <div class="text-xs text-gray-500">Durée : {{ s.duration_min }} min</div>
                                </div>
                            </div>
                            <div class="text-pink-600 font-semibold">{{ s.price }} DT</div>
                        </div>
                        {% empty %}
                        <div class="text-gray-500">—</div>
                        {% endfor %}
                    </div>
                </div>
                <div class="md:col-span-2 p-4 rounded-xl border bg-white/50">
                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="images"
                                class="w-4 h-4"></i> Galerie</div>
                        <button class="btn-secondary-glass" onclick="openModal('modalGallery')">Ajouter</button>
                    </div>
                    <div class="mt-2 flex flex-wrap gap-3">
                        {% for g in pro.extra.gallery %}
                        <img src="{{ g }}" class="w-24 h-24 object-cover rounded-lg border" />
                        {% empty %}
                        <div class="text-gray-500">—</div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="glass p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-3">Actions rapides</h2>
            <div class="flex flex-col gap-2">
                <button class="btn-glass">Envoyer une invitation</button>
                <button class="btn-secondary-glass">Désactiver le profil</button>
                <button class="btn-secondary-glass text-red-700">Supprimer</button>
            </div>
        </div>
    </div>



    <!-- Modals -->
    <div id="modalBio" class="hidden fixed inset-0 bg-black/40 z-50 items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg">
            <h3 class="text-lg font-semibold mb-3">Modifier la biographie</h3>
            <textarea id="inputBio" rows="5" class="w-full border rounded-xl p-3" placeholder="Biographie"></textarea>
            <div class="mt-4 flex justify-end gap-2">
                <button class="btn-secondary-glass" onclick="closeModal('modalBio')">Annuler</button>
                <button class="btn-glass"
                    onclick="saveExtras({bio: document.getElementById('inputBio').value})">Enregistrer</button>
            </div>
        </div>
    </div>
    <div id="modalHours" class="hidden fixed inset-0 bg-black/40 z-50 items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg">
            <h3 class="text-lg font-semibold mb-3">Modifier les horaires</h3>
            <div class="grid grid-cols-2 gap-3">
                <input id="inputStart" class="border rounded-xl p-3" placeholder="Début (HH:MM)" />
                <input id="inputEnd" class="border rounded-xl p-3" placeholder="Fin (HH:MM)" />
            </div>
            <div class="mt-4 flex justify-end gap-2">
                <button class="btn-secondary-glass" onclick="closeModal('modalHours')">Annuler</button>
                <button class="btn-glass"
                    onclick="saveExtras({working_hours: {start: document.getElementById('inputStart').value, end: document.getElementById('inputEnd').value}})">Enregistrer</button>
            </div>
        </div>
    </div>
    <div id="modalSocials" class="hidden fixed inset-0 bg-black/40 z-50 items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg">
            <h3 class="text-lg font-semibold mb-3">Modifier les réseaux sociaux</h3>
            <input id="inputIG" class="border rounded-xl p-3 mb-2 w-full" placeholder="Instagram (https://...)" />
            <input id="inputFB" class="border rounded-xl p-3 mb-2 w-full" placeholder="Facebook (https://...)" />
            <input id="inputTT" class="border rounded-xl p-3 mb-2 w-full" placeholder="TikTok (https://...)" />
            <div class="mt-2 flex justify-end gap-2">
                <button class="btn-secondary-glass" onclick="closeModal('modalSocials')">Annuler</button>
                <button class="btn-glass"
                    onclick="saveExtras({social_instagram: document.getElementById('inputIG').value, social_facebook: document.getElementById('inputFB').value, social_tiktok: document.getElementById('inputTT').value})">Enregistrer</button>
            </div>
        </div>
    </div>
    <div id="modalServices" class="hidden fixed inset-0 bg-black/40 z-50 items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-full max-w-2xl">
            <h3 class="text-lg font-semibold mb-3">Modifier les services</h3>
            <textarea id="inputServices" rows="6" class="w-full border rounded-xl p-3"
                placeholder="JSON ex: [{&quot;name&quot;:&quot;Soin&quot;,&quot;duration_min&quot;:45,&quot;price&quot;:80}]"></textarea>
            <div class="mt-2 flex justify-end gap-2">
                <button class="btn-secondary-glass" onclick="closeModal('modalServices')">Annuler</button>
                <button class="btn-glass" onclick="saveServices()">Enregistrer</button>
            </div>
        </div>
    </div>
    <div id="modalGallery" class="hidden fixed inset-0 bg-black/40 z-50 items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg">
            <h3 class="text-lg font-semibold mb-3">Ajouter à la galerie</h3>
            <input id="inputGallery" type="file" multiple accept="image/*" class="block w-full text-sm" />
            <div class="mt-2 flex justify-end gap-2">
                <button class="btn-secondary-glass" onclick="closeModal('modalGallery')">Annuler</button>
                <button class="btn-glass" onclick="saveGallery()">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let chartReservations, chartServices, chartTrend, chartHourly, chartRevenue;

    function fmt(d) {
        return d.toISOString().slice(0, 10);
    }

    async function reloadAnalytics() {
        const f = document.getElementById('anFrom').value;
        const t = document.getElementById('anTo').value;
        const params = new URLSearchParams();
        params.set('pro_id', '{{ pro.id }}');
        if (f) params.set('from', f);
        if (t) params.set('to', t);
        const res = await fetch(`/api/appointments/analytics/overview/?${params.toString()}`);
        if (!res.ok) return;
        const data = await res.json();
        const labels = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
        const week = data.reservations_by_weekday || [0, 0, 0, 0, 0, 0, 0];
        const dist = data.services_distribution || [];

        // Trend chart
        const tLabels = (data.trend_daily || []).map(x => x.date);
        const tValues = (data.trend_daily || []).map(x => x.count);
        const ctxT = document.getElementById('chartTrend').getContext('2d');
        if (chartTrend) chartTrend.destroy();
        chartTrend = new Chart(ctxT, {
            type: 'line',
            data: { labels: tLabels, datasets: [{ data: tValues, borderColor: 'rgb(236,72,153)', backgroundColor: 'rgba(236,72,153,0.12)', tension: 0.35, fill: true }] },
            options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true } } }
        });

        // Services chart
        const ctx2 = document.getElementById('chartServices').getContext('2d');
        if (chartServices) chartServices.destroy();
        chartServices = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: dist.map(x => x.label), datasets: [{
                    data: dist.map(x => x.value), backgroundColor: [
                        'rgba(236,72,153,0.8)', 'rgba(108,169,224,0.8)', 'rgba(34,197,94,0.8)', 'rgba(251,146,60,0.8)', 'rgba(168,85,247,0.8)', 'rgba(14,165,233,0.8)', 'rgba(234,88,12,0.8)', 'rgba(34,197,94,0.5)'], borderWidth: 2
                }]
            },
            options: { plugins: { legend: { position: 'bottom' } } }
        });

        // Hourly distribution
        const ctxH = document.getElementById('chartHourly').getContext('2d');
        if (chartHourly) chartHourly.destroy();
        chartHourly = new Chart(ctxH, {
            type: 'bar',
            data: { labels: Array.from({ length: 24 }, (_, i) => (i < 10 ? ('0' + i) : i) + ':00'), datasets: [{ data: data.hourly_distribution || [], backgroundColor: 'rgba(108,169,224,0.6)' }] },
            options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });

        // Weekday reservations
        const ctx1 = document.getElementById('chartReservations').getContext('2d');
        if (chartReservations) chartReservations.destroy();
        chartReservations = new Chart(ctx1, {
            type: 'bar',
            data: { labels, datasets: [{ data: week, backgroundColor: 'rgba(236,72,153,0.6)' }] },
            options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });

        // Revenue daily
        const rLabels = (data.revenue_daily || []).map(x => x.date);
        const rValues = (data.revenue_daily || []).map(x => x.value);
        const ctxR = document.getElementById('chartRevenue').getContext('2d');
        if (chartRevenue) chartRevenue.destroy();
        chartRevenue = new Chart(ctxR, {
            type: 'line',
            data: { labels: rLabels, datasets: [{ data: rValues, borderColor: 'rgb(34,197,94)', backgroundColor: 'rgba(34,197,94,0.12)', tension: 0.35, fill: true }] },
            options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });

        // KPIs
        const sb = data.status_breakdown || {};
        document.getElementById('kpiPending').textContent = sb.pending ?? 0;
        document.getElementById('kpiConfirmed').textContent = sb.confirmed ?? 0;
        document.getElementById('kpiCancelled').textContent = sb.cancelled ?? 0;
        document.getElementById('kpiCompleted').textContent = sb.completed ?? 0;
    }

    function hourLabel(h) { return (h < 10 ? '0' + h : '' + h) + ':00'; }
    function statusColor(s) { if (s === 'confirmed') return 'bg-red-500'; if (s === 'pending') return 'bg-amber-400'; return 'bg-emerald-500'; }

    function renderTimeline(items) {
        const container = document.getElementById('scheduleGrid');

        // Clear container
        if (container) container.innerHTML = '';

        // Create time slots from 8:00 to 20:00
        const timeSlots = [];
        for (let h = 8; h <= 20; h++) {
            timeSlots.push({
                hour: h,
                start: `${h.toString().padStart(2, '0')}:00`,
                end: `${(h + 1).toString().padStart(2, '0')}:00`,
                hasAppointment: false,
                appointment: null
            });
        }

        // Map appointments to time slots
        items.forEach(appointment => {
            const startTime = new Date(appointment.start);
            const hour = startTime.getHours();
            if (hour >= 8 && hour <= 20) {
                const slotIndex = hour - 8;
                if (timeSlots[slotIndex]) {
                    timeSlots[slotIndex].hasAppointment = true;
                    timeSlots[slotIndex].appointment = appointment;
                }
            }
        });

        // Render time slots as ultra-compact cards
        if (container) {
            timeSlots.forEach((slot, index) => {
                const slotCard = document.createElement('div');
                slotCard.className = `schedule-card rounded-lg p-2 mb-1 animate-slide-up`;
                slotCard.style.animationDelay = `${index * 0.03}s`;

                if (slot.hasAppointment && slot.appointment) {
                    const appointment = slot.appointment;
                    const startTime = new Date(appointment.start);
                    const endTime = new Date(appointment.end);
                    const duration = Math.round((endTime - startTime) / (1000 * 60)); // duration in minutes

                    slotCard.className += ` ${appointment.status}`;
                    slotCard.innerHTML = `
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center">
                                <span class="status-indicator ${appointment.status}"></span>
                                <span class="time-slot text-white font-semibold text-xs">${slot.start} - ${slot.end}</span>
                            </div>
                            <div class="duration-badge px-1.5 py-0.5 rounded-full text-xs text-white font-medium">
                                ${duration}min
                            </div>
                        </div>
                        <div class="space-y-0.5">
                            <div class="service-name text-white text-xs">${appointment.service_name || 'Service'}</div>
                            <div class="client-name text-white/90 flex items-center gap-1 text-xs">
                                <i data-lucide="user" class="w-3 h-3"></i>
                                ${appointment.client_name || 'Client non spécifié'}
                            </div>
                            ${appointment.notes ? `<div class="text-xs text-white/80 mt-1 p-1.5 bg-white/10 rounded">
                                <i data-lucide="message-square" class="w-3 h-3 inline mr-1"></i>
                                ${appointment.notes}
                            </div>` : ''}
                        </div>
                        <div class="mt-1 flex items-center justify-between">
                            <div class="flex items-center gap-1">
                                <i data-lucide="calendar" class="w-3 h-3 text-white/70"></i>
                                <span class="text-xs text-white/70">${startTime.toLocaleDateString('fr-FR')}</span>
                            </div>
                            <div class="flex gap-1">
                                <button class="p-0.5 rounded bg-white/20 hover:bg-white/30 transition-colors" 
                                        onclick="editAppointment('${appointment.id}')" 
                                        title="Modifier">
                                    <i data-lucide="edit" class="w-3 h-3 text-white"></i>
                                </button>
                                <button class="p-0.5 rounded bg-white/20 hover:bg-white/30 transition-colors" 
                                        onclick="viewAppointment('${appointment.id}')" 
                                        title="Voir détails">
                                    <i data-lucide="eye" class="w-3 h-3 text-white"></i>
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    slotCard.className += ' available';
                    slotCard.innerHTML = `
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center">
                                <i data-lucide="clock" class="w-3 h-3 text-gray-500 mr-1"></i>
                                <span class="time-slot text-gray-700 font-semibold text-xs">${slot.start} - ${slot.end}</span>
                            </div>
                            <span class="text-xs text-gray-500 font-medium">Disponible</span>
                        </div>
                        <div class="text-center py-1">
                            <div class="text-gray-500 text-xs mb-1">Créneau libre</div>
                            <button class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-xs font-medium"
                                    onclick="bookSlot('${slot.start}', '${slot.end}')">
                                <i data-lucide="plus" class="w-3 h-3 inline mr-1"></i>
                                Réserver
                            </button>
                        </div>
                    `;
                }

                container.appendChild(slotCard);
            });

            // Add empty state if no appointments
            if (items.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'text-center py-6 animate-fade-in';
                emptyState.innerHTML = `
                    <div class="w-10 h-10 mx-auto mb-2 bg-gray-100 rounded-full flex items-center justify-center">
                        <i data-lucide="calendar-x" class="w-5 h-5 text-gray-400"></i>
                    </div>
                    <h3 class="text-sm font-semibold text-gray-700 mb-1">Aucun rendez-vous</h3>
                    <p class="text-gray-500 text-xs mb-2">Aucun rendez-vous n'est programmé pour cette date.</p>
                   
                `;
                container.appendChild(emptyState);
            }
        }
    }


    // Init defaults on load
    (function init() {
        const today = fmt(new Date());
        document.getElementById('dayPicker').value = today;
        const from = new Date(); from.setDate(from.getDate() - 6);
        document.getElementById('anFrom').value = fmt(from);
        document.getElementById('anTo').value = today;
        reloadAnalytics();
        reloadAgenda();
    })();

    function getCsrf() {
        const name = 'csrftoken=';
        const parts = document.cookie.split(';');
        for (let p of parts) { p = p.trim(); if (p.startsWith(name)) return p.substring(name.length); }
        return '';
    }
    function openModal(id) { const m = document.getElementById(id); m.classList.remove('hidden'); m.classList.add('flex'); }
    function closeModal(id) { const m = document.getElementById(id); m.classList.add('hidden'); m.classList.remove('flex'); }
    async function saveExtras(payload) {
        const res = await fetch("{% url 'adminpanel:api_save_pro_extras' pro.id %}", {
            method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrf() }, body: JSON.stringify(payload)
        });
        if (res.ok) { location.reload(); }
    }
    function saveServices() {
        try { const data = JSON.parse(document.getElementById('inputServices').value || '[]'); saveExtras({ services: data }); } catch (e) { alert('JSON invalide'); }
    }
    async function saveGallery() {
        const input = document.getElementById('inputGallery');
        const files = input.files; const list = [];
        for (const f of files) { const b64 = await toBase64(f); list.push(b64); }
        await saveExtras({ gallery: list });
    }
    function toBase64(file) { return new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file); }); }

    // Modern agenda utility functions
    function editAppointment(appointmentId) {
        // TODO: Implement edit appointment modal
        console.log('Edit appointment:', appointmentId);
        alert('Fonctionnalité de modification en cours de développement');
    }

    function viewAppointment(appointmentId) {
        // TODO: Implement view appointment details modal
        console.log('View appointment:', appointmentId);
        alert('Fonctionnalité de visualisation en cours de développement');
    }

    function bookSlot(startTime, endTime) {
        // TODO: Implement book slot functionality
        console.log('Book slot:', startTime, 'to', endTime);
        alert(`Réserver le créneau de ${startTime} à ${endTime}`);
    }

    function bookNewAppointment() {
        // TODO: Implement new appointment booking
        console.log('Book new appointment');
        alert('Fonctionnalité de réservation en cours de développement');
    }

    // Enhanced reload with loading state
    async function reloadAgenda() {
        const button = document.querySelector('button[onclick="reloadAgenda()"]');
        const originalText = button.innerHTML;

        // Show loading state
        button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Chargement...';
        button.disabled = true;

        try {
            const d = document.getElementById('dayPicker').value || fmt(new Date());
            const res = await fetch(`/api/appointments/agenda/day/?pro_id={{ pro.id }}&date=${d}`);
            if (!res.ok) throw new Error('Erreur de chargement');
            const data = await res.json();
            renderTimeline(data.results || []);
        } catch (error) {
            console.error('Error loading agenda:', error);
            // Show error state
            const container = document.getElementById('scheduleGrid');
            if (container) {
                container.innerHTML = `
                    <div class="text-center py-6 animate-fade-in">
                        <div class="w-10 h-10 mx-auto mb-2 bg-red-100 rounded-full flex items-center justify-center">
                            <i data-lucide="alert-circle" class="w-5 h-5 text-red-500"></i>
                        </div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-1">Erreur de chargement</h3>
                        <p class="text-gray-500 text-xs mb-2">Impossible de charger l'agenda pour cette date.</p>
                        <button class="px-3 py-1.5 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-xs font-medium"
                                onclick="reloadAgenda()">
                            <i data-lucide="refresh-cw" class="w-3 h-3 inline mr-1"></i>
                            Réessayer
                        </button>
                    </div>
                `;
            }
        } finally {
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }
</script>
{% endblock %}