{% extends 'front_web/base_client.html' %}
{% load static %}
{% block template_id %}front_web/client_calendar.html{% endblock %}

{% block title %}Mon Calendrier - Coucou Beauté{% endblock %}

{% block extra_css %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap');

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* ==========================
       COLOR PALETTE & VARIABLES
       ========================== */
    :root {
        --rose-pale: #FFE5F1;
        --rose-poudre: #F8BBD0;
        --lavande: #E8D5FF;
        --bleu-clair: #D6E9FF;
        --blanc-pur: #FFFFFF;
        --gris-doux: #F8F9FA;
        --texte-principal: #2D3748;
        --texte-secondaire: #718096;

        /* Status Colors */
        --confirmed-bg: #C6F6D5;
        --confirmed-dark: #48BB78;
        --pending-bg: #FAF089;
        --pending-dark: #ECC94B;
        --cancelled-bg: #FEB2B2;
        --cancelled-dark: #E53E3E;
    }

    /* ==========================
       BACKGROUND & LAYOUT
       ========================== */
    .calendar-page {
        min-height: 100vh;
        background: linear-gradient(135deg, #FFF0F8 0%, #F0F4FF 50%, #FFF8F0 100%);
        position: relative;
        overflow-x: hidden;
    }

    .calendar-page::before {
        content: '';
        position: fixed;
        top: -50%;
        right: -20%;
        width: 800px;
        height: 800px;
        background: radial-gradient(circle, rgba(255, 182, 193, 0.15) 0%, transparent 70%);
        border-radius: 50%;
        animation: float 20s ease-in-out infinite;
        pointer-events: none;
    }

    .calendar-page::after {
        content: '';
        position: fixed;
        bottom: -30%;
        left: -10%;
        width: 600px;
        height: 600px;
        background: radial-gradient(circle, rgba(200, 181, 255, 0.15) 0%, transparent 70%);
        border-radius: 50%;
        animation: float 25s ease-in-out infinite reverse;
        pointer-events: none;
    }

    @keyframes float {

        0%,
        100% {
            transform: translate(0, 0) rotate(0deg);
        }

        33% {
            transform: translate(30px, -30px) rotate(120deg);
        }

        66% {
            transform: translate(-20px, 20px) rotate(240deg);
        }
    }

    /* ==========================
       HEADER SECTION
       ========================== */
    .page-header {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 28px;
        padding: 2rem 2.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.8);
        animation: fadeInDown 0.6s ease-out;
    }

    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .page-title {
        font-family: 'Poppins', sans-serif;
        font-size: 2.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, #FF8DC7 0%, #B794F6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0;
        line-height: 1.2;
    }

    .page-subtitle {
        color: var(--texte-secondaire);
        font-size: 1.1rem;
        font-weight: 400;
        margin-top: 0.5rem;
    }

    /* ==========================
       CALENDAR CONTAINER
       ========================== */
    .calendar-container {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.95) 100%);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 24px;
        padding: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.8);
        animation: fadeInUp 0.6s ease-out 0.2s both;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .calendar-nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
    }

    .calendar-nav-btn {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        border: 2px solid rgba(255, 182, 217, 0.3);
        background: rgba(255, 255, 255, 0.9);
        color: var(--texte-principal);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .calendar-nav-btn:hover {
        background: linear-gradient(135deg, #FFB6D9 0%, #C9B8FF 100%);
        border-color: transparent;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 182, 217, 0.3);
    }

    .calendar-month {
        font-family: 'Poppins', sans-serif;
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--texte-principal);
    }

    /* ==========================
       CALENDAR GRID
       ========================== */
    .calendar-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .calendar-day-header {
        text-align: center;
        font-weight: 600;
        color: var(--texte-secondaire);
        padding: 0.75rem 0.5rem;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
    }

    .calendar-day {
        aspect-ratio: 1;
        min-height: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        padding: 0.5rem 0.25rem;
        background: rgba(248, 250, 252, 0.5);
        border: 2px solid transparent;
    }

    .calendar-day:hover {
        background: rgba(255, 182, 217, 0.1);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .calendar-day.other-month {
        opacity: 0.4;
        color: var(--texte-secondaire);
    }

    .calendar-day.today {
        background: linear-gradient(135deg, #FFB6D9 0%, #C9B8FF 100%);
        color: white;
        font-weight: 700;
        border-color: transparent;
        box-shadow: 0 4px 16px rgba(255, 182, 217, 0.3);
    }

    .calendar-day.selected {
        background: linear-gradient(135deg, #FFB6D9 0%, #C9B8FF 100%);
        color: white;
        font-weight: 700;
        border: 3px solid rgba(255, 255, 255, 0.8);
        box-shadow: 0 8px 24px rgba(255, 182, 217, 0.4);
        transform: scale(1.05);
    }

    .day-number {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .appointment-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        justify-content: center;
        width: 100%;
        margin-top: auto;
    }

    .appointment-badge {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .appointment-badge.confirmed {
        background: var(--confirmed-dark);
        box-shadow: 0 0 0 2px var(--confirmed-bg);
    }

    .appointment-badge.pending {
        background: var(--pending-dark);
        box-shadow: 0 0 0 2px var(--pending-bg);
    }

    .appointment-badge.cancelled {
        background: var(--cancelled-dark);
        box-shadow: 0 0 0 2px var(--cancelled-bg);
    }

    .calendar-day.today .appointment-badge,
    .calendar-day.selected .appointment-badge {
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.8);
    }

    /* ==========================
       DAY POPOVER (TOOLTIP)
       ========================== */
    .day-popover {
        position: absolute;
        bottom: calc(100% + 8px);
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.95));
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 16px;
        padding: 1rem;
        min-width: 220px;
        max-width: 280px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.8);
        z-index: 50;
        display: none;
        pointer-events: none;
        animation: popoverFadeIn 0.3s ease-out;
    }

    @keyframes popoverFadeIn {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }

    .calendar-day:hover .day-popover {
        display: block;
    }

    .popover-title {
        font-family: 'Poppins', sans-serif;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--texte-principal);
        margin-bottom: 0.75rem;
        text-align: center;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    }

    .popover-appointments {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .popover-appointment {
        padding: 0.5rem;
        border-radius: 8px;
        font-size: 0.75rem;
    }

    .popover-appointment.confirmed {
        background: rgba(72, 187, 120, 0.1);
        border-left: 3px solid var(--confirmed-dark);
    }

    .popover-appointment.pending {
        background: rgba(236, 201, 75, 0.1);
        border-left: 3px solid var(--pending-dark);
    }

    .popover-appointment.cancelled {
        background: rgba(229, 62, 62, 0.1);
        border-left: 3px solid var(--cancelled-dark);
    }

    .popover-time {
        font-weight: 600;
        color: var(--texte-principal);
        margin-bottom: 0.25rem;
    }

    .popover-service {
        color: var(--texte-secondaire);
        font-size: 0.6875rem;
    }

    /* ==========================
       STATS PANEL
       ========================== */
    .stats-panel {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.95));
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 24px;
        padding: 1.5rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.8);
        margin-bottom: 1.5rem;
    }

    .stats-title {
        font-family: 'Poppins', sans-serif;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--texte-principal);
        margin-bottom: 1.25rem;
    }

    .stat-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .stat-item:last-child {
        border-bottom: none;
    }

    .stat-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--texte-secondaire);
        font-size: 0.9rem;
    }

    .stat-value {
        font-weight: 700;
        font-size: 1.1rem;
    }

    .stat-value.confirmed {
        color: var(--confirmed-dark);
    }

    .stat-value.pending {
        color: var(--pending-dark);
    }

    .stat-value.total {
        color: #2563EB;
    }

    /* ==========================
       DAY APPOINTMENTS PANEL
       ========================== */
    .day-appointments-panel {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.95));
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 24px;
        padding: 1.5rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.8);
        min-height: 300px;
    }

    .day-appointments-title {
        font-family: 'Poppins', sans-serif;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--texte-principal);
        margin-bottom: 1.25rem;
    }

    .appointment-card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 16px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        border: 2px solid transparent;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .appointment-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        border-color: rgba(255, 182, 217, 0.5);
    }

    .appointment-card.confirmed {
        border-left: 4px solid var(--confirmed-dark);
    }

    .appointment-card.pending {
        border-left: 4px solid var(--pending-dark);
    }

    .appointment-card.cancelled {
        border-left: 4px solid var(--cancelled-dark);
        opacity: 0.7;
    }

    .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .card-time {
        font-weight: 700;
        font-size: 1rem;
        color: var(--texte-principal);
    }

    .card-status {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .card-status.confirmed {
        background: var(--confirmed-bg);
        color: var(--confirmed-dark);
    }

    .card-status.pending {
        background: var(--pending-bg);
        color: var(--pending-dark);
    }

    .card-status.cancelled {
        background: var(--cancelled-bg);
        color: var(--cancelled-dark);
    }

    .card-service {
        font-weight: 600;
        color: var(--texte-principal);
        margin-bottom: 0.25rem;
    }

    .card-professional {
        font-size: 0.875rem;
        color: var(--texte-secondaire);
        margin-bottom: 0.25rem;
    }

    .card-price {
        font-weight: 700;
        color: #FF8DC7;
        margin-top: 0.5rem;
    }

    /* ==========================
       DETAIL MODAL
       ========================== */
    .detail-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .detail-modal.active {
        display: flex;
    }

    .detail-panel {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.95));
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 28px;
        padding: 2.5rem;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.8);
        animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .close-btn {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        width: 40px;
        height: 40px;
        border-radius: 12px;
        border: none;
        background: rgba(0, 0, 0, 0.05);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .close-btn:hover {
        background: rgba(0, 0, 0, 0.1);
        transform: rotate(90deg);
    }

    .detail-section {
        margin-bottom: 2rem;
    }

    .detail-section-title {
        font-family: 'Poppins', sans-serif;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--texte-principal);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* ==========================
       MOBILE LIST VIEW
       ========================== */
    .mobile-list-view {
        display: none;
        flex-direction: column;
        gap: 1rem;
    }

    .mobile-day-section {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.95));
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 1.25rem;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.8);
    }

    .mobile-day-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid rgba(255, 182, 217, 0.3);
    }

    .mobile-day-date {
        font-family: 'Poppins', sans-serif;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--texte-principal);
    }

    .mobile-day-count {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        background: linear-gradient(135deg, #FFB6D9 0%, #C9B8FF 100%);
        color: white;
    }

    /* ==========================
       RESPONSIVE MOBILE
       ========================== */
    @media (max-width: 768px) {
        .page-header {
            padding: 1.5rem;
            border-radius: 20px;
        }

        .page-title {
            font-size: 1.75rem;
        }

        .page-subtitle {
            font-size: 1rem;
        }

        .calendar-container {
            padding: 1rem;
            border-radius: 20px;
        }

        .calendar-nav {
            margin-bottom: 1rem;
        }

        .calendar-month {
            font-size: 1.125rem;
        }

        .calendar-day-header {
            font-size: 0.6875rem;
            padding: 0.5rem 0.25rem;
        }

        .calendar-day {
            min-height: 48px;
            padding: 0.375rem 0.125rem;
        }

        .day-number {
            font-size: 0.875rem;
        }

        .appointment-badge {
            width: 5px;
            height: 5px;
        }

        .day-popover {
            display: none !important;
        }

        .calendar-grid {
            display: none;
        }

        .calendar-header {
            display: none;
        }

        .mobile-list-view {
            display: flex;
        }

        .stats-panel,
        .day-appointments-panel {
            padding: 1rem;
            border-radius: 20px;
        }

        .detail-panel {
            padding: 1.5rem;
            border-radius: 20px;
            max-height: 95vh;
        }
    }

    @media (max-width: 480px) {
        .page-title {
            font-size: 1.5rem;
        }

        .calendar-day {
            min-height: 40px;
        }

        .day-number {
            font-size: 0.8125rem;
        }

        .appointment-badge {
            width: 4px;
            height: 4px;
        }
    }

    /* ==========================
       SWIPE GESTURES (MOBILE)
       ========================== */
    @media (hover: none) and (pointer: coarse) {
        .calendar-container {
            touch-action: pan-x;
            -webkit-overflow-scrolling: touch;
        }
    }

    /* ==========================
       ACCESSIBILITY
       ========================== */
    @media (prefers-reduced-motion: reduce) {

        *,
        *::before,
        *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }

    button:focus-visible,
    .calendar-day:focus-visible {
        outline: 2px solid #FFB6D9;
        outline-offset: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="calendar-page">
    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 py-8">
        <!-- Page Header -->
        <div class="page-header">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="page-title">Mon Calendrier</h1>
                    <p class="page-subtitle">Visualisez et gérez vos rendez-vous de beauté</p>
                </div>
                <a href="{% url 'front_web:client_dashboard' %}"
                    class="px-4 py-2 rounded-xl bg-white/80 hover:bg-white border border-pink-200 text-gray-700 hover:text-pink-600 transition-all flex items-center gap-2">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    Retour
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Calendrier principal -->
            <div class="lg:col-span-2">
                <div class="calendar-container">
                    <!-- Navigation -->
                    <div class="calendar-nav">
                        <button id="prevMonth" class="calendar-nav-btn">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <h2 id="currentMonth" class="calendar-month">Janvier 2024</h2>
                        <button id="nextMonth" class="calendar-nav-btn">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- En-têtes des jours (Desktop) -->
                    <div class="calendar-header">
                        <div class="calendar-day-header">Lun</div>
                        <div class="calendar-day-header">Mar</div>
                        <div class="calendar-day-header">Mer</div>
                        <div class="calendar-day-header">Jeu</div>
                        <div class="calendar-day-header">Ven</div>
                        <div class="calendar-day-header">Sam</div>
                        <div class="calendar-day-header">Dim</div>
                    </div>

                    <!-- Grille du calendrier (Desktop) -->
                    <div id="calendarGrid" class="calendar-grid"></div>

                    <!-- Vue liste mobile -->
                    <div id="mobileListView" class="mobile-list-view"></div>
                </div>
            </div>

            <!-- Panneau latéral -->
            <div class="space-y-6">
                <!-- Statistiques -->
                <div class="stats-panel">
                    <h3 class="stats-title">Mes statistiques</h3>
                    <div class="space-y-2">
                        <div class="stat-item">
                            <div class="stat-label">
                                <i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>
                                <span>RDV confirmés</span>
                            </div>
                            <span class="stat-value confirmed">{{ total_confirmed }}</span>
                        </div>
                        {% if total_pending > 0 %}
                        <div class="stat-item">
                            <div class="stat-label">
                                <i data-lucide="clock" class="w-5 h-5 text-yellow-500"></i>
                                <span>En attente</span>
                            </div>
                            <span class="stat-value pending">{{ total_pending }}</span>
                        </div>
                        {% endif %}
                        <div class="stat-item">
                            <div class="stat-label">
                                <i data-lucide="banknote" class="w-5 h-5 text-blue-500"></i>
                                <span>Total dépensé</span>
                            </div>
                            <span class="stat-value total">{{ total_spent }} DT</span>
                        </div>
                    </div>
                </div>

                <!-- Rendez-vous du jour sélectionné -->
                <div class="day-appointments-panel">
                    <h3 class="day-appointments-title">Rendez-vous du jour</h3>
                    <div id="dayAppointments">
                        <div class="text-center py-8 text-gray-500">
                            <i data-lucide="calendar" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                            <p>Sélectionnez un jour pour voir les rendez-vous</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="detail-modal" id="detailModal">
        <div class="detail-panel" id="detailPanel">
            <button class="close-btn" id="closeModalBtn">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Appointments Data (JSON) -->
    <script type="application/json" id="appointments-data">
    [
        {% for appointment in appointments %}
        {
            "id": {{ appointment.id }},
            "date": "{{ appointment.start|date:'Y-m-d' }}",
            "time": "{{ appointment.start|date:'H:i' }}",
            "endTime": "{{ appointment.end|date:'H:i' }}",
            "professional": "{{ appointment.professional_name|escapejs }}",
            "service": "{{ appointment.title|escapejs }}",
            "price": {{ appointment.price|floatformat:0 }},
            "status": "{{ appointment.status }}",
            "center_name": "{{ appointment.center_name|escapejs }}",
            "professional_email": "{{ appointment.professional_email|default:''|escapejs }}",
            "professional_phone": "{{ appointment.professional_phone|default:''|escapejs }}",
            "professional_address": "{{ appointment.professional_address|default:''|escapejs }}",
            "map_url": "{{ appointment.map_url|default:''|escapejs }}",
            "profile_url": "{{ appointment.profile_url|default:''|escapejs }}",
            "notes": "{{ appointment.notes|escapejs }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
    </script>
</div>

<script src="https://unpkg.com/lucide@latest"></script>
<script>
    // Initialize Lucide icons
    if (window.lucide) {
        window.lucide.createIcons();
    }

    // Données des rendez-vous depuis Django
    let appointmentsList = [];
    try {
        const appointmentsData = document.getElementById('appointments-data');
        if (appointmentsData && appointmentsData.textContent && appointmentsData.textContent.trim()) {
            const rawData = appointmentsData.textContent.trim();
            appointmentsList = JSON.parse(rawData);
            console.log('Appointments loaded:', appointmentsList.length, appointmentsList);
        } else {
            console.warn('No appointments data found or empty');
        }
    } catch (e) {
        console.error('Error parsing appointments data:', e, appointmentsData?.textContent);
    }

    // Index par date -> tableau de rendez-vous
    const appointmentsByDate = {};
    appointmentsList.forEach(a => {
        // Normaliser la date (s'assurer qu'elle est au format YYYY-MM-DD)
        const dateStr = a.date || '';
        if (dateStr) {
            // Si la date contient un T (format ISO), extraire uniquement la partie date
            const normalizedDate = dateStr.split('T')[0].split(' ')[0]; // Gérer aussi les espaces
            if (normalizedDate && normalizedDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                if (!appointmentsByDate[normalizedDate]) {
                    appointmentsByDate[normalizedDate] = [];
                }
                // Normaliser aussi la date dans l'objet
                a.date = normalizedDate;
                appointmentsByDate[normalizedDate].push(a);
            } else {
                console.warn('Invalid date format:', dateStr, 'for appointment:', a.id);
            }
        } else {
            console.warn('Missing date for appointment:', a.id);
        }
    });

    console.log('Appointments by date:', appointmentsByDate);
    console.log('Available dates:', Object.keys(appointmentsByDate).sort());

    let currentDate = new Date();
    let selectedDate = new Date().toISOString().split('T')[0];

    // Status colors mapping
    const statusColors = {
        'confirmed': { bg: 'var(--confirmed-bg)', dark: 'var(--confirmed-dark)' },
        'pending': { bg: 'var(--pending-bg)', dark: 'var(--pending-dark)' },
        'cancelled': { bg: 'var(--cancelled-bg)', dark: 'var(--cancelled-dark)' }
    };

    function initCalendar() {
        updateCalendar();
        setupEventListeners();
        updateDaySelection(); // Mettre à jour la sélection visuelle
        updateDayAppointments(selectedDate); // Afficher les rendez-vous du jour sélectionné
        if (window.innerWidth <= 768) {
            updateMobileListView();
        }
    }

    function updateCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
        document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;

        const firstDay = new Date(year, month, 1);
        const startDate = new Date(firstDay);

        // Ajuster pour commencer le lundi
        const firstDayWeekday = firstDay.getDay();
        const daysToSubtract = firstDayWeekday === 0 ? 6 : firstDayWeekday - 1;
        startDate.setDate(startDate.getDate() - daysToSubtract);

        const calendarGrid = document.getElementById('calendarGrid');
        if (calendarGrid) {
            calendarGrid.innerHTML = '';

            // Générer 42 cases (6 semaines)
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                const dateString = date.toISOString().split('T')[0]; // Définir la date string en premier

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.dataset.date = dateString; // Stocker la date complète

                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = date.getDate();
                dayElement.appendChild(dayNumber);

                // Vérifier si c'est aujourd'hui
                const today = new Date();
                if (date.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }

                // Vérifier si c'est le mois courant
                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }

                // Vérifier s'il y a des rendez-vous (normaliser la date pour la recherche)
                const normalizedDateStr = dateString.split('T')[0];
                const dayAppointments = appointmentsByDate[normalizedDateStr] || [];
                if (dayAppointments.length > 0 && date.getMonth() === month) {
                    dayElement.classList.add('has-appointment');

                    // Si c'est aujourd'hui, garder le style today mais ajouter une bordure pour les rendez-vous
                    if (!dayElement.classList.contains('today')) {
                        dayElement.style.background = 'rgba(255, 182, 217, 0.15)';
                        dayElement.style.border = '2px solid rgba(255, 182, 217, 0.4)';
                    } else {
                        dayElement.style.border = '3px solid rgba(255, 255, 255, 0.8)';
                    }

                    const badgesContainer = document.createElement('div');
                    badgesContainer.className = 'appointment-badges';

                    dayAppointments.forEach(apt => {
                        const badge = document.createElement('div');
                        badge.className = `appointment-badge ${apt.status}`;
                        badge.title = `${apt.status === 'confirmed' ? 'Confirmé' : apt.status === 'pending' ? 'En attente' : 'Annulé'}: ${apt.service || apt.title || 'Rendez-vous'}`;
                        badgesContainer.appendChild(badge);
                    });

                    dayElement.appendChild(badgesContainer);

                    // Créer le popover
                    const popover = document.createElement('div');
                    popover.className = 'day-popover';
                    popover.innerHTML = `
                        <div class="popover-title">${date.getDate()} ${monthNames[date.getMonth()]}</div>
                        <div class="popover-appointments">
                            ${dayAppointments.map(apt => `
                                <div class="popover-appointment ${apt.status}" data-appointment-id="${apt.id}">
                                    <div class="popover-time">${apt.time || ''}${apt.endTime ? ' - ' + apt.endTime : ''}</div>
                                    <div class="popover-service">${apt.service || apt.title || 'Service'}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    dayElement.appendChild(popover);

                    // Ajouter les event listeners au popover
                    popover.querySelectorAll('.popover-appointment').forEach(item => {
                        item.addEventListener('click', function (e) {
                            e.stopPropagation();
                            const appointmentId = parseInt(this.dataset.appointmentId);
                            const appointment = appointmentsList.find(a => a.id === appointmentId);
                            if (appointment) {
                                openDetailModal(appointment);
                            }
                        });
                    });
                }

                // Vérifier si c'est la date sélectionnée (normaliser pour la comparaison)
                // normalizedDateStr est déjà défini plus haut
                const normalizedSelectedDate = (selectedDate || '').split('T')[0];
                if (normalizedDateStr === normalizedSelectedDate) {
                    dayElement.classList.add('selected');
                }

                dayElement.addEventListener('click', () => {
                    selectedDate = normalizedDateStr; // Utiliser la date normalisée
                    updateDaySelection(); // Mettre à jour la sélection visuelle d'abord
                    updateDayAppointments(normalizedDateStr); // Puis mettre à jour les rendez-vous

                    // Animation de feedback
                    dayElement.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        dayElement.style.transform = '';
                    }, 150);
                });

                calendarGrid.appendChild(dayElement);
            }
        }

        // Mettre à jour la sélection après le rendu du calendrier
        updateDaySelection();
    }

    function updateMobileListView() {
        const mobileListView = document.getElementById('mobileListView');
        if (!mobileListView || window.innerWidth > 768) return;

        mobileListView.innerHTML = '';

        // Grouper les rendez-vous par date
        const sortedDates = Object.keys(appointmentsByDate).sort();

        sortedDates.forEach(dateStr => {
            const appointments = appointmentsByDate[dateStr];
            const date = new Date(dateStr);

            const daySection = document.createElement('div');
            daySection.className = 'mobile-day-section';

            const dayName = date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });

            daySection.innerHTML = `
                <div class="mobile-day-header">
                    <div class="mobile-day-date">${dayName.charAt(0).toUpperCase() + dayName.slice(1)}</div>
                    <div class="mobile-day-count">${appointments.length} RDV</div>
                </div>
                <div class="space-y-2">
                    ${appointments.map(apt => `
                        <div class="appointment-card ${apt.status}" data-appointment-id="${apt.id}">
                            <div class="card-header">
                                <span class="card-time">${apt.time}${apt.endTime ? ' - ' + apt.endTime : ''}</span>
                                <span class="card-status ${apt.status}">${apt.status === 'confirmed' ? 'Confirmé' : apt.status === 'pending' ? 'En attente' : 'Annulé'}</span>
                            </div>
                            <div class="card-service">${apt.service}</div>
                            <div class="card-professional">${apt.professional}</div>
                            <div class="card-price">${apt.price} DT</div>
                        </div>
                    `).join('')}
                </div>
            `;

            mobileListView.appendChild(daySection);
        });

        // Ajouter les event listeners pour les cards
        mobileListView.querySelectorAll('.appointment-card').forEach(card => {
            card.addEventListener('click', function () {
                const appointmentId = parseInt(this.dataset.appointmentId);
                const appointment = appointmentsList.find(a => a.id === appointmentId);
                if (appointment) {
                    openDetailModal(appointment);
                }
            });
        });
    }

    function updateDaySelection() {
        document.querySelectorAll('.calendar-day').forEach(day => {
            day.classList.remove('selected');
        });

        if (!selectedDate) return;

        const calendarGrid = document.getElementById('calendarGrid');
        if (!calendarGrid) return;

        const dayElements = calendarGrid.querySelectorAll('.calendar-day');

        dayElements.forEach(day => {
            const dayDateString = day.dataset.date;
            if (dayDateString === selectedDate) {
                day.classList.add('selected');
            }
        });
    }

    function updateDayAppointments(dateString) {
        const dayAppointments = document.getElementById('dayAppointments');
        const dayAppointmentsTitle = document.querySelector('.day-appointments-title');

        // Normaliser la date (s'assurer qu'elle est au format YYYY-MM-DD)
        const normalizedDate = dateString.split('T')[0];

        // Chercher les rendez-vous pour cette date
        const appointments = appointmentsByDate[normalizedDate] || [];

        console.log('Looking for appointments on:', normalizedDate);
        console.log('Found appointments:', appointments.length);
        console.log('Available dates:', Object.keys(appointmentsByDate));

        // Mettre à jour le titre avec la date sélectionnée
        if (dayAppointmentsTitle) {
            try {
                const date = new Date(normalizedDate + 'T00:00:00'); // Ajouter l'heure pour éviter les problèmes de timezone
                const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
                const dayName = date.toLocaleDateString('fr-FR', { weekday: 'long' });
                const formattedDate = `${dayName.charAt(0).toUpperCase() + dayName.slice(1)} ${date.getDate()} ${monthNames[date.getMonth()]}`;
                dayAppointmentsTitle.textContent = `Rendez-vous du ${formattedDate}`;
            } catch (e) {
                console.error('Error formatting date:', e);
                dayAppointmentsTitle.textContent = `Rendez-vous du jour`;
            }
        }

        if (appointments.length === 0) {
            dayAppointments.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i data-lucide="calendar" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                    <p>Aucun rendez-vous ce jour</p>
                </div>
            `;
        } else {
            dayAppointments.innerHTML = appointments.map(apt => `
                <div class="appointment-card ${apt.status}" data-appointment-id="${apt.id}">
                    <div class="card-header">
                        <span class="card-time">${apt.time || ''}${apt.endTime ? ' - ' + apt.endTime : ''}</span>
                        <span class="card-status ${apt.status}">${apt.status === 'confirmed' ? 'Confirmé' : apt.status === 'pending' ? 'En attente' : 'Annulé'}</span>
                    </div>
                    <div class="card-service">${apt.service || apt.title || 'Service'}</div>
                    <div class="card-professional">${apt.professional || apt.professional_name || 'Professionnel'}</div>
                    <div class="card-price">${apt.price || 0} DT</div>
                </div>
            `).join('');
        }

        // Ajouter les event listeners
        dayAppointments.querySelectorAll('.appointment-card').forEach(card => {
            card.addEventListener('click', function () {
                const appointmentId = parseInt(this.dataset.appointmentId);
                const appointment = appointmentsList.find(a => a.id === appointmentId);
                if (appointment) {
                    openDetailModal(appointment);
                }
            });
        });

        // Recréer les icônes Lucide
        if (window.lucide) {
            window.lucide.createIcons();
        }
    }

    function openDetailModal(appointment) {
        const modal = document.getElementById('detailModal');
        const modalContent = document.getElementById('modalContent');

        const statusConfig = {
            confirmed: { label: 'Confirmé', color: 'var(--confirmed-dark)', icon: 'check-circle' },
            pending: { label: 'En attente', color: 'var(--pending-dark)', icon: 'clock' },
            cancelled: { label: 'Annulé', color: 'var(--cancelled-dark)', icon: 'x-circle' }
        };

        const config = statusConfig[appointment.status] || statusConfig.pending;

        const serviceName = appointment.service || appointment.title || 'Service';
        const professionalName = appointment.professional || appointment.professional_name || 'Professionnel';
        const centerName = appointment.center_name || 'Centre';
        const appointmentDate = appointment.date || '';
        const appointmentTime = appointment.time || '';
        const appointmentEndTime = appointment.endTime || '';
        const appointmentPrice = appointment.price || 0;
        const appointmentNotes = appointment.notes || '';
        const professionalEmail = appointment.professional_email || '';
        const professionalPhone = appointment.professional_phone || '';
        const professionalAddress = appointment.professional_address || '';
        const mapUrl = appointment.map_url || '';
        const profileUrl = appointment.profile_url || '';

        // Parser la date correctement
        let dateObj;
        try {
            if (appointmentDate.includes('T')) {
                dateObj = new Date(appointmentDate);
            } else {
                dateObj = new Date(appointmentDate + 'T00:00:00');
            }
        } catch (e) {
            console.error('Error parsing date:', e, appointmentDate);
            dateObj = new Date();
        }

        modalContent.innerHTML = `
            <div class="detail-section">
                <h2 style="font-family: 'Poppins', sans-serif; font-size: 1.75rem; font-weight: 700; color: var(--texte-principal); margin-bottom: 1rem;">${serviceName}</h2>
                <span class="card-status ${appointment.status}" style="display: inline-block;">
                    <i data-lucide="${config.icon}" class="w-3 h-3"></i>
                    ${config.label}
                </span>
            </div>

            <div class="detail-section">
                <h3 class="detail-section-title">
                    <i data-lucide="calendar" class="w-5 h-5"></i>
                    Informations du rendez-vous
                </h3>
                <div class="stats-panel" style="margin-bottom: 0;">
                    <div class="stat-item">
                        <div class="stat-label">
                            <i data-lucide="calendar" class="w-5 h-5"></i>
                            <span>Date</span>
                        </div>
                        <span style="font-weight: 600;">${dateObj.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">
                            <i data-lucide="clock" class="w-5 h-5"></i>
                            <span>Heure</span>
                        </div>
                        <span style="font-weight: 600;">${appointmentTime}${appointmentEndTime ? ' - ' + appointmentEndTime : ''}</span>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">
                            <i data-lucide="banknote" class="w-5 h-5"></i>
                            <span>Prix</span>
                        </div>
                        <span style="font-weight: 700; color: #FF8DC7;">${appointmentPrice} DT</span>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">
                            <i data-lucide="building" class="w-5 h-5"></i>
                            <span>Centre</span>
                        </div>
                        <span style="font-weight: 600;">${centerName}</span>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">
                            <i data-lucide="user" class="w-5 h-5"></i>
                            <span>Professionnel</span>
                        </div>
                        <span style="font-weight: 600;">${professionalName}</span>
                    </div>
                    ${appointmentNotes ? `
                    <div class="stat-item">
                        <div class="stat-label">
                            <i data-lucide="message-circle" class="w-5 h-5"></i>
                            <span>Notes</span>
                        </div>
                        <span style="font-weight: 400; color: var(--texte-secondaire);">${appointmentNotes}</span>
                    </div>
                    ` : ''}
                </div>
            </div>

            ${professionalEmail || professionalPhone || professionalAddress || mapUrl || profileUrl ? `
            <div class="detail-section">
                <h3 class="detail-section-title">
                    <i data-lucide="store" class="w-5 h-5"></i>
                    Informations du salon
                </h3>
                <div class="stats-panel" style="margin-bottom: 0;">
                    ${professionalAddress ? `
                    <div class="stat-item">
                        <div class="stat-label">
                            <i data-lucide="map-pin" class="w-5 h-5"></i>
                            <span>Adresse</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                            <span style="font-weight: 600;">${professionalAddress}</span>
                            ${mapUrl ? `
                            <a href="${mapUrl}" target="_blank" rel="noopener noreferrer" 
                               style="display: inline-flex; align-items: center; gap: 0.25rem; color: #FF8DC7; text-decoration: none; font-size: 0.875rem; font-weight: 600;">
                                <i data-lucide="external-link" class="w-4 h-4"></i>
                                Google Maps
                            </a>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                    ${professionalPhone ? `
                    <div class="stat-item">
                        <div class="stat-label">
                            <i data-lucide="phone" class="w-5 h-5"></i>
                            <span>Téléphone</span>
                        </div>
                        <a href="tel:${professionalPhone}" style="font-weight: 600; color: #FF8DC7; text-decoration: none;">${professionalPhone}</a>
                    </div>
                    ` : ''}
                    ${professionalEmail ? `
                    <div class="stat-item">
                        <div class="stat-label">
                            <i data-lucide="mail" class="w-5 h-5"></i>
                            <span>Email</span>
                        </div>
                        <a href="mailto:${professionalEmail}" style="font-weight: 600; color: #FF8DC7; text-decoration: none;">${professionalEmail}</a>
                    </div>
                    ` : ''}
                    ${profileUrl ? `
                    <div class="stat-item" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(0,0,0,0.1);">
                        <a href="${profileUrl}" 
                           style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #FF8DC7 0%, #A8E6CF 100%); color: white; border-radius: 12px; text-decoration: none; font-weight: 600; transition: transform 0.2s, box-shadow 0.2s;"
                           onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(255,141,199,0.3)';"
                           onmouseout="this.style.transform=''; this.style.boxShadow='';">
                            <i data-lucide="user-circle" class="w-5 h-5"></i>
                            Voir le profil du salon
                        </a>
                    </div>
                    ` : ''}
                </div>
            </div>
            ` : ''}

            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <a href="{% url 'front_web:client_appointments' %}" 
                   class="flex-1 px-4 py-3 rounded-xl bg-gradient-to-r from-pink-400 to-blue-400 text-white font-semibold text-center hover:shadow-lg transition-all">
                    <i data-lucide="list" class="w-4 h-4 inline mr-2"></i>
                    Voir tous les RDV
                </a>
            </div>
        `;

        if (window.lucide) window.lucide.createIcons();
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeDetailModal() {
        const modal = document.getElementById('detailModal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }

    function setupEventListeners() {
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateCalendar();
            updateDaySelection(); // Mettre à jour la sélection après changement de mois
            // Si la date sélectionnée est toujours visible, mettre à jour les rendez-vous
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const selectedDateObj = new Date(selectedDate);
            if (selectedDateObj.getFullYear() === year && selectedDateObj.getMonth() === month) {
                updateDayAppointments(selectedDate);
            }
            if (window.innerWidth <= 768) {
                updateMobileListView();
            }
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateCalendar();
            updateDaySelection(); // Mettre à jour la sélection après changement de mois
            // Si la date sélectionnée est toujours visible, mettre à jour les rendez-vous
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const selectedDateObj = new Date(selectedDate);
            if (selectedDateObj.getFullYear() === year && selectedDateObj.getMonth() === month) {
                updateDayAppointments(selectedDate);
            }
            if (window.innerWidth <= 768) {
                updateMobileListView();
            }
        });

        // Close modal
        document.getElementById('closeModalBtn').addEventListener('click', closeDetailModal);
        document.getElementById('detailModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeDetailModal();
            }
        });
        document.getElementById('detailPanel').addEventListener('click', function (e) {
            e.stopPropagation();
        });

        // Escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeDetailModal();
            }
        });

        // Swipe gestures for mobile
        let touchStartX = 0;
        let touchEndX = 0;
        const calendarContainer = document.querySelector('.calendar-container');

        calendarContainer.addEventListener('touchstart', function (e) {
            touchStartX = e.changedTouches[0].screenX;
        });

        calendarContainer.addEventListener('touchend', function (e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            const swipeThreshold = 50;
            if (touchEndX < touchStartX - swipeThreshold) {
                // Swipe left - next month
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateCalendar();
                updateDaySelection();
                // Si la date sélectionnée est toujours visible, mettre à jour les rendez-vous
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const selectedDateObj = new Date(selectedDate);
                if (selectedDateObj.getFullYear() === year && selectedDateObj.getMonth() === month) {
                    updateDayAppointments(selectedDate);
                }
                if (window.innerWidth <= 768) {
                    updateMobileListView();
                }
            } else if (touchEndX > touchStartX + swipeThreshold) {
                // Swipe right - previous month
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateCalendar();
                updateDaySelection();
                // Si la date sélectionnée est toujours visible, mettre à jour les rendez-vous
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const selectedDateObj = new Date(selectedDate);
                if (selectedDateObj.getFullYear() === year && selectedDateObj.getMonth() === month) {
                    updateDayAppointments(selectedDate);
                }
                if (window.innerWidth <= 768) {
                    updateMobileListView();
                }
            }
        }

        // Responsive handling
        window.addEventListener('resize', function () {
            if (window.innerWidth <= 768) {
                updateMobileListView();
            }
        });
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
        initCalendar();
        if (window.lucide) {
            window.lucide.createIcons();
        }
    });
</script>
{% endblock %}