{% extends 'front_web/base_client.html' %}
{% load static %}

{% block title %}Mon Calendrier - Coucou Beauté{% endblock %}

{% block extra_css %}
<style>
    .calendar-container {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .calendar-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-bottom: 16px;
    }

    .calendar-day-header {
        text-align: center;
        font-weight: 600;
        color: #6B7280;
        padding: 12px 8px;
        font-size: 14px;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
    }

    .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        min-height: 48px;
    }

    .calendar-day:hover {
        background-color: #F3F4F6;
    }

    .calendar-day.today {
        background: linear-gradient(135deg, #F28BB2, #6CA9E0);
        color: white;
        font-weight: 600;
    }

    .calendar-day.has-appointment {
        background: linear-gradient(135deg, #fde68a 0%, #fca5a5 100%);
        border: 2px solid #f59e0b;
        color: #111827;
    }

    .calendar-day.has-appointment.today {
        background: linear-gradient(135deg, #F28BB2, #6CA9E0);
        border: 2px solid #F59E0B;
    }

    .appointment-dot {
        position: absolute;
        bottom: 4px;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        background-color: #F59E0B;
        border-radius: 50%;
    }

    .appointment-dot.today {
        background-color: white;
    }

    /* Popover for day details */
    .day-popover {
        position: absolute;
        top: -8px;
        left: 50%;
        transform: translate(-50%, -100%);
        pointer-events: none;
        background: #fff;
        border: 1px solid rgba(0, 0, 0, .08);
        border-radius: 10px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, .12);
        padding: 10px 12px;
        min-width: 180px;
        z-index: 30;
        display: none;
    }

    .calendar-day:hover .day-popover {
        display: block;
    }

    .appointment-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* ==========================
       RESPONSIVE MOBILE OPTIMIZATIONS
       ========================== */
    @media (max-width: 768px) {

        /* Mobile-friendly body */
        body {
            font-size: 16px !important;
            -webkit-text-size-adjust: 100%;
        }

        /* Page padding mobile */
        .p-6 {
            padding: 1rem !important;
        }

        /* Header mobile */
        h1.text-3xl {
            font-size: 1.5rem !important;
        }

        .text-gray-600 {
            font-size: 0.875rem !important;
        }

        .mb-8 {
            margin-bottom: 1.5rem !important;
        }

        /* Grid to single column */
        .grid.grid-cols-1.lg\\:grid-cols-3 {
            grid-template-columns: 1fr !important;
            gap: 1rem !important;
        }

        .lg\\:col-span-2 {
            grid-column: span 1 !important;
        }

        /* Calendar container mobile */
        .calendar-container {
            padding: 1rem !important;
            border-radius: 1rem !important;
        }

        /* Calendar navigation mobile */
        .flex.items-center.justify-between.mb-6 {
            margin-bottom: 1rem !important;
        }

        .flex.items-center.justify-between.mb-6 button {
            padding: 0.5rem !important;
            min-height: 44px;
            min-width: 44px;
        }

        h2#currentMonth {
            font-size: 1.125rem !important;
        }

        /* Calendar headers mobile */
        .calendar-header {
            gap: 4px !important;
            margin-bottom: 0.75rem !important;
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, #F28BB2, #6CA9E0) !important;
            color: white !important;
            font-weight: 600;
            border: 2px solid #F59E0B;
        }

        .calendar-day-header {
            font-size: 0.6875rem !important;
            padding: 0.5rem 0.25rem !important;
        }

        /* Calendar grid mobile */
        .calendar-grid {
            gap: 4px !important;
        }

        .calendar-day {
            min-height: 40px !important;
            font-size: 0.875rem !important;
            border-radius: 8px !important;
        }

        /* Appointment dot mobile */
        .appointment-dot {
            width: 4px !important;
            height: 4px !important;
            bottom: 2px !important;
        }

        /* Side panels mobile */
        .space-y-6>*+* {
            margin-top: 1rem !important;
        }

        .bg-white.rounded-xl {
            padding: 1rem !important;
        }

        h3.text-lg {
            font-size: 1rem !important;
            margin-bottom: 0.75rem !important;
        }

        /* Stats mobile */
        .space-y-4>*+* {
            margin-top: 0.75rem !important;
        }

        .space-y-4 .text-sm {
            font-size: 0.8125rem !important;
        }

        .space-y-4 [data-lucide] {
            width: 0.875rem !important;
            height: 0.875rem !important;
        }

        /* Day appointments mobile */
        #dayAppointments {
            font-size: 0.875rem !important;
        }

        #dayAppointments [data-lucide] {
            width: 2.5rem !important;
            height: 2.5rem !important;
        }

        #dayAppointments p {
            font-size: 0.8125rem !important;
        }

        /* Appointment card mobile */
        .appointment-card {
            padding: 0.75rem !important;
            margin-bottom: 0.5rem !important;
            border-radius: 0.75rem !important;
        }

        .appointment-card .font-semibold {
            font-size: 0.875rem !important;
        }

        .appointment-card .text-xs {
            font-size: 0.6875rem !important;
        }

        .appointment-card .text-sm {
            font-size: 0.75rem !important;
        }

        /* "Ce mois" section mobile */
        .space-y-3>*+* {
            margin-top: 0.5rem !important;
        }

        .space-y-3 .text-sm {
            font-size: 0.8125rem !important;
        }
    }

    /* Small mobile (iPhone SE) */
    @media (max-width: 375px) {
        h1.text-3xl {
            font-size: 1.25rem !important;
        }

        .calendar-container {
            padding: 0.75rem !important;
        }

        h2#currentMonth {
            font-size: 1rem !important;
        }

        .calendar-day-header {
            font-size: 0.625rem !important;
            padding: 0.375rem 0.125rem !important;
        }

        .calendar-day {
            min-height: 36px !important;
            font-size: 0.8125rem !important;
        }

        .calendar-grid {
            gap: 2px !important;
        }

        .bg-white.rounded-xl {
            padding: 0.75rem !important;
        }
    }

    /* Landscape mobile */
    @media (max-width: 768px) and (orientation: landscape) {
        .p-6 {
            padding: 0.75rem !important;
        }

        .grid.grid-cols-1.lg\\:grid-cols-3 {
            grid-template-columns: repeat(2, 1fr) !important;
        }

        .calendar-container {
            padding: 0.75rem !important;
        }

        .calendar-day {
            min-height: 36px !important;
        }
    }

    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {

        .calendar-day,
        button {
            -webkit-tap-highlight-color: rgba(242, 139, 178, 0.2);
            cursor: pointer;
        }

        * {
            -webkit-overflow-scrolling: touch;
        }

        .calendar-day:active {
            opacity: 0.8;
            transform: scale(0.95);
        }

        button:active {
            opacity: 0.8;
        }
    }

    /* iOS Safari fixes */
    @supports (-webkit-touch-callout: none) {

        input,
        select {
            font-size: max(16px, 1rem) !important;
        }

        .min-h-screen {
            min-height: -webkit-fill-available;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="p-6">
    <!-- En-tête de la page -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Mon Calendrier</h1>
        <p class="text-gray-600">Visualisez vos rendez-vous de beauté</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Calendrier principal -->
        <div class="lg:col-span-2">
            <div class="calendar-container">
                <!-- Navigation du calendrier -->
                <div class="flex items-center justify-between mb-6">
                    <button id="prevMonth" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    </button>
                    <h2 id="currentMonth" class="text-xl font-semibold text-gray-900">Janvier 2024</h2>
                    <button id="nextMonth" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- En-têtes des jours -->
                <div class="calendar-header">
                    <div class="calendar-day-header">Lun</div>
                    <div class="calendar-day-header">Mar</div>
                    <div class="calendar-day-header">Mer</div>
                    <div class="calendar-day-header">Jeu</div>
                    <div class="calendar-day-header">Ven</div>
                    <div class="calendar-day-header">Sam</div>
                    <div class="calendar-day-header">Dim</div>
                </div>

                <!-- Grille du calendrier -->
                <div id="calendarGrid" class="calendar-grid">
                    <!-- Les jours seront générés par JavaScript -->
                </div>
            </div>
        </div>

        <!-- Panneau latéral -->
        <div class="space-y-6">
            <!-- Statistiques -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Mes statistiques</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>
                            <span class="text-sm text-gray-600">RDV confirmés</span>
                        </div>
                        <span class="font-semibold text-green-600">{{ total_confirmed }}</span>
                    </div>
                    {% if total_pending > 0 %}
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <i data-lucide="clock" class="w-4 h-4 text-yellow-500"></i>
                            <span class="text-sm text-gray-600">En attente</span>
                        </div>
                        <span class="font-semibold text-yellow-600">{{ total_pending }}</span>
                    </div>
                    {% endif %}
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <i data-lucide="banknote" class="w-4 h-4 text-blue-500"></i>
                            <span class="text-sm text-gray-600">Total dépensé</span>
                        </div>
                        <span class="font-semibold text-blue-600">{{ total_spent }} DT</span>
                    </div>
                </div>
            </div>

            <!-- Rendez-vous du jour sélectionné -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Rendez-vous du jour</h3>
                <div id="dayAppointments">
                    <div class="text-center py-8 text-gray-500">
                        <i data-lucide="calendar" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                        <p>Sélectionnez un jour pour voir les rendez-vous</p>
                    </div>
                </div>
            </div>

            <!-- Actions rapides -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Ce mois</h3>
                <div class="space-y-3 text-sm text-gray-600">
                    <div class="flex justify-between items-center">
                        <span>Rendez-vous confirmés</span>
                        <span class="font-semibold text-gray-900">{{ total_confirmed }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Rendez-vous en attente</span>
                        <span class="font-semibold text-gray-900">{{ total_pending }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    // Données des rendez-vous depuis Django - CORRIGÉ
    const appointmentsList = [
        {% for appointment in appointments %}
        {
            id: {{ appointment.id }},
            date: '{{ appointment.start|date:"Y-m-d" }}',
            time: '{{ appointment.start|date:"H:i" }}',
            endTime: '{{ appointment.end|date:"H:i" }}',
            professional: '{{ appointment.professional_name|escapejs }}',
            service: '{{ appointment.title|escapejs }}',
            price: {{ appointment.price|floatformat:0 }},
            status: '{{ appointment.status }}',
            center_name: '{{ appointment.center_name|escapejs }}',
            notes: '{{ appointment.notes|escapejs }}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Index par date -> tableau de rendez-vous
    const appointmentsByDate = {};
    appointmentsList.forEach(a => {
        if (!appointmentsByDate[a.date]) appointmentsByDate[a.date] = [];
        appointmentsByDate[a.date].push(a);
    });

    let currentDate = new Date();
    let selectedDate = new Date().toISOString().split('T')[0]; // string au format YYYY-MM-DD

    function initCalendar() {
        updateCalendar();
        setupEventListeners();
        // Afficher les rendez-vous du jour actuel
        updateDayAppointments(selectedDate);
    }

    function updateCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
        document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;

        const firstDay = new Date(year, month, 1);
        const startDate = new Date(firstDay);

        // Ajuster pour commencer le lundi
        const firstDayWeekday = firstDay.getDay();
        const daysToSubtract = firstDayWeekday === 0 ? 6 : firstDayWeekday - 1;
        startDate.setDate(startDate.getDate() - daysToSubtract);

        const calendarGrid = document.getElementById('calendarGrid');
        calendarGrid.innerHTML = '';

        // Générer 42 cases (6 semaines)
        for (let i = 0; i < 42; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);

            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.textContent = date.getDate();

            // Vérifier si c'est aujourd'hui
            const today = new Date();
            if (date.toDateString() === today.toDateString()) {
                dayElement.classList.add('today');
            }

            // Vérifier si c'est le mois courant
            if (date.getMonth() !== month) {
                dayElement.classList.add('text-gray-400');
            } else {
                dayElement.classList.add('text-gray-800');
            }

            const dateString = date.toISOString().split('T')[0];

            // Vérifier s'il y a des rendez-vous
            if (appointmentsByDate[dateString] && date.getMonth() === month) {
                dayElement.classList.add('has-appointment');
                const dot = document.createElement('div');
                dot.className = 'appointment-dot';
                if (dayElement.classList.contains('today')) dot.classList.add('today');
                dayElement.appendChild(dot);
            }

            // Vérifier si c'est la date sélectionnée
            if (dateString === selectedDate) {
                dayElement.classList.add('selected');
            }

            dayElement.addEventListener('click', () => {
                selectedDate = dateString;
                updateDayAppointments(dateString);
                updateDaySelection();
            });

            calendarGrid.appendChild(dayElement);
        }
        
        updateDaySelection(); // Mettre à jour la sélection après le rendu
    }

    function updateDaySelection() {
        document.querySelectorAll('.calendar-day').forEach(day => {
            day.classList.remove('selected');
        });

        if (!selectedDate) return;

        const selectedDateObj = new Date(selectedDate);
        const dayElements = document.querySelectorAll('.calendar-day');
        
        dayElements.forEach(day => {
            const dayNumber = parseInt(day.textContent);
            const dayDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), dayNumber);
            
            // Vérifier si c'est un jour du mois précédent/suivant
            const isCurrentMonth = !day.classList.contains('text-gray-400');
            
            if (isCurrentMonth && dayNumber === selectedDateObj.getDate() && 
                currentDate.getMonth() === selectedDateObj.getMonth() &&
                currentDate.getFullYear() === selectedDateObj.getFullYear()) {
                day.classList.add('selected');
            }
        });
    }

    function updateDayAppointments(dateString) {
        const dayAppointments = document.getElementById('dayAppointments');
        const appointments = appointmentsByDate[dateString] || [];

        if (appointments.length === 0) {
            dayAppointments.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i data-lucide="calendar" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                    <p>Aucun rendez-vous ce jour</p>
                </div>
            `;
        } else {
            dayAppointments.innerHTML = appointments.map(apt => `
                <div class="appointment-card">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-semibold text-gray-900">${apt.time}${apt.endTime ? ' - ' + apt.endTime : ''}</span>
                        <span class="px-2 py-1 text-xs rounded-full ${apt.status === 'confirmed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${apt.status === 'confirmed' ? 'Confirmé' : 'En attente'}
                        </span>
                    </div>
                    <h4 class="font-medium text-gray-900">${apt.professional}</h4>
                    <p class="text-sm text-gray-600">${apt.service}</p>
                    <p class="text-sm text-gray-700">${apt.center_name}</p>
                    <p class="text-sm text-rose-600 font-medium mt-1">${apt.price} DT</p>
                    ${apt.notes ? `<p class="mt-2 text-xs text-gray-500">${apt.notes}</p>` : ''}
                </div>
            `).join('');
        }

        // Recréer les icônes Lucide
        if (window.lucide) {
            lucide.createIcons();
        }
    }

    function setupEventListeners() {
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateCalendar();
        });
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
        initCalendar();
        if (window.lucide) {
            lucide.createIcons();
        }
    });
</script>


{% endblock %}