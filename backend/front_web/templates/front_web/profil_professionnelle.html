{% extends 'front_web/base_prof.html' %}
{% load static %}
{% block template_id %}front_web/profil_professionnelle.html{% endblock %}

{% block title %}Mon Profil - Coucou Beauté{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');

    body {
        font-family: 'Plus Jakarta Sans', sans-serif;
    }

    /* Modern glass card */
    .profile-card {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 1.5rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
    }

    .profile-card:hover {
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.12);
    }

    /* Input styling */
    .modern-input {
        background: rgba(255, 255, 255, 0.8);
        border: 2px solid #e5e7eb;
        border-radius: 1rem;
        padding: 0.875rem 1rem;
        font-size: 0.9375rem;
        transition: all 0.2s ease;
        width: 100%;
    }

    .modern-input:focus {
        outline: none;
        border-color: #ec4899;
        box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.1);
        background: white;
    }

    .modern-input.saving {
        border-color: #fbbf24;
        animation: pulse-border 1s infinite;
    }

    .modern-input.saved {
        border-color: #10b981;
    }

    .modern-input.changed {
        border-color: #f59e0b;
        box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.15);
        background: #fffbeb;
    }

    @keyframes pulse-border {

        0%,
        100% {
            border-color: #fbbf24;
        }

        50% {
            border-color: #f59e0b;
        }
    }

    /* Map styling */
    #profileMap {
        height: 300px;
        border-radius: 1rem;
        z-index: 1;
    }

    /* Service card */
    .service-card {
        background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
        border: 1px solid rgba(236, 72, 153, 0.2);
        border-radius: 1rem;
        padding: 1rem;
        transition: all 0.2s ease;
    }

    .service-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(236, 72, 153, 0.15);
    }

    /* Day pill */
    .day-pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid #e5e7eb;
        background: white;
    }

    .day-pill:hover {
        border-color: #ec4899;
    }

    .day-pill.active {
        background: linear-gradient(135deg, #ec4899 0%, #a855f7 100%);
        color: white;
        border-color: transparent;
    }

    /* Photo upload */
    .photo-upload {
        position: relative;
        width: 120px;
        height: 120px;
        border-radius: 1.5rem;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .photo-upload:hover .photo-overlay {
        opacity: 1;
    }

    .photo-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    /* Toast notification */
    .toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 1rem 1.5rem;
        border-radius: 1rem;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        font-weight: 500;
        box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 1000;
    }

    .toast.show {
        transform: translateY(0);
        opacity: 1;
    }

    /* Gallery */
    .gallery-item {
        position: relative;
        width: 100px;
        height: 100px;
        border-radius: 1rem;
        overflow: hidden;
    }

    .gallery-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .gallery-item .delete-btn {
        position: absolute;
        top: -0.5rem;
        right: -0.5rem;
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 9999px;
        background: #ef4444;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .gallery-item:hover .delete-btn {
        opacity: 1;
    }

    /* Section header */
    .section-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .section-icon {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .profile-card {
            border-radius: 1rem;
            padding: 1rem !important;
        }

        .modern-input {
            padding: 0.75rem;
            font-size: 16px !important;
        }

        #profileMap {
            height: 250px;
        }

        .photo-upload {
            width: 80px;
            height: 80px;
        }

        .gallery-item {
            width: 80px;
            height: 80px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto p-4 md:p-6 space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Mon Profil</h1>
            <p class="text-gray-500 mt-1">Les modifications sont sauvegardées automatiquement</p>
        </div>
        <a href="{% url 'front_web:pro_dashboard' %}" class="btn-secondary-glass flex items-center gap-2">
            <i data-lucide="arrow-left" class="w-4 h-4"></i>
            <span class="hidden md:inline">Retour au tableau de bord</span>
        </a>
    </div>

    <!-- Photo & Basic Info -->
    <div class="profile-card p-6">
        <div class="flex flex-col md:flex-row gap-6">
            <!-- Photo -->
            <div class="flex-shrink-0">
                <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                    <img id="profilePhoto"
                        src="{{ prefill.extra.profile_photo_url|default:'/static/images/placeholder-avatar.png' }}"
                        class="w-full h-full object-cover" alt="Photo de profil" />
                    <div class="photo-overlay">
                        <i data-lucide="camera" class="w-6 h-6 text-white"></i>
                    </div>
                </div>
                <input type="file" id="photoInput" accept="image/*" class="hidden" onchange="uploadPhoto(this)" />
            </div>

            <!-- Basic fields -->
            <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">Nom du centre / salon</label>
                    <input type="text" id="business_name" class="modern-input" placeholder="Mon salon beauté"
                        data-field="business_name" onchange="saveField(this)"
                        value="{% firstof prefill.extra.business_name prefill.application_hint.salon_name '' %}" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">Téléphone principal</label>
                    <input type="tel" id="phone" class="modern-input" placeholder="+216 XX XXX XXX"
                        data-field="phone_number" onchange="saveField(this)"
                        value="{% firstof prefill.extra.phone_number prefill.application_hint.phone_number '' %}" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">Téléphone secondaire <span
                            class="text-gray-400">(optionnel)</span></label>
                    <input type="tel" id="phone2" class="modern-input" placeholder="+216 XX XXX XXX"
                        data-field="phone_secondary" onchange="saveField(this)"
                        value="{{ prefill.extra.phone_secondary|default:'' }}" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">Email principal</label>
                    <input type="email" id="email" class="modern-input" data-field="email" onchange="saveField(this)"
                        value="{% firstof prefill.extra.email prefill.application_hint.email request.user.email %}" />
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-600 mb-2">Email secondaire <span
                            class="text-gray-400">(optionnel)</span></label>
                    <input type="email" id="email2" class="modern-input" placeholder="contact@monsalon.tn"
                        data-field="email_secondary" onchange="saveField(this)"
                        value="{{ prefill.extra.email_secondary|default:'' }}" />
                </div>
            </div>
        </div>
    </div>

    <!-- Location with Map -->
    <div class="profile-card p-6">
        <div class="section-header">
            <div class="section-icon bg-gradient-to-br from-blue-400 to-cyan-500 text-white">
                <i data-lucide="map-pin" class="w-5 h-5"></i>
            </div>
            <div>
                <h2 class="text-lg font-semibold text-gray-900">Localisation</h2>
                <p class="text-sm text-gray-500">Cliquez sur la carte pour définir votre position</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">Adresse</label>
                    <input type="text" id="address" class="modern-input" placeholder="123 Rue principale"
                        data-field="address" onchange="saveField(this)"
                        value="{% firstof prefill.extra.address prefill.application_hint.address '' %}" />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Gouvernorat</label>
                        <select id="governorate" class="modern-input" data-field="governorate"
                            onchange="saveField(this)">
                            <option value="">-- Sélectionner --</option>
                            <option value="Tunis" {% if prefill.extra.governorate == 'Tunis' %}selected{% endif %}>Tunis
                            </option>

                            <option value="Ariana" {% if prefill.extra.governorate == 'Ariana' %}selected{% endif %}>
                                Ariana</option>

                            <option value="Ben Arous" {% if prefill.extra.governorate == 'Ben Arous' %}selected{% endif%}>
                                Ben Arous</option>

                            <option value="Manouba" {% if prefill.extra.governorate == 'Manouba' %}selected{% endif %}>
                                Manouba</option>
                            <option value="Nabeul" {% if prefill.extra.governorate == 'Nabeul' %}selected{% endif %}>
                                Nabeul</option>
                            <option value="Zaghouan" {% if prefill.extra.governorate == 'Zaghouan' %}selected{% endif %}>
                                Zaghouan</option>
                            <option value="Bizerte" {% if prefill.extra.governorate == 'Bizerte' %}selected{% endif %}>
                                Bizerte</option>
                            <option value="Béja" {% if prefill.extra.governorate == 'Béja' %}selected{% endif %}>Béja
                            </option>
                            <option value="Jendouba" {% if prefill.extra.governorate == 'Jendouba' %}selected{% endif %}>
                                Jendouba</option>
                            <option value="Le Kef" {% if prefill.extra.governorate == 'Le Kef' %}selected{% endif %}>Le
                                Kef</option>
                            <option value="Siliana" {% if prefill.extra.governorate == 'Siliana' %}selected{% endif %}>
                                Siliana</option>
                            <option value="Sousse" {% if prefill.extra.governorate == 'Sousse' %}selected{% endif %}>
                                Sousse</option>
                            <option value="Monastir" {% if prefill.extra.governorate == 'Monastir' %}selected{% endif %}>
                                Monastir</option>
                            <option value="Mahdia" {% if prefill.extra.governorate == 'Mahdia' %}selected{% endif %}>
                                Mahdia</option>
                            <option value="Sfax" {% if prefill.extra.governorate == 'Sfax' %}selected{% endif %}>Sfax
                            </option>
                            <option value="Kairouan" {% if prefill.extra.governorate == 'Kairouan' %}selected{% endif %}>
                                Kairouan</option>
                            <option value="Kasserine" {% if prefill.extra.governorate == 'Kasserine' %}selected{% endif  %}>Kasserine</option>
                              

                            <option value="Sidi Bouzid" {% if prefill.extra.governorate == 'Sidi Bouzid' %}selected{%endif%}>Sidi Bouzid</option>
                                

                            <option value="Gabès" {% if prefill.extra.governorate == 'Gabès' %}selected{% endif %}>Gabès
                            </option>

                            <option value="Médenine" {% if prefill.extra.governorate == 'Médenine' %}selected{% endif %}>
                                Médenine</option>

                            <option value="Tataouine" {% if prefill.extra.governorate == 'Tataouine' %}selected{% endif%}>Tataouine</option>
                                

                            <option value="Gafsa" {% if prefill.extra.governorate == 'Gafsa' %}selected{% endif %}>Gafsa
                            </option>

                            <option value="Tozeur" {% if prefill.extra.governorate == 'Tozeur' %}selected{% endif %}>
                                Tozeur</option>
                            <option value="Kébili" {% if prefill.extra.governorate == 'Kébili' %}selected{% endif %}>

                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Ville</label>
                        <input type="text" id="city" class="modern-input" placeholder="Tunis" data-field="city"
                            onchange="saveField(this)" value="{{ prefill.extra.city|default:'' }}" />
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Latitude</label>
                        <input type="text" id="latitude" class="modern-input bg-gray-50" readonly
                            value="{{ prefill.extra.latitude|default:'' }}" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Longitude</label>
                        <input type="text" id="longitude" class="modern-input bg-gray-50" readonly
                            value="{{ prefill.extra.longitude|default:'' }}" />
                    </div>
                </div>
                <button onclick="locateMe()" class="btn-secondary-glass w-full flex items-center justify-center gap-2">
                    <i data-lucide="locate" class="w-4 h-4"></i> Utiliser ma position actuelle
                </button>
            </div>
            <div>
                <div id="profileMap" class="border border-gray-200"></div>
            </div>
        </div>
    </div>

    <!-- Bio -->
    <div class="profile-card p-6">
        <div class="section-header">
            <div class="section-icon bg-gradient-to-br from-purple-400 to-pink-500 text-white">
                <i data-lucide="user" class="w-5 h-5"></i>
            </div>
            <h2 class="text-lg font-semibold text-gray-900">Biographie</h2>
        </div>
        <textarea id="bio" class="modern-input min-h-[120px] resize-none"
            placeholder="Parlez de vous, votre expérience, vos spécialités..." data-field="bio"
            onchange="saveField(this)">{{ prefill.extra.bio|default:'' }}</textarea>
    </div>

    <!-- Working Hours -->
    <div class="profile-card p-6">
        <div class="section-header">
            <div class="section-icon bg-gradient-to-br from-amber-400 to-orange-500 text-white">
                <i data-lucide="clock" class="w-5 h-5"></i>
            </div>
            <h2 class="text-lg font-semibold text-gray-900">Horaires de travail</h2>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-600 mb-3">Jours de travail</label>
            <div class="flex flex-wrap gap-2" id="daysContainer">
                <span class="day-pill" data-day="mon" onclick="toggleDay(this)">Lun</span>
                <span class="day-pill" data-day="tue" onclick="toggleDay(this)">Mar</span>
                <span class="day-pill" data-day="wed" onclick="toggleDay(this)">Mer</span>
                <span class="day-pill" data-day="thu" onclick="toggleDay(this)">Jeu</span>
                <span class="day-pill" data-day="fri" onclick="toggleDay(this)">Ven</span>
                <span class="day-pill" data-day="sat" onclick="toggleDay(this)">Sam</span>
                <span class="day-pill" data-day="sun" onclick="toggleDay(this)">Dim</span>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-2">Heure d'ouverture</label>
                <input type="time" id="startTime" class="modern-input"
                    value="{{ prefill.extra.working_hours.start|default:'09:00' }}" onchange="saveWorkingHours()" />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-2">Heure de fermeture</label>
                <input type="time" id="endTime" class="modern-input"
                    value="{{ prefill.extra.working_hours.end|default:'18:00' }}" onchange="saveWorkingHours()" />
            </div>
        </div>
    </div>

    <!-- Services -->
    <div class="profile-card p-6">
        <div class="section-header">
            <div class="section-icon bg-gradient-to-br from-pink-400 to-rose-500 text-white">
                <i data-lucide="scissors" class="w-5 h-5"></i>
            </div>
            <div class="flex-1 flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900">Services & Tarifs</h2>
                <button onclick="addService()" class="btn-secondary-glass text-sm">
                    <i data-lucide="plus" class="w-4 h-4 mr-1"></i> Ajouter
                </button>
            </div>
        </div>

        <div id="servicesContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <!-- Services will be loaded dynamically -->
        </div>

        <div class="flex justify-end">
            <button onclick="saveAllServices()" class="btn-glass flex items-center gap-2">
                <i data-lucide="save" class="w-4 h-4"></i> Sauvegarder les services
            </button>
        </div>
    </div>

    <!-- Social Networks -->
    <div class="profile-card p-6">
        <div class="section-header">
            <div class="section-icon bg-gradient-to-br from-indigo-400 to-blue-500 text-white">
                <i data-lucide="share-2" class="w-5 h-5"></i>
            </div>
            <h2 class="text-lg font-semibold text-gray-900">Réseaux sociaux</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="flex items-center gap-3 p-3 rounded-xl border bg-gradient-to-r from-pink-50 to-purple-50">
                <i data-lucide="instagram" class="w-5 h-5 text-pink-600"></i>
                <input type="url" id="instagram" class="flex-1 bg-transparent outline-none"
                    placeholder="https://instagram.com/..." data-field="social_instagram" onchange="saveField(this)"
                    value="{{ prefill.extra.social_instagram|default:'' }}" />
            </div>
            <div class="flex items-center gap-3 p-3 rounded-xl border bg-gradient-to-r from-blue-50 to-indigo-50">
                <i data-lucide="facebook" class="w-5 h-5 text-blue-600"></i>
                <input type="url" id="facebook" class="flex-1 bg-transparent outline-none"
                    placeholder="https://facebook.com/..." data-field="social_facebook" onchange="saveField(this)"
                    value="{{ prefill.extra.social_facebook|default:'' }}" />
            </div>
            <div class="flex items-center gap-3 p-3 rounded-xl border bg-gradient-to-r from-gray-50 to-slate-50">
                <i data-lucide="music-2" class="w-5 h-5 text-gray-700"></i>
                <input type="url" id="tiktok" class="flex-1 bg-transparent outline-none"
                    placeholder="https://tiktok.com/..." data-field="social_tiktok" onchange="saveField(this)"
                    value="{{ prefill.extra.social_tiktok|default:'' }}" />
            </div>
        </div>
    </div>

    <!-- Gallery -->
    <div class="profile-card p-6">
        <div class="section-header">
            <div class="section-icon bg-gradient-to-br from-emerald-400 to-teal-500 text-white">
                <i data-lucide="images" class="w-5 h-5"></i>
            </div>
            <h2 class="text-lg font-semibold text-gray-900">Galerie photos</h2>
        </div>

        <div class="flex flex-wrap gap-4" id="galleryContainer">
            <!-- Gallery items will be loaded dynamically -->
        </div>

        <div class="mt-4">
            <div id="dropzone"
                class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer hover:border-pink-400 hover:bg-pink-50/50 transition-all"
                onclick="document.getElementById('galleryInput').click()">
                <i data-lucide="upload-cloud" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                <p class="text-gray-600">Glissez-déposez ou <span class="text-pink-600 font-medium">cliquez pour
                        ajouter</span></p>
                <p class="text-xs text-gray-400 mt-1">JPG, PNG, WebP • Max 5MB</p>
            </div>
            <input type="file" id="galleryInput" accept="image/*" multiple class="hidden"
                onchange="uploadGalleryImages(this)" />
        </div>
    </div>

    <!-- Bouton de sauvegarde global -->
    <div
        class="sticky bottom-0 bg-white/95 backdrop-blur-lg border-t border-gray-200 shadow-lg -mx-4 md:-mx-6 px-4 md:px-6 py-4 mt-8">
        <div class="max-w-5xl mx-auto flex items-center justify-between gap-4">
            <div class="text-sm text-gray-600">
                <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                <span id="saveStatus">Modifiez les champs ci-dessus puis cliquez sur "Sauvegarder"</span>
            </div>
            <button id="saveAllBtn" onclick="saveAllChanges()"
                class="px-8 py-3.5 bg-gradient-to-r from-pink-500 via-purple-500 to-pink-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 flex items-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                <i data-lucide="save" class="w-5 h-5"></i>
                <span>Sauvegarder toutes les modifications</span>
                <div id="saveSpinner" class="hidden">
                    <i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>
                </div>
            </button>
        </div>
    </div>
</div>

<!-- Toast notification -->
<div id="toast" class="toast">
    <span id="toastMessage">Sauvegardé !</span>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // State management
    let profileData = {{ prefill_json| safe }};
    let map, marker;
    let hasUnsavedChanges = false;
    let pendingChanges = {};

    // CSRF Token
    function getCookie(name) {
        const m = document.cookie.match('(^|;)\\s*' + name + '=\\s*([^;]+)');
        return m ? m.pop() : '';
    }

    // Toast notification
    function showToast(message = 'Sauvegardé !', duration = 2000) {
        const toast = document.getElementById('toast');
        document.getElementById('toastMessage').textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), duration);
    }

    // Mark field as changed (no auto-save)
    function saveField(input) {
        const field = input.dataset.field;
        if (!field) return;

        // Marquer comme modifié visuellement
        input.classList.add('saving');
        input.classList.remove('saved');

        // Stocker la valeur dans les changements en attente
        pendingChanges[field] = input.value;
        hasUnsavedChanges = true;
        updateSaveButtonState();

        // Retirer l'indicateur visuel après un court délai
        setTimeout(() => {
            input.classList.remove('saving');
            input.classList.add('changed');
        }, 300);
    }

    // Update save button state
    function updateSaveButtonState() {
        const btn = document.getElementById('saveAllBtn');
        const status = document.getElementById('saveStatus');

        if (hasUnsavedChanges) {
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            status.innerHTML = '<i data-lucide="alert-circle" class="w-4 h-4 inline mr-1 text-orange-500"></i><span class="text-orange-600 font-medium">Vous avez des modifications non sauvegardées</span>';
        } else {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            status.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4 inline mr-1 text-green-500"></i><span class="text-green-600">Toutes les modifications sont sauvegardées</span>';
        }

        if (window.lucide) window.lucide.createIcons();
    }

    // Save all changes at once
    async function saveAllChanges() {
        const btn = document.getElementById('saveAllBtn');
        const spinner = document.getElementById('saveSpinner');

        // Collect all changes from form fields
        const payload = { ...pendingChanges };

        // Business name
        const businessName = document.getElementById('business_name');
        if (businessName && businessName.value) {
            payload.business_name = businessName.value;
        }

        // Phone numbers
        const phone = document.getElementById('phone');
        if (phone && phone.value) {
            payload.phone_number = phone.value;
        }
        const phone2 = document.getElementById('phone2');
        if (phone2 && phone2.value) {
            payload.phone_secondary = phone2.value;
        }

        // Emails
        const email = document.getElementById('email');
        if (email && email.value) {
            payload.email = email.value;
        }
        const email2 = document.getElementById('email2');
        if (email2 && email2.value) {
            payload.email_secondary = email2.value;
        }

        // Address fields
        const address = document.getElementById('address');
        if (address && address.value) {
            payload.address = address.value;
        }
        const city = document.getElementById('city');
        if (city && city.value) {
            payload.city = city.value;
        }
        const governorate = document.getElementById('governorate');
        if (governorate && governorate.value) {
            payload.governorate = governorate.value;
        }

        // Bio
        const bio = document.getElementById('bio');
        if (bio && bio.value) {
            payload.bio = bio.value;
        }

        // Working hours
        const startTime = document.getElementById('startTime');
        const endTime = document.getElementById('endTime');
        if (startTime && endTime && startTime.value && endTime.value) {
            payload.working_hours = {
                start: startTime.value,
                end: endTime.value
            };
        }

        // Social networks
        const instagram = document.getElementById('instagram');
        if (instagram && instagram.value) {
            payload.social_instagram = instagram.value;
        }
        const facebook = document.getElementById('facebook');
        if (facebook && facebook.value) {
            payload.social_facebook = facebook.value;
        }
        const tiktok = document.getElementById('tiktok');
        if (tiktok && tiktok.value) {
            payload.social_tiktok = tiktok.value;
        }

        // Latitude/Longitude
        const lat = document.getElementById('latitude');
        const lng = document.getElementById('longitude');
        if (lat && lng && lat.value && lng.value) {
            payload.latitude = parseFloat(lat.value);
            payload.longitude = parseFloat(lng.value);
        }

        // Working days
        if (pendingChanges.working_days) {
            payload.working_days = pendingChanges.working_days;
        }

        // Services
        if (services && services.length > 0) {
            const validServices = services.filter(s => s.name && s.name.trim() !== '');
            if (validServices.length > 0) {
                payload.services = validServices;
            }
        }

        // Gallery
        if (gallery && gallery.length > 0) {
            payload.gallery = gallery;
        }

        // Show loading state
        btn.disabled = true;
        spinner.classList.remove('hidden');
        btn.querySelector('span').textContent = 'Sauvegarde en cours...';

        try {
            const success = await saveToServer(payload);

            if (success) {
                // Clear pending changes
                pendingChanges = {};
                hasUnsavedChanges = false;

                // Remove changed indicators
                document.querySelectorAll('.changed').forEach(el => {
                    el.classList.remove('changed');
                    el.classList.add('saved');
                    setTimeout(() => el.classList.remove('saved'), 2000);
                });

                updateSaveButtonState();
                showToast('Toutes les modifications ont été sauvegardées avec succès !', 3000);
            } else {
                showToast('Erreur lors de la sauvegarde', 3000);
            }
        } catch (error) {
            console.error('Save error:', error);
            showToast('Erreur de connexion', 3000);
        } finally {
            btn.disabled = false;
            spinner.classList.add('hidden');
            btn.querySelector('span').textContent = 'Sauvegarder toutes les modifications';
        }
    }

    // Save to server (no toast, handled by caller)
    async function saveToServer(data) {
        try {
            const res = await fetch("{% url 'front_web:pro_onboarding_save' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                return true;
            }
            return false;
        } catch (e) {
            console.error('Save error:', e);
            return false;
        }
    }

    // Initialize map
    function initMap() {
        const defaultLat = parseFloat(document.getElementById('latitude').value) || 36.8065;
        const defaultLng = parseFloat(document.getElementById('longitude').value) || 10.1815;

        map = L.map('profileMap').setView([defaultLat, defaultLng], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        marker = L.marker([defaultLat, defaultLng], { draggable: true }).addTo(map);

        // Update on marker drag
        marker.on('dragend', function (e) {
            const pos = e.target.getLatLng();
            updateLocation(pos.lat, pos.lng);
        });

        // Click on map to move marker
        map.on('click', function (e) {
            marker.setLatLng(e.latlng);
            updateLocation(e.latlng.lat, e.latlng.lng);
        });
    }

    // Update location (mark as changed, don't save yet)
    async function updateLocation(lat, lng) {
        document.getElementById('latitude').value = lat.toFixed(6);
        document.getElementById('longitude').value = lng.toFixed(6);

        pendingChanges.latitude = lat;
        pendingChanges.longitude = lng;
        hasUnsavedChanges = true;
        updateSaveButtonState();

        // Reverse geocode to get city and governorate
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=fr`);
            const data = await res.json();
            if (data.address) {
                const city = data.address.city || data.address.town || data.address.village || data.address.municipality || '';
                const governorate = data.address.state || data.address.county || data.address.region || '';
                const address = data.display_name || '';

                if (city) {
                    const cityInput = document.getElementById('city');
                    cityInput.value = city;
                    pendingChanges.city = city;
                    cityInput.classList.add('changed');
                }

                if (governorate) {
                    // Tenter de mapper au gouvernorat tunisien
                    const govSelect = document.getElementById('governorate');
                    const options = Array.from(govSelect.options);
                    const match = options.find(opt =>
                        opt.value.toLowerCase().includes(governorate.toLowerCase()) ||
                        governorate.toLowerCase().includes(opt.value.toLowerCase())
                    );
                    if (match) {
                        govSelect.value = match.value;
                        pendingChanges.governorate = match.value;
                        govSelect.classList.add('changed');
                    }
                }

                if (address) {
                    const addressInput = document.getElementById('address');
                    addressInput.value = address;
                    pendingChanges.address = address;
                    addressInput.classList.add('changed');
                }

                hasUnsavedChanges = true;
                updateSaveButtonState();
            }
        } catch (e) { console.error('Geocoding error:', e); }
    }

    // Use current location
    function locateMe() {
        if (!navigator.geolocation) {
            showToast('Géolocalisation non supportée', 3000);
            return;
        }

        showToast('Localisation en cours...', 3000);

        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;

                map.setView([lat, lng], 15);
                marker.setLatLng([lat, lng]);
                updateLocation(lat, lng);
            },
            (err) => {
                showToast('Impossible de vous localiser', 3000);
            },
            { enableHighAccuracy: true }
        );
    }

    // Working days
    function initDays() {
        const days = profileData.extra.working_days || [];
        document.querySelectorAll('.day-pill').forEach(pill => {
            if (days.includes(pill.dataset.day)) {
                pill.classList.add('active');
            }
        });
    }

    function toggleDay(pill) {
        pill.classList.toggle('active');
        saveWorkingDays();
    }

    function saveWorkingDays() {
        const days = [];
        document.querySelectorAll('.day-pill.active').forEach(pill => {
            days.push(pill.dataset.day);
        });
        pendingChanges.working_days = days;
        hasUnsavedChanges = true;
        updateSaveButtonState();
    }

    function saveWorkingHours() {
        const startTime = document.getElementById('startTime');
        const endTime = document.getElementById('endTime');
        if (startTime && endTime) {
            pendingChanges.working_hours = {
                start: startTime.value,
                end: endTime.value
            };
            startTime.classList.add('changed');
            endTime.classList.add('changed');
            hasUnsavedChanges = true;
            updateSaveButtonState();
        }
    }

    // Services
    let services = [];

    // Liste des services disponibles
    const availableServices = [
        // Coiffure
        { name: 'Coiffure', category: 'Coiffure' },
        { name: 'Coupe femme', category: 'Coiffure' },
        { name: 'Coupe homme', category: 'Coiffure' },
        { name: 'Coupe enfant', category: 'Coiffure' },
        { name: 'Coloration', category: 'Coiffure' },
        { name: 'Mèches & Balayage', category: 'Coiffure' },
        { name: 'Brushing & Coiffage', category: 'Coiffure' },
        { name: 'Soins capillaires', category: 'Coiffure' },
        { name: 'Lissage & Kératine', category: 'Coiffure' },
        { name: 'Extensions cheveux', category: 'Coiffure' },
        { name: 'Tresses & Nattes', category: 'Coiffure' },
        { name: 'Coiffure mariée', category: 'Coiffure' },
        // Maquillage
        { name: 'Maquillage', category: 'Maquillage' },
        { name: 'Maquillage mariée', category: 'Maquillage' },
        { name: 'Maquillage soirée', category: 'Maquillage' },
        { name: 'Maquillage naturel', category: 'Maquillage' },
        { name: 'Cours de maquillage', category: 'Maquillage' },
        // Ongles
        { name: 'Manucure', category: 'Ongles' },
        { name: 'Pédicure', category: 'Ongles' },
        { name: 'Nail art', category: 'Ongles' },
        { name: 'Pose gel', category: 'Ongles' },
        { name: 'Pose résine', category: 'Ongles' },
        { name: 'Semi-permanent', category: 'Ongles' },
        { name: 'Soins des ongles', category: 'Ongles' },
        // Esthétique
        { name: 'Esthétique', category: 'Esthétique' },
        { name: 'Soin du visage', category: 'Esthétique' },
        { name: 'Nettoyage de peau', category: 'Esthétique' },
        { name: 'Soin anti-âge', category: 'Esthétique' },
        { name: 'Soin hydratant', category: 'Esthétique' },
        { name: 'Traitement acné', category: 'Esthétique' },
        { name: 'Microdermabrasion', category: 'Esthétique' },
        { name: 'Peeling', category: 'Esthétique' },
        { name: 'Luminothérapie LED', category: 'Esthétique' },
        // Épilation
        { name: 'Épilation cire', category: 'Épilation' },
        { name: 'Épilation visage', category: 'Épilation' },
        { name: 'Épilation corps', category: 'Épilation' },
        { name: 'Épilation maillot', category: 'Épilation' },
        { name: 'Épilation au fil', category: 'Épilation' },
        { name: 'Épilation laser', category: 'Épilation' },
        { name: 'Épilation au sucre', category: 'Épilation' },
        // Sourcils & Cils
        { name: 'Épilation sourcils', category: 'Sourcils & Cils' },
        { name: 'Teinture sourcils', category: 'Sourcils & Cils' },
        { name: 'Brow lamination', category: 'Sourcils & Cils' },
        { name: 'Microblading', category: 'Sourcils & Cils' },
        { name: 'Extension de cils', category: 'Sourcils & Cils' },
        { name: 'Rehaussement de cils', category: 'Sourcils & Cils' },
        { name: 'Teinture de cils', category: 'Sourcils & Cils' },
        // Massage
        { name: 'Massage', category: 'Massage & Bien-être' },
        { name: 'Massage relaxant', category: 'Massage & Bien-être' },
        { name: 'Massage deep tissue', category: 'Massage & Bien-être' },
        { name: 'Massage pierres chaudes', category: 'Massage & Bien-être' },
        { name: 'Aromathérapie', category: 'Massage & Bien-être' },
        { name: 'Réflexologie', category: 'Massage & Bien-être' },
        { name: 'Drainage lymphatique', category: 'Massage & Bien-être' },
        { name: 'Massage prénatal', category: 'Massage & Bien-être' },
        // Corps
        { name: 'Soin du corps', category: 'Corps' },
        { name: 'Gommage corps', category: 'Corps' },
        { name: 'Enveloppement', category: 'Corps' },
        { name: 'Soin minceur', category: 'Corps' },
        { name: 'Traitement cellulite', category: 'Corps' },
        { name: 'Bronzage', category: 'Corps' },
        { name: 'Autobronzant', category: 'Corps' },
        // Spa
        { name: 'Spa', category: 'Spa & Hammam' },
        { name: 'Hammam', category: 'Spa & Hammam' },
        { name: 'Sauna', category: 'Spa & Hammam' },
        { name: 'Jacuzzi', category: 'Spa & Hammam' },
        // Maquillage permanent
        { name: 'Maquillage permanent', category: 'Maquillage permanent' },
        { name: 'Tatouage lèvres', category: 'Maquillage permanent' },
        { name: 'Tatouage eye-liner', category: 'Maquillage permanent' },
        // Hommes
        { name: 'Barbier', category: 'Hommes' },
        { name: 'Taille de barbe', category: 'Hommes' },
        { name: 'Soins barbe', category: 'Hommes' },
        { name: 'Soin visage homme', category: 'Hommes' },
        // Autres
        { name: 'Henné', category: 'Autres' },
        { name: 'Blanchiment dentaire', category: 'Autres' },
        { name: 'Piercing', category: 'Autres' },
        { name: 'Autre', category: 'Autres' },
    ];

    function initServices() {
        services = profileData.extra.services || [];
        renderServices();
    }

    function getServiceOptions(selectedName = '') {
        const categories = [...new Set(availableServices.map(s => s.category))];
        let html = '<option value="">-- Sélectionner un service --</option>';
        categories.forEach(cat => {
            html += `<optgroup label="${cat}">`;
            availableServices.filter(s => s.category === cat).forEach(s => {
                const selected = s.name === selectedName ? 'selected' : '';
                html += `<option value="${s.name}" ${selected}>${s.name}</option>`;
            });
            html += '</optgroup>';
        });
        return html;
    }

    function renderServices() {
        const container = document.getElementById('servicesContainer');
        container.innerHTML = services.map((s, i) => `
            <div class="service-card">
                <div class="flex items-start justify-between mb-3">
                    <select class="font-medium text-gray-900 bg-transparent border-b border-gray-200 hover:border-gray-300 focus:border-pink-400 outline-none w-full py-1"
                            onchange="updateServiceLocal(${i}, 'name', this.value)">
                        ${getServiceOptions(s.name)}
                    </select>
                    <button onclick="deleteService(${i})" class="text-gray-400 hover:text-red-500 ml-2 flex-shrink-0">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="flex items-center gap-2 text-sm">
                        <i data-lucide="clock" class="w-4 h-4 text-gray-400"></i>
                        <input type="number" class="bg-transparent border-b border-gray-200 focus:border-pink-400 outline-none w-16 text-center"
                               value="${s.duration_min || 60}" onchange="updateServiceLocal(${i}, 'duration_min', parseInt(this.value))" min="15" />
                        <span class="text-gray-500">min</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="text-gray-500">Prix:</span>
                        <input type="number" class="bg-transparent border-b border-gray-200 focus:border-pink-400 outline-none w-16 text-center font-semibold text-pink-600"
                               value="${s.price || 0}" onchange="updateServiceLocal(${i}, 'price', parseFloat(this.value))" min="0" />
                        <span class="text-pink-600 font-semibold">DT</span>
                    </div>
                </div>
            </div>
        `).join('');

        if (services.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4 col-span-2">Aucun service. Cliquez sur "Ajouter" pour commencer.</p>';
        }

        if (window.lucide) lucide.createIcons();
    }

    function addService() {
        services.push({ name: '', duration_min: 60, price: 0 });
        renderServices();
    }

    function updateServiceLocal(index, field, value) {
        services[index][field] = value;
        // Ne pas sauvegarder automatiquement - attendre le bouton
    }

    function saveAllServices() {
        // Filtrer les services vides
        const validServices = services.filter(s => s.name && s.name.trim() !== '');
        services = validServices;
        pendingChanges.services = services;
        hasUnsavedChanges = true;
        updateSaveButtonState();
        renderServices();
    }

    function deleteService(index) {
        services.splice(index, 1);
        renderServices();
    }

    // Gallery
    let gallery = [];

    function initGallery() {
        gallery = profileData.extra.gallery || [];
        renderGallery();
    }

    function renderGallery() {
        const container = document.getElementById('galleryContainer');
        container.innerHTML = gallery.map((url, i) => `
            <div class="gallery-item">
                <img src="${url}" alt="Photo ${i + 1}" />
                <button class="delete-btn" onclick="deleteGalleryImage(${i})">×</button>
            </div>
        `).join('');
    }

    async function uploadGalleryImages(input) {
        const files = Array.from(input.files);
        for (const file of files.slice(0, 10)) {
            const b64 = await toBase64(file);
            gallery.push(b64);
        }
        renderGallery();
        pendingChanges.gallery = gallery;
        hasUnsavedChanges = true;
        updateSaveButtonState();
        input.value = '';
    }

    function deleteGalleryImage(index) {
        gallery.splice(index, 1);
        renderGallery();
        pendingChanges.gallery = gallery;
        hasUnsavedChanges = true;
        updateSaveButtonState();
    }

    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // Profile photo
    async function uploadPhoto(input) {
        if (!input.files || !input.files[0]) return;
        const b64 = await toBase64(input.files[0]);
        document.getElementById('profilePhoto').src = b64;
        await saveToServer({ profile_photo: b64 });
    }

    // Drag & drop for gallery
    function initDropzone() {
        const dropzone = document.getElementById('dropzone');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
            dropzone.addEventListener(event, e => e.preventDefault());
        });

        dropzone.addEventListener('dragover', () => dropzone.classList.add('border-pink-400', 'bg-pink-50'));
        dropzone.addEventListener('dragleave', () => dropzone.classList.remove('border-pink-400', 'bg-pink-50'));

        dropzone.addEventListener('drop', async (e) => {
            dropzone.classList.remove('border-pink-400', 'bg-pink-50');
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            for (const file of files.slice(0, 10)) {
                const b64 = await toBase64(file);
                gallery.push(b64);
            }
            renderGallery();
            await saveToServer({ gallery: gallery });
        });
    }

    // Initialize everything
    document.addEventListener('DOMContentLoaded', () => {
        initMap();
        initDays();
        initServices();
        initGallery();
        initDropzone();
        updateSaveButtonState();

        if (window.lucide) lucide.createIcons();
    });
</script>
{% endblock %}