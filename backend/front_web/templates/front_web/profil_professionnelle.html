{% extends 'front_web/base_prof.html' %}
{% load static %}

{% block title %}Mon profil - Coucou Beauté{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-6">
    <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-bold">Mon profil</h1>
        <div class="text-xs text-gray-500">Modifiez vos informations professionnelles</div>
    </div>
    <div class="mb-6 rounded-2xl border bg-white/70 p-4 flex items-center gap-3">
        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-pink-100 to-blue-100 flex items-center justify-center overflow-hidden"
            id="iconWrap">
            <i data-lucide="user-round" class="w-6 h-6 text-pink-500"></i>
        </div>
        <img id="headAvatar" src="" alt="Profil" class="w-12 h-12 rounded-full object-cover hidden" />
        <div class="text-sm text-gray-600">Mettez à jour votre bio, vos réseaux, vos photos et vos services.</div>
        <button id="btnPickPhoto" class="ml-auto btn-secondary-glass text-sm">Changer la photo</button>
        <input id="filePhoto" type="file" accept="image/*" class="hidden" />
    </div>

    <div id="app" class="space-y-4" data-prefill='{{ prefill|default:"{}"|safe }}'>
        <div>
            <label class="block text-sm text-gray-600 mb-1">Ville</label>
            <input id="city" class="w-full border rounded-xl px-3 py-2" placeholder="Votre ville" />
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
                <label class="block text-sm text-gray-600 mb-1">Nom du centre</label>
                <input id="business" class="w-full border rounded-xl px-3 py-2"
                    placeholder="Nom de votre salon/centre" />
            </div>
            <div>
                <label class="block text-sm text-gray-600 mb-1">Téléphone</label>
                <input id="phone" class="w-full border rounded-xl px-3 py-2" placeholder="Téléphone" />
            </div>
        </div>
        <div>
            <label class="block text-sm text-gray-600 mb-1">Email</label>
            <input id="email" class="w-full border rounded-xl px-3 py-2 bg-gray-50" placeholder="—" disabled />
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
                <label class="block text-sm text-gray-600 mb-1">Catégorie d'activité</label>
                <select id="activity_category" class="w-full border rounded-xl px-3 py-2 bg-white">
                    <option value="">—</option>
                    <option value="hairdressing">Coiffure</option>
                    <option value="makeup">Maquillage</option>
                    <option value="manicure">Manucure</option>
                    <option value="esthetics">Esthétique</option>
                    <option value="massage">Massage</option>
                    <option value="other">Autre</option>
                </select>
                <div class="text-xs text-gray-500 mt-1">Prérempli depuis vos données, modifiable ici.</div>
            </div>
            <div>
                <label class="block text-sm text-gray-600 mb-1">Type de service</label>
                <select id="service_type" class="w-full border rounded-xl px-3 py-2 bg-white">
                    <option value="">—</option>
                    <option value="mobile">Je me déplace</option>
                    <option value="home">Je reçois chez moi</option>
                    <option value="salon">J'ai un salon</option>
                </select>
            </div>
        </div>
        <div>
            <label class="block text-sm text-gray-600 mb-1">Bio</label>
            <textarea id="bio" class="w-full border rounded-xl px-3 py-2" rows="4"
                placeholder="Parlez de vous"></textarea>
            <div id="err_bio" class="text-xs text-red-600 mt-1 hidden"></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="flex items-center gap-2 border rounded-xl px-3 py-2 bg-white/70">
                <i data-lucide="instagram" class="w-4 h-4 text-pink-500"></i>
                <input id="ig" class="w-full outline-none" placeholder="Lien Instagram (https://...)" />
            </div>
            <div class="flex items-center gap-2 border rounded-xl px-3 py-2 bg-white/70">
                <i data-lucide="facebook" class="w-4 h-4 text-blue-600"></i>
                <input id="fb" class="w-full outline-none" placeholder="Lien Facebook (https://...)" />
            </div>
            <div class="flex items-center gap-2 border rounded-xl px-3 py-2 bg-white/70">
                <i data-lucide="music-2" class="w-4 h-4 text-gray-700"></i>
                <input id="tt" class="w-full outline-none" placeholder="Lien TikTok (https://...)" />
            </div>
        </div>

        <div class="border rounded-xl p-3">
            <div class="font-medium mb-2">Jours de travail</div>
            <div id="days" class="flex flex-wrap gap-2">
                <label class="inline-flex items-center gap-2 px-3 py-1 rounded-full border bg-white/70"><input
                        type="checkbox" value="mon" class="accent-pink-500" /> Lun</label>
                <label class="inline-flex items-center gap-2 px-3 py-1 rounded-full border bg-white/70"><input
                        type="checkbox" value="tue" class="accent-pink-500" /> Mar</label>
                <label class="inline-flex items-center gap-2 px-3 py-1 rounded-full border bg-white/70"><input
                        type="checkbox" value="wed" class="accent-pink-500" /> Mer</label>
                <label class="inline-flex items-center gap-2 px-3 py-1 rounded-full border bg-white/70"><input
                        type="checkbox" value="thu" class="accent-pink-500" /> Jeu</label>
                <label class="inline-flex items-center gap-2 px-3 py-1 rounded-full border bg-white/70"><input
                        type="checkbox" value="fri" class="accent-pink-500" /> Ven</label>
                <label class="inline-flex items-center gap-2 px-3 py-1 rounded-full border bg-white/70"><input
                        type="checkbox" value="sat" class="accent-pink-500" /> Sam</label>
                <label class="inline-flex items-center gap-2 px-3 py-1 rounded-full border bg-white/70"><input
                        type="checkbox" value="sun" class="accent-pink-500" /> Dim</label>
            </div>
            <div class="mt-3 grid grid-cols-2 gap-2">
                <input id="startTime" type="time" class="border rounded-xl px-3 py-2" />
                <input id="endTime" type="time" class="border rounded-xl px-3 py-2" />
            </div>
            <div id="err_days" class="text-xs text-red-600 mt-1 hidden"></div>
        </div>

        <div class="border rounded-xl p-3">
            <div class="font-medium mb-2">Galerie (photos de réalisations)</div>
            <div id="gallery" class="flex flex-wrap gap-3 mb-3"></div>
            <div id="dropGallery"
                class="w-full rounded-xl border-2 border-dashed p-4 text-center text-sm text-gray-600 bg-white/60 cursor-pointer">
                Glissez-déposez des images ici ou <span class="text-blue-600">cliquez pour choisir</span>
                <input id="galleryInput" type="file" accept="image/*" class="hidden" multiple />
            </div>
        </div>

        <div class="border rounded-xl p-3">
            <div class="font-medium mb-2">Services & tarifs</div>
            <div id="services" class="space-y-2"></div>
            <button id="addService" class="mt-2 px-3 py-1 rounded-lg border">Ajouter un service</button>
            <div id="err_services" class="text-xs text-red-600 mt-1 hidden"></div>
        </div>

        <div>
            <button id="save" class="px-4 py-2 rounded-xl bg-pink-500 text-white">Enregistrer</button>
            <div id="hint" class="text-xs text-gray-500 mt-1"></div>
        </div>
    </div>
</div>

<script>
    function serviceRow(name = '', duration = '', price = '') {
        const wrap = document.createElement('div');
        wrap.className = 'grid grid-cols-3 gap-2';
        wrap.innerHTML = `<input class="border rounded-xl px-3 py-2" placeholder="Service" value="${name}">
                      <input class="border rounded-xl px-3 py-2" placeholder="Durée (min)" value="${duration}">
                      <input class="border rounded-xl px-3 py-2" placeholder="Prix (DT)" value="${price}">`;
        return wrap;
    }
    document.getElementById('addService').addEventListener('click', () => {
        document.getElementById('services').appendChild(serviceRow());
    });
    document.getElementById('services').appendChild(serviceRow());

    function getCookie(name) { const m = document.cookie.match('(^|;)\\s*' + name + '=\\s*([^;]+)'); return m ? m.pop() : ''; }
    // Prefill from server hints & render existing gallery
    (function () {
        try {
            const root = document.getElementById('app');
            const data = JSON.parse(root.getAttribute('data-prefill') || '{}');
            const extra = data.extra || {};
            if (extra.city) document.getElementById('city').value = extra.city;
            if (extra.bio) document.getElementById('bio').value = extra.bio;
            if (extra.business_name) document.getElementById('business').value = extra.business_name;
            if (extra.phone_number) document.getElementById('phone').value = extra.phone_number;
            if (extra.social_instagram) document.getElementById('ig').value = extra.social_instagram;
            if (extra.social_facebook) document.getElementById('fb').value = extra.social_facebook;
            if (extra.social_tiktok) document.getElementById('tt').value = extra.social_tiktok;
            (extra.working_days || []).forEach(code => {
                const el = document.querySelector('#days input[value="' + code + '"]');
                if (el) el.checked = true;
            });
            const wh = extra.working_hours || {};
            if (wh.start) document.getElementById('startTime').value = wh.start;
            if (wh.end) document.getElementById('endTime').value = wh.end;
            const services = extra.services || []; if (services.length) { const cont = document.getElementById('services'); cont.innerHTML = ''; services.forEach(s => cont.appendChild(serviceRow(s.name || '', s.duration_min || '', s.price || ''))); }
            const gallery = extra.gallery || []; if (gallery.length) { gallery.forEach(url => addThumb(url)); galleryData = gallery.slice(0); }
            const app = (data.application_hint || {});
            if (!document.getElementById('city').value && app.address) document.getElementById('city').value = app.address;
            if (!document.getElementById('business').value && app.salon_name) document.getElementById('business').value = app.salon_name;
            if (!document.getElementById('phone').value && app.phone_number) document.getElementById('phone').value = app.phone_number;
            if (app.email) document.getElementById('email').value = app.email;
            if (extra.profile_photo_url) { const img = document.getElementById('headAvatar'); img.src = extra.profile_photo_url; img.classList.remove('hidden'); document.getElementById('iconWrap').classList.add('hidden'); }
            else if (app.profile_photo) { const img = document.getElementById('headAvatar'); img.src = app.profile_photo; img.classList.remove('hidden'); document.getElementById('iconWrap').classList.add('hidden'); }
            if (app.activity_category) document.getElementById('activity_category').value = app.activity_category;
            if (app.service_type) document.getElementById('service_type').value = app.service_type;
        } catch (e) { }
    })();

    // Gallery management
    let galleryData = [];
    const gInput = document.getElementById('galleryInput');
    const drop = document.getElementById('dropGallery');
    drop.addEventListener('click', () => gInput.click());
    drop.addEventListener('dragover', (e) => { e.preventDefault(); drop.classList.add('bg-blue-50'); });
    drop.addEventListener('dragleave', () => drop.classList.remove('bg-blue-50'));
    drop.addEventListener('drop', (e) => { e.preventDefault(); drop.classList.remove('bg-blue-50'); if (e.dataTransfer.files?.length) { handleFiles(e.dataTransfer.files); } });
    gInput.addEventListener('change', (e) => { if (e.target.files?.length) { handleFiles(e.target.files); } });
    function handleFiles(fileList) { [...fileList].slice(0, 20).forEach(f => toBase64(f).then(b64 => { galleryData.push(b64); addThumb(b64); })); }
    function addThumb(src) {
        const box = document.createElement('div'); box.className = 'relative';
        box.innerHTML = `<img src="${src}" class="w-24 h-24 object-cover rounded-lg border"/>
                         <button type="button" class="absolute -right-2 -top-2 bg-black/70 text-white rounded-full w-6 h-6">×</button>`;
        box.querySelector('button').addEventListener('click', () => { box.remove(); galleryData = galleryData.filter(x => x !== src); });
        document.getElementById('gallery').appendChild(box);
    }
    function toBase64(file) { return new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file); }); }

    function validateFormInline() {
        const bio = document.getElementById('bio').value.trim();
        const days = getSelectedDays();
        const hasService = [...document.querySelectorAll('#services .grid')].some(row => {
            const [n, p] = [row.querySelectorAll('input')[0]?.value.trim(), row.querySelectorAll('input')[2]?.value.trim()];
            return n && p;
        });
        const setErr = (id, msg) => { const el = document.getElementById(id); if (!el) return; if (msg) { el.textContent = msg; el.classList.remove('hidden'); } else { el.textContent = ''; el.classList.add('hidden'); } };
        setErr('err_bio', bio ? '' : 'Veuillez renseigner votre bio.');
        setErr('err_days', days.length ? '' : 'Sélectionnez au moins un jour de travail.');
        setErr('err_services', hasService ? '' : 'Ajoutez au moins un service avec nom et prix.');
        if (!bio) document.getElementById('bio').classList.add('ring-1', 'ring-red-300'); else document.getElementById('bio').classList.remove('ring-1', 'ring-red-300');
        if (!days.length) document.getElementById('days').classList.add('ring-1', 'ring-red-300'); else document.getElementById('days').classList.remove('ring-1', 'ring-red-300');
        if (!hasService) document.getElementById('services').classList.add('ring-1', 'ring-red-300'); else document.getElementById('services').classList.remove('ring-1', 'ring-red-300');
        return bio && days.length && hasService;
    }

    document.getElementById('bio').addEventListener('input', validateFormInline);
    document.getElementById('days').addEventListener('click', validateFormInline);
    document.getElementById('services').addEventListener('input', validateFormInline);
    validateFormInline();

    document.getElementById('save').addEventListener('click', async () => {
        const ok = validateFormInline();
        if (!ok) {
            const first = document.querySelector('#err_bio:not(.hidden), #err_days:not(.hidden), #err_services:not(.hidden)');
            if (first) first.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }
        const city = document.getElementById('city').value.trim();
        const bio = document.getElementById('bio').value.trim();
        const business = document.getElementById('business').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const social_instagram = document.getElementById('ig').value.trim();
        const social_facebook = document.getElementById('fb').value.trim();
        const social_tiktok = document.getElementById('tt').value.trim();
        const days = getSelectedDays();
        const start = document.getElementById('startTime').value || '09:00';
        const end = document.getElementById('endTime').value || '18:00';
        const services = [...document.querySelectorAll('#services .grid')].map(row => {
            const [n, d, p] = row.querySelectorAll('input');
            if (!n.value.trim()) return null;
            return { name: n.value.trim(), duration_min: parseInt(d.value || '0'), price: parseFloat(p.value || '0') };
        }).filter(Boolean);
        const errors = [];
        const hasService = services.length > 0;
        if (!bio) errors.push('Bio requise');
        if (!days.length) errors.push('Sélectionnez au moins un jour');
        if (!hasService) errors.push('Ajoutez au moins un service (nom et prix)');
        if (errors.length) { alert(errors.join('\n')); return; }
        const payload = { bio, city, phone, business, social_instagram, social_facebook, social_tiktok, services, working_days: days, working_hours: { start, end }, gallery: galleryData };
        const avatar = document.getElementById('headAvatar');
        if (avatar && avatar.dataset && avatar.dataset.b64) { payload.profile_photo = avatar.dataset.b64; }
        const res = await fetch("{% url 'front_web:pro_onboarding_save' %}", { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }, body: JSON.stringify(payload) });
        if (res.ok) { window.location.href = "{% url 'front_web:pro_dashboard' %}"; }
        else { alert("Échec de l'enregistrement"); }
    });

    function getSelectedDays() { const sel = []; document.querySelectorAll('#days input:checked').forEach(b => { sel.push(b.value); }); return sel; }
    document.getElementById('btnPickPhoto').addEventListener('click', () => document.getElementById('filePhoto').click());
    document.getElementById('filePhoto').addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0]; if (!f) return;
        const reader = new FileReader();
        reader.onload = () => { const img = document.getElementById('headAvatar'); img.src = reader.result; img.classList.remove('hidden'); document.getElementById('iconWrap').classList.add('hidden'); img.dataset.b64 = reader.result; };
        reader.readAsDataURL(f);
    });
</script>
{% endblock %}