{% extends 'front_web/base_client.html' %}
{% load static %}
{% block title %}Prendre rendez-vous - {{ pro.business_name|default:pro.user.get_full_name }} - Coucou
Beaut√©{%endblock%}



{% block extra_css %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    body {
        font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial;
    }

    /* Ultra-modern animated gradient background */
    #three-bg {
        position: fixed;
        inset: 0;
        z-index: -1;
        background: radial-gradient(1200px 800px at 20% 10%, rgba(242, 139, 178, 0.25), transparent 60%),
            radial-gradient(1200px 800px at 80% 30%, rgba(108, 169, 224, 0.25), transparent 60%),
            linear-gradient(135deg, #3a1c71 0%, #d76d77 50%, #6eacd8 100%);
        overflow: hidden;
    }

    #three-bg::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(242, 139, 178, 0.1) 0%, transparent 70%);
        animation: float 20s ease-in-out infinite;
    }

    #three-bg::after {
        content: '';
        position: absolute;
        bottom: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(108, 169, 224, 0.1) 0%, transparent 70%);
        animation: float 25s ease-in-out infinite reverse;
    }

    @keyframes float {

        0%,
        100% {
            transform: translate(0, 0) rotate(0deg);
        }

        33% {
            transform: translate(30px, -30px) rotate(120deg);
        }

        66% {
            transform: translate(-20px, 20px) rotate(240deg);
        }
    }

    .grad-btn {
        background: linear-gradient(90deg, #F28BB2 0%, #6CA9E0 100%);
    }

    .glass {
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.92), rgba(255, 255, 255, 0.82));
        box-shadow: 0 18px 48px rgba(16, 24, 40, 0.18);
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 18px;
    }

    .text-rosePastel {
        color: #F28BB2;
    }

    .text-blueLight {
        color: #6CA9E0;
    }

    /* Horizontal swipeable calendar carousel */
    .calendar-wrap {
        position: relative;
        perspective: 800px;
    }

    .calendar-track {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        padding-bottom: 6px;
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
    }

    .calendar-card {
        scroll-snap-align: start;
        min-width: 78px;
        min-height: 96px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(226, 232, 240, 0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
        transform-style: preserve-3d;
    }

    .calendar-card:hover {
        transform: translateY(-3px) rotateX(6deg);
        box-shadow: 0 18px 38px rgba(108, 169, 224, 0.28);
    }

    .calendar-card[aria-selected="true"],
    .calendar-card.selected {
        background: linear-gradient(135deg, #F28BB2 0%, #6CA9E0 100%);
        color: #fff;
        border-color: transparent;
        box-shadow: 0 14px 32px rgba(242, 139, 178, 0.35);
        transform: translateY(-2px) rotateX(0);
    }

    .cal-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 5;
    }

    .cal-nav button {
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(255, 255, 255, 0.6);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        box-shadow: 0 10px 24px rgba(16, 24, 40, .18);
    }

    .cal-nav.prev {
        left: -8px;
    }

    .cal-nav.next {
        right: -8px;
    }

    /* Time slots as interactive cards */
    .time-slot {
        transition: all 0.25s ease;
        border-radius: 14px;
    }

    .time-slot:hover {
        transform: translateY(-3px);
        box-shadow: 0 14px 30px rgba(16, 24, 40, .15);
    }

    .time-slot .meta {
        opacity: 0;
        transform: translateY(6px);
        transition: .2s ease;
        font-size: 11px;
    }

    .time-slot:hover .meta {
        opacity: 1;
        transform: translateY(0);
    }

    .time-slot.selected {
        background: linear-gradient(90deg, #F28BB2 0%, #6CA9E0 100%);
        color: #fff;
        border-color: transparent;
    }

    .time-slot.disabled {
        background: #f3f4f6;
        color: #9ca3af;
        border-color: #e5e7eb;
        cursor: not-allowed;
        opacity: .9;
    }

    .time-slot.pending {
        background: #fef3c7;
        border-color: #fde68a;
        color: #92400e;
        cursor: not-allowed;
    }

    .service-card {
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        border: 2px solid transparent;
        border-radius: 18px;
    }

    .service-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 35px rgba(108, 169, 224, 0.25);
    }

    .service-card.selected {
        background: linear-gradient(135deg, rgba(242, 139, 178, 0.08) 0%, rgba(108, 169, 224, 0.08) 100%);
        border-image: linear-gradient(135deg, #F28BB2, #6CA9E0) 1;
        animation: cardPulse 400ms ease;
    }

    .service-card .sel-check {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 26px;
        height: 26px;
        border-radius: 9999px;
        background: linear-gradient(135deg, #F28BB2, #6CA9E0);
        display: grid;
        place-items: center;
        color: #fff;
        box-shadow: 0 8px 18px rgba(108, 169, 224, 0.25);
        transform: scale(0.7);
        opacity: 0;
        transition: transform .2s ease, opacity .2s ease;
    }

    .service-card.selected .sel-check {
        transform: scale(1);
        opacity: 1;
    }

    @keyframes cardPulse {
        from {
            transform: translateY(-3px) scale(0.98);
        }

        to {
            transform: translateY(0) scale(1);
        }
    }

    /* Notification styles */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        padding: 16px 24px;
        border-radius: 12px;
        font-weight: 500;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    }

    .notification.show {
        transform: translateX(0);
    }

    .notification.success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .notification.warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }

    .notification.error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }

    /* Pulse animation for updated slots */
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
        }
    }

    .time-slot.updated {
        animation: pulse 1s ease-out;
    }

    /* Floating label form control */
    .float-field {
        position: relative;
    }

    .float-field>input,
    .float-field>textarea {
        width: 100%;
        padding: 14px 14px 14px 12px;
        border-radius: 12px;
        border: 1px solid rgba(226, 232, 240, 1);
        background: rgba(255, 255, 255, 0.9);
        transition: border-color .2s ease, box-shadow .2s ease;
    }

    .float-field>label {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6B7280;
        pointer-events: none;
        transition: .2s ease;
        background: transparent;
        padding: 0 4px;
    }

    .float-field>input:focus,
    .float-field>textarea:focus {
        outline: none;
        border-color: #F28BB2;
        box-shadow: 0 0 0 3px rgba(242, 139, 178, 0.15);
    }

    .float-field>input:not(:placeholder-shown)+label,
    .float-field>textarea:not(:placeholder-shown)+label,
    .float-field>input:focus+label,
    .float-field>textarea:focus+label {
        top: 0;
        transform: translateY(-50%) scale(.85);
        color: #F28BB2;
        background: #fff;
        border-radius: 6px;
    }

    /* CTA glowing button */
    .cta-glow {
        position: relative;
        isolation: isolate;
        background: linear-gradient(90deg, #F28BB2, #6CA9E0);
        box-shadow: 0 10px 30px rgba(242, 139, 178, .35), inset 0 0 0 1px rgba(255, 255, 255, .4);
    }

    .cta-glow::after {
        content: '';
        position: absolute;
        inset: -8px;
        z-index: -1;
        filter: blur(16px);
        background: radial-gradient(closest-side, rgba(242, 139, 178, .45), transparent), radial-gradient(closest-side, rgba(108, 169, 224, .45), transparent);
        opacity: .8;
        animation: glow 2.4s ease-in-out infinite alternate;
    }

    /* Success Modal */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, .35);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-card {
        width: 100%;
        max-width: 520px;
        border-radius: 20px;
    }

    .modal-overlay.show {
        display: flex;
    }

    @keyframes glow {
        from {
            opacity: .6;
            transform: scale(.98);
        }

        to {
            opacity: 1;
            transform: scale(1.02);
        }
    }

    /* Steps progress indicator */
    .steps {
        display: grid;
        grid-auto-flow: column;
        gap: 10px;
        align-items: center;
    }

    .steps .dot {
        width: 10px;
        height: 10px;
        border-radius: 9999px;
        background: #e5e7eb;
        transition: .2s;
    }

    .steps .dot.active {
        background: linear-gradient(135deg, #F28BB2, #6CA9E0);
        box-shadow: 0 0 0 4px rgba(242, 139, 178, .15);
    }

    /* Submit button enhancements */
    #submitBtn {
        position: relative;
    }

    #submitBtn.loading {
        opacity: 0.9;
        pointer-events: none;
    }

    #submitBtn .spinner {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 3px solid rgba(255, 255, 255, 0.5);
        border-top-color: #fff;
        animation: spin 1s linear infinite;
    }

    /* ==========================
       RESPONSIVE MOBILE OPTIMIZATIONS
       ========================== */
    @media (max-width: 768px) {

        /* Disable background on mobile */
        #three-bg,
        #three-bg::before,
        #three-bg::after {
            display: none !important;
        }

        /* Mobile body */
        body {
            font-size: 16px !important;
            -webkit-text-size-adjust: 100%;
        }

        /* Sticky header mobile */
        .sticky.top-0 {
            padding: 0.75rem 1rem !important;
        }

        .glass.px-4 {
            padding: 0.75rem 1rem !important;
            font-size: 0.875rem !important;
        }

        /* Container mobile */
        .max-w-6xl {
            padding: 0 1rem !important;
        }

        .pb-8 {
            padding-bottom: 1.5rem !important;
        }

        /* Steps grid to single column */
        .grid.grid-cols-1.lg\\:grid-cols-3 {
            grid-template-columns: 1fr !important;
            gap: 1.5rem !important;
        }

        /* Step cards mobile */
        .glass.rounded-3xl {
            padding: 1rem !important;
            border-radius: 1.5rem !important;
        }

        /* Step header mobile */
        .w-10.h-10 {
            width: 2.5rem !important;
            height: 2.5rem !important;
        }

        h2.text-xl {
            font-size: 1.125rem !important;
        }

        /* Service cards mobile */
        .service-card {
            padding: 0.875rem !important;
        }

        .service-card h3 {
            font-size: 0.9375rem !important;
        }

        .service-card .text-sm {
            font-size: 0.8125rem !important;
        }

        .service-card .text-lg {
            font-size: 1rem !important;
        }

        /* Calendar mobile */
        .calendar-wrap {
            margin: 0 -0.5rem !important;
        }

        .calendar-track {
            gap: 8px !important;
            padding: 0 0.5rem 6px !important;
        }

        .calendar-card {
            min-width: 70px !important;
            min-height: 90px !important;
            border-radius: 12px !important;
        }

        .calendar-card .text-lg {
            font-size: 1rem !important;
        }

        .calendar-card .text-xs {
            font-size: 0.6875rem !important;
        }

        /* Calendar nav buttons */
        .cal-nav button {
            width: 32px !important;
            height: 32px !important;
        }

        .cal-nav.prev {
            left: -4px !important;
        }

        .cal-nav.next {
            right: -4px !important;
        }

        /* Selected date display */
        #selectedDateDisplay {
            font-size: 0.8125rem !important;
        }

        /* Time slots mobile */
        #timeSlots {
            grid-template-columns: 1fr 1fr !important;
            gap: 0.5rem !important;
        }

        .time-slot {
            padding: 0.75rem !important;
            border-radius: 12px !important;
        }

        .time-slot .font-semibold {
            font-size: 0.875rem !important;
        }

        .time-slot .meta {
            font-size: 0.625rem !important;
        }

        /* Summary section mobile */
        .grid.grid-cols-1.md\\:grid-cols-3 {
            grid-template-columns: 1fr !important;
            gap: 0.75rem !important;
        }

        #bookingSummary>div {
            padding: 0.75rem !important;
        }

        #bookingSummary .text-sm {
            font-size: 0.75rem !important;
        }

        #bookingSummary .font-bold {
            font-size: 0.875rem !important;
        }

        /* Floating field mobile */
        .float-field>input,
        .float-field>textarea {
            font-size: 16px !important;
            padding: 0.875rem !important;
        }

        .float-field>label {
            font-size: 0.875rem !important;
        }

        /* Submit button mobile */
        #submitBtn {
            width: 100% !important;
            padding: 1rem !important;
            font-size: 1rem !important;
            border-radius: 1rem !important;
        }

        #submitBtn [data-lucide] {
            width: 1.125rem !important;
            height: 1.125rem !important;
        }

        /* CTA glow effect reduced on mobile */
        .cta-glow::after {
            filter: blur(8px) !important;
        }

        /* Notification mobile */
        .notification {
            top: 10px !important;
            right: 10px !important;
            left: 10px !important;
            padding: 0.875rem 1rem !important;
            font-size: 0.875rem !important;
        }

        /* Typography mobile */
        h3.text-xl {
            font-size: 1.125rem !important;
        }

        /* Icons sizing */
        [data-lucide] {
            width: 1rem !important;
            height: 1rem !important;
        }

        /* Spacing adjustments */
        .gap-8 {
            gap: 1.5rem !important;
        }

        .gap-6 {
            gap: 1rem !important;
        }

        .gap-4 {
            gap: 0.75rem !important;
        }

        .gap-3 {
            gap: 0.5rem !important;
        }

        .mb-6 {
            margin-bottom: 1rem !important;
        }

        .mt-8 {
            margin-top: 1.5rem !important;
        }
    }

    /* Small mobile (iPhone SE) */
    @media (max-width: 375px) {
        .glass.rounded-3xl {
            padding: 0.75rem !important;
        }

        h2.text-xl {
            font-size: 1rem !important;
        }

        .calendar-card {
            min-width: 60px !important;
            min-height: 80px !important;
        }

        #timeSlots {
            grid-template-columns: 1fr !important;
        }

        .service-card {
            padding: 0.75rem !important;
        }

        #submitBtn {
            padding: 0.875rem !important;
            font-size: 0.9375rem !important;
        }
    }

    /* Landscape mobile */
    @media (max-width: 768px) and (orientation: landscape) {
        .grid.grid-cols-1.lg\\:grid-cols-3 {
            grid-template-columns: repeat(2, 1fr) !important;
        }

        .glass.rounded-3xl {
            padding: 0.75rem !important;
        }

        .calendar-card {
            min-height: 75px !important;
        }
    }

    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {

        .service-card,
        .calendar-card,
        .time-slot,
        button {
            -webkit-tap-highlight-color: rgba(242, 139, 178, 0.2);
            cursor: pointer;
        }

        * {
            -webkit-overflow-scrolling: touch;
        }

        .service-card:active,
        .calendar-card:active,
        .time-slot:active {
            opacity: 0.9;
            transform: scale(0.98);
        }

        button:active {
            opacity: 0.9;
        }
    }

    /* iOS Safari fixes */
    @supports (-webkit-touch-callout: none) {

        input,
        select,
        textarea {
            font-size: max(16px, 1rem) !important;
        }

        .min-h-screen {
            min-height: -webkit-fill-available;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Beautiful animated background -->
<div id="three-bg"></div>

<div class="min-h-screen relative">
    <!-- Header -->
    <div class="sticky top-0 z-50 p-4">
        <div class="max-w-6xl mx-auto">
            <div class="flex items-center justify-between">
                <a href="{% url 'front_web:professional_detail' pro_id=pro_id %}"
                    class="glass px-4 py-2 rounded-xl flex items-center gap-2 text-gray-700 hover:bg-white/80 transition-all">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    Retour au profil
                </a>

            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 pb-8">
        <!-- Progress header -->
        <div class="glass rounded-3xl p-4 mb-6">
            <div class="steps">
                <div id="stepDot1" class="dot active"></div>
                <div class="w-16 h-1 bg-gray-200 rounded"></div>
                <div id="stepDot2" class="dot"></div>
                <div class="w-16 h-1 bg-gray-200 rounded"></div>
                <div id="stepDot3" class="dot"></div>
            </div>
        </div>
        <form method="POST" action="{% url 'front_web:book_appointment' pro_id=pro_id %}" id="bookingForm">
            {% csrf_token %}

            <!-- Hidden fields -->
            <input type="hidden" name="service_name" id="selectedServiceName" value="">
            <input type="hidden" name="service_price" id="selectedServicePrice" value="">
            <input type="hidden" name="service_duration" id="selectedServiceDuration" value="">
            <input type="hidden" name="appointment_date" id="selectedDate" value="">
            <input type="hidden" name="appointment_time" id="selectedTime" value="">

            <!-- Steps -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                <!-- Step 1: Service Selection -->
                <div class="glass rounded-3xl p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div
                            class="w-10 h-10 rounded-xl bg-gradient-to-r from-pink-400 to-blue-400 flex items-center justify-center text-white font-bold">
                            1
                        </div>
                        <h2 class="text-xl font-bold text-gray-900">Choisir le service</h2>
                    </div>

                    <div class="space-y-4">
                        {% for service in services_list %}
                        <div class="service-card glass rounded-2xl p-4 border-2 border-transparent" role="button"
                            tabindex="0"
                            aria-label="Service {{ service.name }} {{ service.duration }} minutes {{ service.price }} dinars"
                            data-name="{{ service.name }}" data-price="{{ service.price }}"
                            data-duration="{{ service.duration }}" onclick="toggleServiceSelectionFromCard(this)"
                            onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleServiceSelectionFromCard(this);}">
                            <div class="sel-check" aria-hidden="true">
                                <svg viewBox="0 0 24 24" width="16" height="16">
                                    <path fill="currentColor"
                                        d="M9 16.17l-3.88-3.88-1.41 1.41L9 19 20.29 7.71l-1.41-1.41z" />
                                </svg>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="font-semibold text-gray-900">{{ service.name }}</h3>
                                    <p class="text-sm text-gray-600">{{ service.duration }} minutes</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-lg font-bold text-rosePastel">{{ service.price }} DT</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Step 2: Date Selection -->
                <div class="glass rounded-3xl p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div
                            class="w-10 h-10 rounded-xl bg-gradient-to-r from-blue-400 to-purple-400 flex items-center justify-center text-white font-bold">
                            2
                        </div>
                        <h2 class="text-xl font-bold text-gray-900">Choisir la date</h2>
                    </div>

                    <!-- Horizontal Calendar Carousel -->
                    <div class="calendar-wrap mb-4">
                        <div class="cal-nav prev"><button type="button" aria-label="Dates pr√©c√©dentes"
                                onclick="scrollCalendar(-1)"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                        </div>
                        <div id="calendarTrack" class="calendar-track" role="listbox" aria-label="Dates disponibles"
                            tabindex="0"></div>
                        <div class="cal-nav next"><button type="button" aria-label="Dates suivantes"
                                onclick="scrollCalendar(1)"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                        </div>
                    </div>

                    <div class="text-center">
                        <span id="selectedDateDisplay" class="text-sm text-gray-600">S√©lectionnez une date</span>
                    </div>
                </div>

                <!-- Step 3: Time Selection -->
                <div class="glass rounded-3xl p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div
                            class="w-10 h-10 rounded-xl bg-gradient-to-r from-green-400 to-teal-400 flex items-center justify-center text-white font-bold">
                            3
                        </div>
                        <h2 class="text-xl font-bold text-gray-900">Choisir l'heure</h2>
                    </div>

                    <div id="timeSlots" class="grid grid-cols-2 gap-3" role="list" aria-label="Cr√©neaux horaires">
                        <div class="col-span-2 text-center text-gray-500 py-8">
                            Choisissez d'abord une date
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary & Submit -->
            <div class="glass rounded-3xl p-6 mt-8">
                <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i>
                    R√©sum√© de votre r√©servation
                </h3>

                <div id="bookingSummary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="text-center p-4 bg-gradient-to-r from-pink-50 to-blue-50 rounded-xl">
                        <div class="text-sm text-gray-600">Service</div>
                        <div class="font-bold text-gray-900" id="summaryService">Non s√©lectionn√©</div>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl">
                        <div class="text-sm text-gray-600">Date</div>
                        <div class="font-bold text-gray-900" id="summaryDate">Non s√©lectionn√©e</div>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-r from-green-50 to-teal-50 rounded-xl">
                        <div class="text-sm text-gray-600">Heure</div>
                        <div class="font-bold text-gray-900" id="summaryTime">Non s√©lectionn√©e</div>
                    </div>
                </div>

                <!-- Notes -->
                <div class="mb-6 float-field">
                    <textarea name="client_notes" aria-label="Notes additionnelles" rows="3" placeholder=" "
                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-pink-400 focus:border-transparent transition-all"></textarea>
                    <label><i data-lucide="message-circle" class="w-4 h-4 inline mr-1"></i> Notes additionnelles
                        (optionnel)</label>
                </div>

                <div class="flex justify-center items-center gap-4">
                    <a href="{% url 'front_web:client_calendar' %}" class="text-blue-600 underline text-sm">Voir mon
                        calendrier</a>
                    <a id="calendarAddLink" href="#" target="_blank"
                        class="hidden text-blue-600 underline mr-4 text-sm">Ajouter √† mon calendrier</a>
                    <button type="submit" id="submitBtn" disabled aria-label="Confirmer la r√©servation"
                        class="cta-glow text-white px-10 py-4 rounded-2xl font-semibold text-lg disabled:opacity-50 disabled:cursor-not-allowed hover:scale-105 transition-transform">
                        <i data-lucide="calendar-check" class="w-5 h-5 mr-2"></i>
                        Confirmer la demande
                    </button>
                </div>
            </div>
        </form>

        <!-- Success Modal -->
        <div id="successModal" class="modal-overlay">
            <div class="glass modal-card p-6">
                <div class="flex items-center gap-3 mb-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-gradient-to-r from-green-400 to-teal-400 flex items-center justify-center text-white">
                        <i data-lucide="check"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900">Votre demande a √©t√© envoy√©e</h3>
                </div>
                <p class="text-gray-600 mb-4">Le professionnel sera notifi√© pour confirmer votre rendez-vous.</p>
                <div id="successDetails" class="bg-gray-50 rounded-xl p-4 text-sm text-gray-700 mb-4"></div>
                <div class="flex justify-end gap-3">
                    <a href="{% url 'front_web:client_appointments' %}"
                        class="grad-btn text-white px-4 py-2 rounded-xl font-semibold">Voir mes rendez-vous</a>
                    <button type="button" onclick="closeSuccessModal()"
                        class="px-4 py-2 rounded-xl border border-gray-200">Fermer</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/lucide@latest"></script>
<script>
    // Initialize Lucide icons
    window.lucide && window.lucide.createIcons();

    let selectedServices = [];
    let selectedDate = null;
    let selectedTime = null;
    let pendingRestoreTime = null;
    let lastSlotsData = null; // Store last slots data for comparison

    const workingHours = "{{ working_hours }}";
    const workingDays = {{ working_days| safe }};

    // Notification system
    function showNotification(message, type = 'success') {
        // Remove existing notifications
        document.querySelectorAll('.notification').forEach(n => n.remove());

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <div class="flex items-center gap-2">
                <i data-lucide="${type === 'success' ? 'check-circle' : type === 'warning' ? 'alert-triangle' : 'x-circle'}" class="w-5 h-5"></i>
                <span>${message}</span>
            </div>
        `;

        document.body.appendChild(notification);
        window.lucide && window.lucide.createIcons();

        // Show notification
        setTimeout(() => {
            notification.classList.add('show');
        }, 100);

        // Auto-hide after 5 seconds
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 5000);
    }

    function parsePriceString(val) {
        const str = String(val ?? '').trim().replace(',', '.');
        const n = parseFloat(str);
        return Number.isFinite(n) ? n : 0;
    }

    // Toggle via data-* from card (robust parsing)
    function toggleServiceSelectionFromCard(card) {
        const name = String(card.dataset.name || '').trim();
        const price = parsePriceString(card.dataset.price);
        const duration = parseInt(card.dataset.duration || '0', 10) || 0;
        toggleServiceSelection({ currentTarget: card }, name, price, duration);
    }

    // Toggle service selection (multi-select)
    function toggleServiceSelection(ev, name, price, duration) {
        const card = ev.currentTarget;
        const idx = selectedServices.findIndex(s => s.name === name && s.duration === duration && s.price === price);
        if (idx >= 0) {
            selectedServices.splice(idx, 1);
            card.classList.remove('selected');
        } else {
            selectedServices.push({ name, price: Number(price), duration: Number(duration) });
            card.classList.add('selected');
        }

        // Compute totals
        const totalPrice = selectedServices.reduce((sum, s) => sum + parsePriceString(s.price), 0);
        const totalDuration = selectedServices.reduce((sum, s) => sum + (parseInt(s.duration || 0, 10) || 0), 0);
        const names = selectedServices.map(s => s.name).join(', ');

        // Update hidden fields (keep backward compat by sending aggregates)
        document.getElementById('selectedServiceName').value = names || '';
        document.getElementById('selectedServicePrice').value = String(totalPrice);
        document.getElementById('selectedServiceDuration').value = totalDuration || '';

        // Update summary
        const label = selectedServices.length > 0 ? `${selectedServices.length} service(s) ‚Äì ${parsePriceString(totalPrice).toFixed(0)} DT (${totalDuration} min)` : 'Non s√©lectionn√©';
        document.getElementById('summaryService').textContent = label;

        saveDraft();
        checkFormComplete();
        setActiveStep(1);
    }

    // Generate horizontal calendar
    function generateCalendar() {
        const track = document.getElementById('calendarTrack');
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();

        // Generate next 30 days as swipeable cards
        for (let i = 0; i < 30; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);

            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-card text-center cursor-pointer';
            dayDiv.setAttribute('role', 'option');
            dayDiv.dataset.date = date.toISOString().split('T')[0];

            const dayOfWeek = date.getDay();
            const dayName = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][dayOfWeek];

            // Check if it's a working day
            if (workingDays.includes(dayName)) {
                dayDiv.innerHTML = `
                    <div class="text-lg font-bold">${date.getDate()}</div>
                    <div class="text-xs ${i === 0 ? 'text-rosePastel' : 'text-gray-600'}">${date.toLocaleDateString('fr-FR', { month: 'short' })}</div>
                `;
                dayDiv.onclick = () => selectDate(date, dayDiv);
                dayDiv.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectDate(date, dayDiv); } };
            } else {
                dayDiv.classList.add('opacity-50');
                dayDiv.innerHTML = `
                    <div class="text-lg font-bold text-gray-400">${date.getDate()}</div>
                    <div class="text-xs text-gray-400">Ferm√©</div>
                `;
            }

            track.appendChild(dayDiv);
        }
    }

    // Scroll the calendar by cards
    function scrollCalendar(dir) {
        const track = document.getElementById('calendarTrack');
        const step = 6 * 98; // approx 6 cards width
        track.scrollBy({ left: dir * step, behavior: 'smooth' });
    }

    // Date selection
    function selectDate(date, element) {
        selectedDate = date;

        // Update UI
        document.querySelectorAll('.calendar-card').forEach(day => {
            day.classList.remove('selected');
            day.setAttribute('aria-selected', 'false');
        });
        element.classList.add('selected');
        element.setAttribute('aria-selected', 'true');

        // Update hidden field
        document.getElementById('selectedDate').value = date.toISOString().split('T')[0];

        // Update display
        document.getElementById('selectedDateDisplay').textContent = date.toLocaleDateString('fr-FR', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Update summary
        document.getElementById('summaryDate').textContent = date.toLocaleDateString('fr-FR');

        // Generate time slots
        generateTimeSlots();

        saveDraft();
        checkFormComplete();
        setActiveStep(2);
    }

    // Generate time slots with real-time availability
    async function generateTimeSlots() {
        const timeSlotsContainer = document.getElementById('timeSlots');
        timeSlotsContainer.innerHTML = '<div class="col-span-2 text-center text-gray-500 py-4">Chargement des cr√©neaux disponibles...</div>';

        if (!selectedDate) {
            timeSlotsContainer.innerHTML = '<div class="col-span-2 text-center text-gray-500 py-8">Choisissez d\'abord une date</div>';
            return;
        }

        const dateStr = selectedDate.toISOString().split('T')[0];
        const totalDuration = selectedServices.reduce((sum, s) => sum + Number(s.duration || 0), 0);

        try {
            const response = await fetch(`/professional/{{ pro_id }}/available-slots/?date=${dateStr}&duration=${totalDuration || 0}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error('Erreur lors du chargement des cr√©neaux');
            }

            const data = await response.json();

            // Check for changes in availability
            const currentSlotTimes = data.slots ? data.slots.map(s => s.time) : [];
            const lastSlotTimes = lastSlotsData ? lastSlotsData.map(s => s.time) : [];

            // Detect if selected time is no longer available
            if (selectedTime && !currentSlotTimes.includes(selectedTime)) {
                showNotification(`Le cr√©neau ${selectedTime} n'est plus disponible. Veuillez choisir un autre horaire.`, 'warning');
                selectedTime = null;
                document.getElementById('selectedTime').value = '';
                document.getElementById('summaryTime').textContent = 'Non s√©lectionn√©e';
                checkFormComplete();
            }

            // Detect new slots
            if (lastSlotsData && currentSlotTimes.length > lastSlotTimes.length) {
                const newSlots = currentSlotTimes.filter(time => !lastSlotTimes.includes(time));
                if (newSlots.length > 0) {
                    showNotification(`${newSlots.length} nouveau(x) cr√©neau(x) disponible(s)!`, 'success');
                }
            }

            // Store current data for next comparison
            lastSlotsData = data.slots ? [...data.slots] : null;

            timeSlotsContainer.innerHTML = '';

            if (data.slots && data.slots.length > 0) {
                // Group by hour for compact view
                const groups = {};
                data.slots.forEach(s => {
                    const [h, m] = s.time.split(':');
                    if (!groups[h]) groups[h] = [];
                    groups[h].push(s);
                });

                const hours = Object.keys(groups).sort((a, b) => parseInt(a) - parseInt(b));
                hours.forEach(h => {
                    const list = groups[h];
                    const firstAvail = list.find(x => (x.status || 'available') === 'available');
                    const hourStatus = firstAvail ? 'available' : (list.some(x => x.status === 'pending') ? 'pending' : 'reserved');

                    const el = document.createElement('div');
                    el.className = 'time-slot glass p-3 text-center border transition-all relative';
                    if (hourStatus === 'available') el.classList.add('cursor-pointer', 'border-gray-200', 'hover:border-green-300');
                    else if (hourStatus === 'pending') el.classList.add('pending', 'border-yellow-200');
                    else el.classList.add('disabled', 'border-gray-200');

                    el.setAttribute('role', 'button');
                    el.setAttribute('tabindex', '0');
                    el.innerHTML = `<div class="font-semibold">${h}:00</div>`;

                    // Hover panel with quarter-hour details
                    const panel = document.createElement('div');
                    panel.className = 'absolute left-1/2 -translate-x-1/2 top-full mt-2 z-20 hidden bg-white border border-gray-200 rounded-xl shadow-lg p-2 text-sm min-w-[160px]';
                    panel.innerHTML = list.map(s => {
                        const st = s.status || 'available';
                        const color = st === 'available' ? 'text-green-600' : (st === 'pending' ? 'text-yellow-700' : 'text-gray-500');
                        const icon = st === 'available' ? 'check-circle' : (st === 'pending' ? 'hourglass' : 'x-circle');
                        return `<div class="flex items-center gap-2 ${color}"><i data-lucide="${icon}" class="w-3 h-3"></i>${s.time}</div>`;
                    }).join('');
                    el.appendChild(panel);

                    el.addEventListener('mouseenter', () => { panel.classList.remove('hidden'); window.lucide && window.lucide.createIcons(); });
                    el.addEventListener('mouseleave', () => panel.classList.add('hidden'));

                    if (firstAvail) {
                        el.onclick = () => selectTime(firstAvail.time, el);
                        el.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectTime(firstAvail.time, el); } };
                    }

                    timeSlotsContainer.appendChild(el);
                });

                // Attempt to restore previously selected time
                if (pendingRestoreTime) {
                    const toSelect = Array.from(document.querySelectorAll('#timeSlots .time-slot'))
                        .find(el => el.querySelector('.font-semibold')?.textContent === pendingRestoreTime);
                    if (toSelect) {
                        toSelect.click();
                        pendingRestoreTime = null;
                    }
                }

                // Re-initialize Lucide icons
                window.lucide && window.lucide.createIcons();
            } else {
                timeSlotsContainer.innerHTML = `
                    <div class="col-span-2 text-center text-gray-500 py-8">
                        <i data-lucide="calendar-x" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                        <p>Aucun cr√©neau disponible pour cette date</p>
                        <p class="text-sm mt-1">${data.message || 'Essayez une autre date'}</p>
                    </div>
                `;
                window.lucide && window.lucide.createIcons();
            }
        } catch (error) {
            console.error('Erreur:', error);
            timeSlotsContainer.innerHTML = `
                <div class="col-span-2 text-center text-red-500 py-8">
                    <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-2"></i>
                    <p>Erreur lors du chargement des cr√©neaux</p>
                    <button onclick="generateTimeSlots()" class="text-sm text-blue-500 hover:text-blue-700 mt-2">
                        R√©essayer
                    </button>
                </div>
            `;
            window.lucide && window.lucide.createIcons();
        }
    }

    // Time selection
    function selectTime(time, element) {
        selectedTime = time;

        // Update UI
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.classList.remove('selected');
        });
        element.classList.add('selected');

        // Update hidden field
        document.getElementById('selectedTime').value = time;

        // Update summary
        document.getElementById('summaryTime').textContent = time;

        saveDraft();
        checkFormComplete();
        setActiveStep(3);
    }

    // Check if form is complete
    function checkFormComplete() {
        const submitBtn = document.getElementById('submitBtn');
        const calLink = document.getElementById('calendarAddLink');
        const hasServices = (selectedServices && selectedServices.length > 0);
        if (hasServices && selectedDate && selectedTime) {
            submitBtn.disabled = false;
            updateProgress(3);
            // Build Google Calendar link
            try {
                const start = new Date(selectedDate);
                const [h, m] = (selectedTime || '09:00').split(':');
                start.setHours(parseInt(h || '9'), parseInt(m || '0'));
                const totalDuration = selectedServices.reduce((sum, s) => sum + Number(s.duration || 0), 0) || 60;
                const end = new Date(start.getTime() + totalDuration * 60000);
                function fmt(d) {
                    const pad = (n) => String(n).padStart(2, '0');
                    return `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())}T${pad(d.getHours())}${pad(d.getMinutes())}00`;
                }
                const text = encodeURIComponent(`Rdv ${selectedServices.map(s => s.name).join(', ')}`);
                const details = encodeURIComponent('R√©serv√© via Coucou Beaut√©');
                const location = encodeURIComponent('{{ pro.business_name|default:pro.user.get_full_name }}');
                const dates = `${fmt(start)}/${fmt(end)}`;
                const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&details=${details}&location=${location}&dates=${dates}`;
                calLink.href = url;
                calLink.classList.remove('hidden');
            } catch (_) { calLink.classList.add('hidden'); }
        } else {
            submitBtn.disabled = true;
            if (hasServices && selectedDate) updateProgress(2); else if (hasServices) updateProgress(1); else updateProgress(0);
            document.getElementById('calendarAddLink')?.classList.add('hidden');
        }
    }

    function updateProgress(step) {
        const d1 = document.getElementById('stepDot1');
        const d2 = document.getElementById('stepDot2');
        const d3 = document.getElementById('stepDot3');
        if (!d1 || !d2 || !d3) return;
        d1.classList.toggle('active', step >= 1);
        d2.classList.toggle('active', step >= 2);
        d3.classList.toggle('active', step >= 3);
    }

    function setActiveStep(step) {
        try {
            const cards = Array.from(document.querySelectorAll('.grid.grid-cols-1.lg\\:grid-cols-3 > .glass.rounded-3xl'));
            cards.forEach((c, i) => c.classList.toggle('step-active', (i + 1) === step));
        } catch (_) { }
    }

    // Auto-refresh function to keep slots synchronized
    function autoRefreshSlots() {
        if (selectedDate) {
            generateTimeSlots();
        }
    }

    // Refresh slots every 30 seconds when a date is selected
    let refreshInterval = null;
    function startAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
        refreshInterval = setInterval(autoRefreshSlots, 30000); // 30 seconds
    }

    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
    }

    // Update selectDate function to include auto-refresh
    const originalSelectDate = selectDate;
    selectDate = function (date, element) {
        originalSelectDate(date, element);
        startAutoRefresh(); // Start auto-refresh when date is selected
    };

    // Add visibility change listener to refresh when user comes back to tab
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden && selectedDate) {
            generateTimeSlots(); // Refresh immediately when tab becomes visible
        }
    });

    // Draft saving
    function saveDraft() {
        try {
            const draft = {
                services: selectedServices.map(s => ({ name: s.name, price: s.price, duration: s.duration })),
                date: selectedDate ? selectedDate.toISOString().split('T')[0] : null,
                time: selectedTime || null,
            };
            localStorage.setItem('bookingDraft', JSON.stringify(draft));
        } catch (_) { }
    }

    function restoreDraft() {
        try {
            const raw = localStorage.getItem('bookingDraft');
            if (!raw) return;
            const d = JSON.parse(raw);
            if (Array.isArray(d.services)) {
                d.services.forEach(s => {
                    const card = Array.from(document.querySelectorAll('.service-card'))
                        .find(el => el.dataset.name === s.name);
                    if (card) { toggleServiceSelectionFromCard(card); }
                });
            }
            if (d.date) {
                const card = Array.from(document.querySelectorAll('#calendarTrack .calendar-card')).find(el => el.dataset.date === d.date);
                if (card) {
                    const dateObj = new Date(d.date);
                    selectDate(dateObj, card);
                }
            }
            if (d.time) { pendingRestoreTime = d.time; }
        } catch (_) { }
    }

    // Initialize calendar on page load
    document.addEventListener('DOMContentLoaded', () => {
        generateCalendar();
        restoreDraft();
        updateProgress(0);
        setActiveStep(1);
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
        stopAutoRefresh();
    });

    // Form submit feedback
    function openSuccessModal(detailsHtml) {
        const m = document.getElementById('successModal');
        const box = document.getElementById('successDetails');
        if (box) box.innerHTML = detailsHtml || '';
        m.classList.add('show');
    }

    function closeSuccessModal() {
        document.getElementById('successModal')?.classList.remove('show');
    }

    document.getElementById('bookingForm')?.addEventListener('submit', async function (e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        if (btn && !btn.classList.contains('loading')) {
            btn.classList.add('loading');
            btn.insertAdjacentHTML('afterbegin', '<span class="spinner" aria-hidden="true"></span>');
        }

        // Validate minimal requirements again
        const hasServices = (selectedServices && selectedServices.length > 0);
        if (!hasServices || !selectedDate || !selectedTime) {
            showNotification('Veuillez s√©lectionner au moins un service, une date et une heure.', 'warning');
            btn?.classList.remove('loading');
            btn?.querySelector('.spinner')?.remove();
            return;
        }

        try {
            const form = e.target;
            const fd = new FormData(form);
            // Ensure hidden fields are up to date
            const totalPrice = selectedServices.reduce((sum, s) => sum + parsePriceString(s.price), 0);
            const totalDuration = selectedServices.reduce((sum, s) => sum + (parseInt(s.duration || 0, 10) || 0), 0);
            fd.set('service_price', String(totalPrice));
            fd.set('service_duration', String(totalDuration));
            fd.set('service_name', selectedServices.map(s => s.name).join(', '));

            const csrf = form.querySelector('input[name="csrfmiddlewaretoken"]').value;
            const res = await fetch(form.action, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrf },
                body: fd,
                credentials: 'include'
            });

            if (res.ok) {
                let data = null;
                try { data = await res.json(); } catch (_) { }
                const names = selectedServices.map(s => s.name).join(', ');
                const totalDuration = selectedServices.reduce((sum, s) => sum + (parseInt(s.duration || 0, 10) || 0), 0);
                const totalPrice = selectedServices.reduce((sum, s) => sum + (Number(s.price) || 0), 0);
                const html = `
                    <div class="grid grid-cols-1 gap-2">
                        <div><span class="font-semibold">Service(s):</span> ${names} (${totalDuration} min ‚Äî ${totalPrice.toFixed(0)} DT)</div>
                        <div><span class="font-semibold">Date:</span> ${selectedDate.toLocaleDateString('fr-FR')}</div>
                        <div><span class="font-semibold">Heure:</span> ${selectedTime}</div>
                        <div class="text-gray-500 text-xs">Statut: en attente de confirmation du professionnel</div>
                    </div>`;
                openSuccessModal(html);
            } else {
                let err = null; try { err = await res.json(); } catch (_) { }
                showNotification(err?.error || 'Erreur lors de la r√©servation', 'error');
            }
        } catch (ex) {
            console.error(ex);
            showNotification('Erreur r√©seau. Veuillez r√©essayer.', 'error');
        } finally {
            btn?.classList.remove('loading');
            btn?.querySelector('.spinner')?.remove();
        }
    });
</script>
{% endblock %}