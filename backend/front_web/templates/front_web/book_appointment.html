{% extends 'front_web/base_client.html' %}
{% load static %}
{% block title %}Prendre rendez-vous - {{ pro.business_name|default:pro.user.get_full_name }} - Coucou
Beaut√©{%endblock%}



{% block extra_css %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    body {
        font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial;
    }

    /* Ultra-modern animated gradient background */
    #three-bg {
        position: fixed;
        inset: 0;
        z-index: -1;
        background: radial-gradient(1200px 800px at 20% 10%, rgba(242, 139, 178, 0.25), transparent 60%),
            radial-gradient(1200px 800px at 80% 30%, rgba(108, 169, 224, 0.25), transparent 60%),
            linear-gradient(135deg, #3a1c71 0%, #d76d77 50%, #6eacd8 100%);
        overflow: hidden;
    }

    #three-bg::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(242, 139, 178, 0.1) 0%, transparent 70%);
        animation: float 20s ease-in-out infinite;
    }

    #three-bg::after {
        content: '';
        position: absolute;
        bottom: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(108, 169, 224, 0.1) 0%, transparent 70%);
        animation: float 25s ease-in-out infinite reverse;
    }

    @keyframes float {

        0%,
        100% {
            transform: translate(0, 0) rotate(0deg);
        }

        33% {
            transform: translate(30px, -30px) rotate(120deg);
        }

        66% {
            transform: translate(-20px, 20px) rotate(240deg);
        }
    }

    .grad-btn {
        background: linear-gradient(90deg, #F28BB2 0%, #6CA9E0 100%);
    }

    .glass {
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.92), rgba(255, 255, 255, 0.82));
        box-shadow: 0 18px 48px rgba(16, 24, 40, 0.18);
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 18px;
    }

    .text-rosePastel {
        color: #F28BB2;
    }

    .text-blueLight {
        color: #6CA9E0;
    }

    /* Horizontal swipeable calendar carousel */
    .calendar-wrap {
        position: relative;
        perspective: 800px;
    }

    .calendar-track {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        padding-bottom: 6px;
        -webkit-overflow-scrolling: touch;
    }

    .calendar-card {
        scroll-snap-align: start;
        min-width: 86px;
        min-height: 110px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(226, 232, 240, 0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
        transform-style: preserve-3d;
    }

    .calendar-card:hover {
        transform: translateY(-3px) rotateX(6deg);
        box-shadow: 0 18px 38px rgba(108, 169, 224, 0.28);
    }

    .calendar-card[aria-selected="true"],
    .calendar-card.selected {
        background: linear-gradient(135deg, #F28BB2 0%, #6CA9E0 100%);
        color: #fff;
        border-color: transparent;
        box-shadow: 0 14px 32px rgba(242, 139, 178, 0.35);
        transform: translateY(-2px) rotateX(0);
    }

    .cal-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 5;
    }

    .cal-nav button {
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(255, 255, 255, 0.6);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        box-shadow: 0 10px 24px rgba(16, 24, 40, .18);
    }

    .cal-nav.prev {
        left: -8px;
    }

    .cal-nav.next {
        right: -8px;
    }

    /* Time slots as interactive cards */
    .time-slot {
        transition: all 0.25s ease;
        border-radius: 14px;
    }

    .time-slot:hover {
        transform: translateY(-3px);
        box-shadow: 0 14px 30px rgba(16, 24, 40, .15);
    }

    .time-slot .meta {
        opacity: 0;
        transform: translateY(6px);
        transition: .2s ease;
        font-size: 11px;
    }

    .time-slot:hover .meta {
        opacity: 1;
        transform: translateY(0);
    }

    .time-slot.selected {
        background: linear-gradient(90deg, #F28BB2 0%, #6CA9E0 100%);
        color: #fff;
        border-color: transparent;
    }

    .service-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .service-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 35px rgba(108, 169, 224, 0.25);
    }

    .service-card.selected {
        border-color: #F28BB2;
        background: linear-gradient(135deg, rgba(242, 139, 178, 0.1) 0%, rgba(108, 169, 224, 0.1) 100%);
    }

    /* Notification styles */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        padding: 16px 24px;
        border-radius: 12px;
        font-weight: 500;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    }

    .notification.show {
        transform: translateX(0);
    }

    .notification.success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .notification.warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }

    .notification.error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }

    /* Pulse animation for updated slots */
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
        }
    }

    .time-slot.updated {
        animation: pulse 1s ease-out;
    }

    /* Floating label form control */
    .float-field {
        position: relative;
    }

    .float-field>input,
    .float-field>textarea {
        width: 100%;
        padding: 14px 14px 14px 12px;
        border-radius: 12px;
        border: 1px solid rgba(226, 232, 240, 1);
        background: rgba(255, 255, 255, 0.9);
        transition: border-color .2s ease, box-shadow .2s ease;
    }

    .float-field>label {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6B7280;
        pointer-events: none;
        transition: .2s ease;
        background: transparent;
        padding: 0 4px;
    }

    .float-field>input:focus,
    .float-field>textarea:focus {
        outline: none;
        border-color: #F28BB2;
        box-shadow: 0 0 0 3px rgba(242, 139, 178, 0.15);
    }

    .float-field>input:not(:placeholder-shown)+label,
    .float-field>textarea:not(:placeholder-shown)+label,
    .float-field>input:focus+label,
    .float-field>textarea:focus+label {
        top: 0;
        transform: translateY(-50%) scale(.85);
        color: #F28BB2;
        background: #fff;
        border-radius: 6px;
    }

    /* CTA glowing button */
    .cta-glow {
        position: relative;
        isolation: isolate;
        background: linear-gradient(90deg, #F28BB2, #6CA9E0);
        box-shadow: 0 10px 30px rgba(242, 139, 178, .35), inset 0 0 0 1px rgba(255, 255, 255, .4);
    }

    .cta-glow::after {
        content: '';
        position: absolute;
        inset: -8px;
        z-index: -1;
        filter: blur(16px);
        background: radial-gradient(closest-side, rgba(242, 139, 178, .45), transparent), radial-gradient(closest-side, rgba(108, 169, 224, .45), transparent);
        opacity: .8;
        animation: glow 2.4s ease-in-out infinite alternate;
    }

    @keyframes glow {
        from {
            opacity: .6;
            transform: scale(.98);
        }

        to {
            opacity: 1;
            transform: scale(1.02);
        }
    }

    /* Steps progress indicator */
    .steps {
        display: grid;
        grid-auto-flow: column;
        gap: 10px;
        align-items: center;
    }

    .steps .dot {
        width: 10px;
        height: 10px;
        border-radius: 9999px;
        background: #e5e7eb;
        transition: .2s;
    }

    .steps .dot.active {
        background: linear-gradient(135deg, #F28BB2, #6CA9E0);
        box-shadow: 0 0 0 4px rgba(242, 139, 178, .15);
    }

    /* ==========================
       RESPONSIVE MOBILE OPTIMIZATIONS
       ========================== */
    @media (max-width: 768px) {

        /* Disable background on mobile */
        #three-bg,
        #three-bg::before,
        #three-bg::after {
            display: none !important;
        }

        /* Mobile body */
        body {
            font-size: 16px !important;
            -webkit-text-size-adjust: 100%;
        }

        /* Sticky header mobile */
        .sticky.top-0 {
            padding: 0.75rem 1rem !important;
        }

        .glass.px-4 {
            padding: 0.75rem 1rem !important;
            font-size: 0.875rem !important;
        }

        /* Container mobile */
        .max-w-6xl {
            padding: 0 1rem !important;
        }

        .pb-8 {
            padding-bottom: 1.5rem !important;
        }

        /* Steps grid to single column */
        .grid.grid-cols-1.lg\\:grid-cols-3 {
            grid-template-columns: 1fr !important;
            gap: 1.5rem !important;
        }

        /* Step cards mobile */
        .glass.rounded-3xl {
            padding: 1rem !important;
            border-radius: 1.5rem !important;
        }

        /* Step header mobile */
        .w-10.h-10 {
            width: 2.5rem !important;
            height: 2.5rem !important;
        }

        h2.text-xl {
            font-size: 1.125rem !important;
        }

        /* Service cards mobile */
        .service-card {
            padding: 0.875rem !important;
        }

        .service-card h3 {
            font-size: 0.9375rem !important;
        }

        .service-card .text-sm {
            font-size: 0.8125rem !important;
        }

        .service-card .text-lg {
            font-size: 1rem !important;
        }

        /* Calendar mobile */
        .calendar-wrap {
            margin: 0 -0.5rem !important;
        }

        .calendar-track {
            gap: 8px !important;
            padding: 0 0.5rem 6px !important;
        }

        .calendar-card {
            min-width: 70px !important;
            min-height: 90px !important;
            border-radius: 12px !important;
        }

        .calendar-card .text-lg {
            font-size: 1rem !important;
        }

        .calendar-card .text-xs {
            font-size: 0.6875rem !important;
        }

        /* Calendar nav buttons */
        .cal-nav button {
            width: 32px !important;
            height: 32px !important;
        }

        .cal-nav.prev {
            left: -4px !important;
        }

        .cal-nav.next {
            right: -4px !important;
        }

        /* Selected date display */
        #selectedDateDisplay {
            font-size: 0.8125rem !important;
        }

        /* Time slots mobile */
        #timeSlots {
            grid-template-columns: 1fr 1fr !important;
            gap: 0.5rem !important;
        }

        .time-slot {
            padding: 0.75rem !important;
            border-radius: 12px !important;
        }

        .time-slot .font-semibold {
            font-size: 0.875rem !important;
        }

        .time-slot .meta {
            font-size: 0.625rem !important;
        }

        /* Summary section mobile */
        .grid.grid-cols-1.md\\:grid-cols-3 {
            grid-template-columns: 1fr !important;
            gap: 0.75rem !important;
        }

        #bookingSummary>div {
            padding: 0.75rem !important;
        }

        #bookingSummary .text-sm {
            font-size: 0.75rem !important;
        }

        #bookingSummary .font-bold {
            font-size: 0.875rem !important;
        }

        /* Floating field mobile */
        .float-field>input,
        .float-field>textarea {
            font-size: 16px !important;
            padding: 0.875rem !important;
        }

        .float-field>label {
            font-size: 0.875rem !important;
        }

        /* Submit button mobile */
        #submitBtn {
            width: 100% !important;
            padding: 1rem !important;
            font-size: 1rem !important;
            border-radius: 1rem !important;
        }

        #submitBtn [data-lucide] {
            width: 1.125rem !important;
            height: 1.125rem !important;
        }

        /* CTA glow effect reduced on mobile */
        .cta-glow::after {
            filter: blur(8px) !important;
        }

        /* Notification mobile */
        .notification {
            top: 10px !important;
            right: 10px !important;
            left: 10px !important;
            padding: 0.875rem 1rem !important;
            font-size: 0.875rem !important;
        }

        /* Typography mobile */
        h3.text-xl {
            font-size: 1.125rem !important;
        }

        /* Icons sizing */
        [data-lucide] {
            width: 1rem !important;
            height: 1rem !important;
        }

        /* Spacing adjustments */
        .gap-8 {
            gap: 1.5rem !important;
        }

        .gap-6 {
            gap: 1rem !important;
        }

        .gap-4 {
            gap: 0.75rem !important;
        }

        .gap-3 {
            gap: 0.5rem !important;
        }

        .mb-6 {
            margin-bottom: 1rem !important;
        }

        .mt-8 {
            margin-top: 1.5rem !important;
        }
    }

    /* Small mobile (iPhone SE) */
    @media (max-width: 375px) {
        .glass.rounded-3xl {
            padding: 0.75rem !important;
        }

        h2.text-xl {
            font-size: 1rem !important;
        }

        .calendar-card {
            min-width: 60px !important;
            min-height: 80px !important;
        }

        #timeSlots {
            grid-template-columns: 1fr !important;
        }

        .service-card {
            padding: 0.75rem !important;
        }

        #submitBtn {
            padding: 0.875rem !important;
            font-size: 0.9375rem !important;
        }
    }

    /* Landscape mobile */
    @media (max-width: 768px) and (orientation: landscape) {
        .grid.grid-cols-1.lg\\:grid-cols-3 {
            grid-template-columns: repeat(2, 1fr) !important;
        }

        .glass.rounded-3xl {
            padding: 0.75rem !important;
        }

        .calendar-card {
            min-height: 75px !important;
        }
    }

    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {

        .service-card,
        .calendar-card,
        .time-slot,
        button {
            -webkit-tap-highlight-color: rgba(242, 139, 178, 0.2);
            cursor: pointer;
        }

        * {
            -webkit-overflow-scrolling: touch;
        }

        .service-card:active,
        .calendar-card:active,
        .time-slot:active {
            opacity: 0.9;
            transform: scale(0.98);
        }

        button:active {
            opacity: 0.9;
        }
    }

    /* iOS Safari fixes */
    @supports (-webkit-touch-callout: none) {

        input,
        select,
        textarea {
            font-size: max(16px, 1rem) !important;
        }

        .min-h-screen {
            min-height: -webkit-fill-available;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Beautiful animated background -->
<div id="three-bg"></div>

<div class="min-h-screen relative">
    <!-- Header -->
    <div class="sticky top-0 z-50 p-4">
        <div class="max-w-6xl mx-auto">
            <div class="flex items-center justify-between">
                <a href="{% url 'front_web:professional_detail' pro_id=pro_id %}"
                    class="glass px-4 py-2 rounded-xl flex items-center gap-2 text-gray-700 hover:bg-white/80 transition-all">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    Retour au profil
                </a>

            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 pb-8">
        <form method="POST" action="{% url 'front_web:book_appointment' pro_id=pro_id %}" id="bookingForm">
            {% csrf_token %}

            <!-- Hidden fields -->
            <input type="hidden" name="service_name" id="selectedServiceName" value="">
            <input type="hidden" name="service_price" id="selectedServicePrice" value="">
            <input type="hidden" name="service_duration" id="selectedServiceDuration" value="">
            <input type="hidden" name="appointment_date" id="selectedDate" value="">
            <input type="hidden" name="appointment_time" id="selectedTime" value="">

            <!-- Steps -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                <!-- Step 1: Service Selection -->
                <div class="glass rounded-3xl p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div
                            class="w-10 h-10 rounded-xl bg-gradient-to-r from-pink-400 to-blue-400 flex items-center justify-center text-white font-bold">
                            1
                        </div>
                        <h2 class="text-xl font-bold text-gray-900">Choisir le service</h2>
                    </div>

                    <div class="space-y-4">
                        {% for service in services_list %}
                        <div class="service-card glass rounded-2xl p-4 border-2 border-transparent" role="button"
                            tabindex="0"
                            aria-label="Service {{ service.name }} {{ service.duration }} minutes {{ service.price }} dinars"
                            onclick="selectService('{{ service.name }}', {{ service.price }}, {{ service.duration }})"
                            onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();selectService('{{ service.name }}', {{ service.price }}, {{ service.duration }});}">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="font-semibold text-gray-900">{{ service.name }}</h3>
                                    <p class="text-sm text-gray-600">{{ service.duration }} minutes</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-lg font-bold text-rosePastel">{{ service.price }} DT</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Step 2: Date Selection -->
                <div class="glass rounded-3xl p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div
                            class="w-10 h-10 rounded-xl bg-gradient-to-r from-blue-400 to-purple-400 flex items-center justify-center text-white font-bold">
                            2
                        </div>
                        <h2 class="text-xl font-bold text-gray-900">Choisir la date</h2>
                    </div>

                    <!-- Horizontal Calendar Carousel -->
                    <div class="calendar-wrap mb-4">
                        <div class="cal-nav prev"><button type="button" aria-label="Dates pr√©c√©dentes"
                                onclick="scrollCalendar(-1)"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                        </div>
                        <div id="calendarTrack" class="calendar-track" role="listbox" aria-label="Dates disponibles"
                            tabindex="0"></div>
                        <div class="cal-nav next"><button type="button" aria-label="Dates suivantes"
                                onclick="scrollCalendar(1)"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                        </div>
                    </div>

                    <div class="text-center">
                        <span id="selectedDateDisplay" class="text-sm text-gray-600">S√©lectionnez une date</span>
                    </div>
                </div>

                <!-- Step 3: Time Selection -->
                <div class="glass rounded-3xl p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div
                            class="w-10 h-10 rounded-xl bg-gradient-to-r from-green-400 to-teal-400 flex items-center justify-center text-white font-bold">
                            3
                        </div>
                        <h2 class="text-xl font-bold text-gray-900">Choisir l'heure</h2>
                    </div>

                    <div id="timeSlots" class="grid grid-cols-2 gap-3" role="list" aria-label="Cr√©neaux horaires">
                        <div class="col-span-2 text-center text-gray-500 py-8">
                            Choisissez d'abord une date
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary & Submit -->
            <div class="glass rounded-3xl p-6 mt-8">
                <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i>
                    R√©sum√© de votre r√©servation
                </h3>

                <div id="bookingSummary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="text-center p-4 bg-gradient-to-r from-pink-50 to-blue-50 rounded-xl">
                        <div class="text-sm text-gray-600">Service</div>
                        <div class="font-bold text-gray-900" id="summaryService">Non s√©lectionn√©</div>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl">
                        <div class="text-sm text-gray-600">Date</div>
                        <div class="font-bold text-gray-900" id="summaryDate">Non s√©lectionn√©e</div>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-r from-green-50 to-teal-50 rounded-xl">
                        <div class="text-sm text-gray-600">Heure</div>
                        <div class="font-bold text-gray-900" id="summaryTime">Non s√©lectionn√©e</div>
                    </div>
                </div>

                <!-- Notes -->
                <div class="mb-6 float-field">
                    <textarea name="client_notes" aria-label="Notes additionnelles" rows="3" placeholder=" "
                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-pink-400 focus:border-transparent transition-all"></textarea>
                    <label><i data-lucide="message-circle" class="w-4 h-4 inline mr-1"></i> Notes additionnelles
                        (optionnel)</label>
                </div>

                <div class="flex justify-center">
                    <button type="submit" id="submitBtn" disabled aria-label="Confirmer la r√©servation"
                        class="cta-glow text-white px-10 py-4 rounded-2xl font-semibold text-lg disabled:opacity-50 disabled:cursor-not-allowed hover:scale-105 transition-transform">
                        <i data-lucide="calendar-check" class="w-5 h-5 mr-2"></i>
                        Confirmer la demande
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/lucide@latest"></script>
<script>
    // Initialize Lucide icons
    window.lucide && window.lucide.createIcons();

    let selectedService = null;
    let selectedDate = null;
    let selectedTime = null;
    let lastSlotsData = null; // Store last slots data for comparison

    const workingHours = "{{ working_hours }}";
    const workingDays = {{ working_days| safe }};

    // Notification system
    function showNotification(message, type = 'success') {
        // Remove existing notifications
        document.querySelectorAll('.notification').forEach(n => n.remove());

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <div class="flex items-center gap-2">
                <i data-lucide="${type === 'success' ? 'check-circle' : type === 'warning' ? 'alert-triangle' : 'x-circle'}" class="w-5 h-5"></i>
                <span>${message}</span>
            </div>
        `;

        document.body.appendChild(notification);
        window.lucide && window.lucide.createIcons();

        // Show notification
        setTimeout(() => {
            notification.classList.add('show');
        }, 100);

        // Auto-hide after 5 seconds
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 5000);
    }

    // Service selection
    function selectService(name, price, duration) {
        selectedService = { name, price, duration };

        // Update UI
        document.querySelectorAll('.service-card').forEach(card => {
            card.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');

        // Update hidden fields
        document.getElementById('selectedServiceName').value = name;
        document.getElementById('selectedServicePrice').value = price;
        document.getElementById('selectedServiceDuration').value = duration;

        // Update summary
        document.getElementById('summaryService').textContent = `${name} - ${price} DT`;

        checkFormComplete();
    }

    // Generate horizontal calendar
    function generateCalendar() {
        const track = document.getElementById('calendarTrack');
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();

        // Generate next 30 days as swipeable cards
        for (let i = 0; i < 30; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);

            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-card text-center cursor-pointer';
            dayDiv.setAttribute('role', 'option');

            const dayOfWeek = date.getDay();
            const dayName = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][dayOfWeek];

            // Check if it's a working day
            if (workingDays.includes(dayName)) {
                dayDiv.innerHTML = `
                    <div class="text-lg font-bold">${date.getDate()}</div>
                    <div class="text-xs ${i === 0 ? 'text-rosePastel' : 'text-gray-600'}">${date.toLocaleDateString('fr-FR', { month: 'short' })}</div>
                `;
                dayDiv.onclick = () => selectDate(date, dayDiv);
                dayDiv.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectDate(date, dayDiv); } };
            } else {
                dayDiv.classList.add('opacity-50');
                dayDiv.innerHTML = `
                    <div class="text-lg font-bold text-gray-400">${date.getDate()}</div>
                    <div class="text-xs text-gray-400">Ferm√©</div>
                `;
            }

            track.appendChild(dayDiv);
        }
    }

    // Scroll the calendar by cards
    function scrollCalendar(dir) {
        const track = document.getElementById('calendarTrack');
        const step = 6 * 98; // approx 6 cards width
        track.scrollBy({ left: dir * step, behavior: 'smooth' });
    }

    // Date selection
    function selectDate(date, element) {
        selectedDate = date;

        // Update UI
        document.querySelectorAll('.calendar-card').forEach(day => {
            day.classList.remove('selected');
            day.setAttribute('aria-selected', 'false');
        });
        element.classList.add('selected');
        element.setAttribute('aria-selected', 'true');

        // Update hidden field
        document.getElementById('selectedDate').value = date.toISOString().split('T')[0];

        // Update display
        document.getElementById('selectedDateDisplay').textContent = date.toLocaleDateString('fr-FR', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Update summary
        document.getElementById('summaryDate').textContent = date.toLocaleDateString('fr-FR');

        // Generate time slots
        generateTimeSlots();

        checkFormComplete();
    }

    // Generate time slots with real-time availability
    async function generateTimeSlots() {
        const timeSlotsContainer = document.getElementById('timeSlots');
        timeSlotsContainer.innerHTML = '<div class="col-span-2 text-center text-gray-500 py-4">Chargement des cr√©neaux disponibles...</div>';

        if (!selectedDate) {
            timeSlotsContainer.innerHTML = '<div class="col-span-2 text-center text-gray-500 py-8">Choisissez d\'abord une date</div>';
            return;
        }

        const dateStr = selectedDate.toISOString().split('T')[0];

        try {
            const response = await fetch(`/professional/{{ pro_id }}/available-slots/?date=${dateStr}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error('Erreur lors du chargement des cr√©neaux');
            }

            const data = await response.json();

            // Check for changes in availability
            const currentSlotTimes = data.slots ? data.slots.map(s => s.time) : [];
            const lastSlotTimes = lastSlotsData ? lastSlotsData.map(s => s.time) : [];

            // Detect if selected time is no longer available
            if (selectedTime && !currentSlotTimes.includes(selectedTime)) {
                showNotification(`Le cr√©neau ${selectedTime} n'est plus disponible. Veuillez choisir un autre horaire.`, 'warning');
                selectedTime = null;
                document.getElementById('selectedTime').value = '';
                document.getElementById('summaryTime').textContent = 'Non s√©lectionn√©e';
                checkFormComplete();
            }

            // Detect new slots
            if (lastSlotsData && currentSlotTimes.length > lastSlotTimes.length) {
                const newSlots = currentSlotTimes.filter(time => !lastSlotTimes.includes(time));
                if (newSlots.length > 0) {
                    showNotification(`${newSlots.length} nouveau(x) cr√©neau(x) disponible(s)!`, 'success');
                }
            }

            // Store current data for next comparison
            lastSlotsData = data.slots ? [...data.slots] : null;

            timeSlotsContainer.innerHTML = '';

            if (data.slots && data.slots.length > 0) {
                data.slots.forEach((slot, index) => {
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot glass p-3 text-center cursor-pointer border border-gray-200 hover:border-green-300 transition-all';
                    timeSlot.setAttribute('role', 'button');
                    timeSlot.setAttribute('tabindex', '0');

                    // Add pulse animation for new slots
                    const isNewSlot = lastSlotsData && lastSlotTimes.length > 0 && !lastSlotTimes.includes(slot.time);
                    if (isNewSlot) {
                        timeSlot.classList.add('updated');
                    }

                    timeSlot.innerHTML = `
                        <div class="font-semibold">${slot.time}</div>
                    <div class="meta text-green-600 mt-1">
                            <i data-lucide="check-circle" class="w-3 h-3 inline mr-1"></i>
                            Disponible
                        </div>
                    `;
                    timeSlot.onclick = () => selectTime(slot.time, timeSlot);
                    timeSlot.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectTime(slot.time, timeSlot); } };
                    timeSlotsContainer.appendChild(timeSlot);
                });

                // Re-initialize Lucide icons
                window.lucide && window.lucide.createIcons();
            } else {
                timeSlotsContainer.innerHTML = `
                    <div class="col-span-2 text-center text-gray-500 py-8">
                        <i data-lucide="calendar-x" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                        <p>Aucun cr√©neau disponible pour cette date</p>
                        <p class="text-sm mt-1">${data.message || 'Essayez une autre date'}</p>
                    </div>
                `;
                window.lucide && window.lucide.createIcons();
            }
        } catch (error) {
            console.error('Erreur:', error);
            timeSlotsContainer.innerHTML = `
                <div class="col-span-2 text-center text-red-500 py-8">
                    <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-2"></i>
                    <p>Erreur lors du chargement des cr√©neaux</p>
                    <button onclick="generateTimeSlots()" class="text-sm text-blue-500 hover:text-blue-700 mt-2">
                        R√©essayer
                    </button>
                </div>
            `;
            window.lucide && window.lucide.createIcons();
        }
    }

    // Time selection
    function selectTime(time, element) {
        selectedTime = time;

        // Update UI
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.classList.remove('selected');
        });
        element.classList.add('selected');

        // Update hidden field
        document.getElementById('selectedTime').value = time;

        // Update summary
        document.getElementById('summaryTime').textContent = time;

        checkFormComplete();
    }

    // Check if form is complete
    function checkFormComplete() {
        const submitBtn = document.getElementById('submitBtn');
        if (selectedService && selectedDate && selectedTime) {
            submitBtn.disabled = false;
            updateProgress(3);
        } else {
            submitBtn.disabled = true;
            if (selectedService && selectedDate) updateProgress(2); else if (selectedService) updateProgress(1); else updateProgress(0);
        }
    }

    function updateProgress(step) {
        const d1 = document.getElementById('stepDot1');
        const d2 = document.getElementById('stepDot2');
        const d3 = document.getElementById('stepDot3');
        if (!d1 || !d2 || !d3) return;
        d1.classList.toggle('active', step >= 1);
        d2.classList.toggle('active', step >= 2);
        d3.classList.toggle('active', step >= 3);
    }

    // Auto-refresh function to keep slots synchronized
    function autoRefreshSlots() {
        if (selectedDate) {
            generateTimeSlots();
        }
    }

    // Refresh slots every 30 seconds when a date is selected
    let refreshInterval = null;
    function startAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
        refreshInterval = setInterval(autoRefreshSlots, 30000); // 30 seconds
    }

    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
    }

    // Update selectDate function to include auto-refresh
    const originalSelectDate = selectDate;
    selectDate = function (date, element) {
        originalSelectDate(date, element);
        startAutoRefresh(); // Start auto-refresh when date is selected
    };

    // Add visibility change listener to refresh when user comes back to tab
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden && selectedDate) {
            generateTimeSlots(); // Refresh immediately when tab becomes visible
        }
    });

    // Initialize calendar on page load
    document.addEventListener('DOMContentLoaded', () => {
        generateCalendar();
        updateProgress(0);
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
        stopAutoRefresh();
    });
</script>
{% endblock %}