{% extends 'front_web/base_prof.html' %}
{% load static %}
{% block title %}Gestion des rendez‑vous - Coucou Beauté{% endblock %}
{% block content %}
<div class="p-6 space-y-6">
    <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
            <div
                class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-400 to-blue-400 flex items-center justify-center text-white">
                <i data-lucide="calendar" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Rendez‑vous</h1>
                <p class="text-gray-600 mt-1">Acceptez ou refusez les demandes, et suivez vos réservations.</p>
            </div>
        </div>
    </div>

    <div class="glass p-6">
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-xl font-semibold text-gray-900">Demandes en attente</h2>
            <div class="text-sm text-gray-500" id="pendingCount">—</div>
        </div>
        <div class="overflow-hidden rounded-xl border">
            <table class="w-full table-glass">
                <thead>
                    <tr class="text-left text-sm text-gray-600">
                        <th class="px-4 py-3">Client</th>
                        <th class="px-4 py-3">Service</th>
                        <th class="px-4 py-3">Date</th>
                        <th class="px-4 py-3">Heure</th>
                        <th class="px-4 py-3">Actions</th>
                    </tr>
                </thead>
                <tbody id="tblPending" class="bg-white/50"></tbody>
            </table>
        </div>
    </div>

    <div class="glass p-6">
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-xl font-semibold text-gray-900">Confirmés</h2>
            <div class="text-sm text-gray-500" id="confirmedCount">—</div>
        </div>
        <div class="overflow-hidden rounded-xl border">
            <table class="w-full table-glass">
                <thead>
                    <tr class="text-left text-sm text-gray-600">
                        <th class="px-4 py-3">Client</th>
                        <th class="px-4 py-3">Service</th>
                        <th class="px-4 py-3">Date</th>
                        <th class="px-4 py-3">Heure</th>
                        <th class="px-4 py-3">Statut</th>
                    </tr>
                </thead>
                <tbody id="tblConfirmed" class="bg-white/50"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function fmtDate(d) { const dt = new Date(d); return dt.toLocaleDateString('fr-FR'); }
    function fmtTime(d) { const dt = new Date(d); return dt.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }); }
    function getCsrf() { const m = document.cookie.match('(^|;)\\s*csrftoken=\\s*([^;]+)'); return m ? m.pop() : ''; }

    async function loadLists() {
        const proId = '{{ pro_id|default:pro.id|default:"" }}';
        if (!proId) return;
        const q = new URLSearchParams({ pro_id: proId });
        const res = await fetch('/api/appointments/list/?' + q.toString(), { credentials: 'same-origin' });
        if (!res.ok) return;
        const data = await res.json();
        const pending = data.pending || []; const confirmed = data.confirmed || [];
        document.getElementById('pendingCount').textContent = pending.length + ' demande(s)';
        document.getElementById('confirmedCount').textContent = confirmed.length + ' rendez‑vous';
        const tp = document.getElementById('tblPending'); tp.innerHTML = '';
        pending.forEach(a => {
            const tr = document.createElement('tr'); tr.className = 'border-t';
            tr.innerHTML = `<td class="px-4 py-3 text-sm">${a.client_name || '—'}</td>
                            <td class="px-4 py-3 text-sm">${a.service_name || '—'}</td>
                            <td class="px-4 py-3 text-sm">${fmtDate(a.start)}</td>
                            <td class="px-4 py-3 text-sm">${fmtTime(a.start)}</td>
                            <td class="px-4 py-3 text-sm">
                                <button class="btn-glass text-emerald-700 mr-2" data-act="accept" data-id="${a.id}">Accepter</button>
                                <button class="btn-secondary-glass text-red-700" data-act="reject" data-id="${a.id}">Refuser</button>
                            </td>`;
            tp.appendChild(tr);
        });
        const tc = document.getElementById('tblConfirmed'); tc.innerHTML = '';
        confirmed.forEach(a => {
            const tr = document.createElement('tr'); tr.className = 'border-t';
            tr.innerHTML = `<td class="px-4 py-3 text-sm">${a.client_name || '—'}</td>
                            <td class="px-4 py-3 text-sm">${a.service_name || '—'}</td>
                            <td class="px-4 py-3 text-sm">${fmtDate(a.start)}</td>
                            <td class="px-4 py-3 text-sm">${fmtTime(a.start)}</td>
                            <td class="px-4 py-3 text-sm"><span class="px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border">Confirmé</span></td>`;
            tc.appendChild(tr);
        });
    }

    document.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-act]'); if (!btn) return;
        const id = btn.getAttribute('data-id'); const act = btn.getAttribute('data-act');
        const url = act === 'accept' ? '/api/appointments/accept/' : '/api/appointments/reject/';
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrf() }, body: JSON.stringify({ appointment_id: id }) });
        if (res.ok) { loadLists(); }
    });

    loadLists();
</script>
{% endblock %}