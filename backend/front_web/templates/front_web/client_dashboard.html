{% extends 'front_web/base_client.html' %}
{% load static %}
{% block title %}Tableau de bord Client - Coucou Beaut√©{% endblock %}
{% block extra_css %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    body {
        font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial;
    }

    .grad-btn {
        background: linear-gradient(135deg, #F28BB2 0%, #6CA9E0 100%);
        box-shadow: 0 8px 24px rgba(242, 139, 178, 0.3);
        transition: all 0.3s ease;
    }

    .grad-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(242, 139, 178, 0.4);
    }

    .glass {
        background: rgba(255, 255, 255, 0.55);
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 0 8px 24px rgba(16, 24, 40, 0.08);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 16px;
    }

    .glass-strong {
        background: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(255, 255, 255, 0.8);
        box-shadow: 0 12px 32px rgba(16, 24, 40, 0.12);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
    }

    .text-rosePastel {
        color: #F28BB2;
    }

    .text-blueLight {
        color: #6CA9E0;
    }

    .btn-elevated {
        box-shadow: 0 8px 24px rgba(108, 169, 224, 0.20);
        transition: all 0.3s ease;
    }

    .btn-elevated:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(242, 139, 178, 0.30);
    }

    .card-hover {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .card-hover:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 20px 48px rgba(16, 24, 40, 0.15);
        border-color: rgba(242, 139, 178, 0.3);
    }

    .pro-card {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }

    .category-tab {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .category-tab::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        transition: left 0.5s;
    }

    .category-tab:hover::before {
        left: 100%;
    }

    .category-tab.active {
        background: linear-gradient(135deg, #F28BB2 0%, #6CA9E0 100%);
        color: white;
        box-shadow: 0 8px 24px rgba(242, 139, 178, 0.3);
    }

    .category-tab:not(.active) {
        background: rgba(255, 255, 255, 0.6);
        color: #6B7280;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .category-tab:not(.active):hover {
        background: rgba(255, 255, 255, 0.8);
        color: #374151;
        transform: translateY(-1px);
    }

    .filter-panel {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.6);
    }

    .glass-badge {
        background: rgba(255, 255, 255, 0.65);
        border: 1px solid rgba(226, 232, 240, 0.9);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border-radius: 9999px;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        line-height: 1rem;
    }

    .sticky-bar {
        position: sticky;
        top: 1rem;
        z-index: 20;
    }

    .map-container {
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(16, 24, 40, 0.12);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .search-input {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        transition: all 0.3s ease;
    }

    .search-input:focus {
        background: rgba(255, 255, 255, 0.95);
        border-color: #F28BB2;
        box-shadow: 0 0 0 3px rgba(242, 139, 178, 0.1);
    }

    .loading-spinner {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    .welcome-section {
        background: linear-gradient(135deg, #F28BB2 0%, #6CA9E0 100%);
        position: relative;
        overflow: hidden;
    }

    .welcome-section::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        animation: float 6s ease-in-out infinite;
    }

    @keyframes float {

        0%,
        100% {
            transform: translateY(0px) rotate(0deg);
        }

        50% {
            transform: translateY(-20px) rotate(180deg);
        }
    }

    .rating-stars {
        color: #FCD34D;
        filter: drop-shadow(0 2px 4px rgba(252, 211, 77, 0.3));
    }

    .stats-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
        border: 1px solid rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        transition: all 0.3s ease;
    }

    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(16, 24, 40, 0.15);
    }

    .floating-action {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 50;
        background: linear-gradient(135deg, #F28BB2 0%, #6CA9E0 100%);
        box-shadow: 0 8px 32px rgba(242, 139, 178, 0.4);
        transition: all 0.3s ease;
    }

    .floating-action:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 12px 40px rgba(242, 139, 178, 0.5);
    }

    .pulse-animation {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(242, 139, 178, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(242, 139, 178, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(242, 139, 178, 0);
        }
    }

    .gradient-text {
        background: linear-gradient(135deg, #F28BB2 0%, #6CA9E0 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .section-divider {
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(242, 139, 178, 0.3), transparent);
        margin: 2rem 0;
    }

    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .pro-card {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .pro-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 48px rgba(16, 24, 40, 0.15);
        border-color: rgba(242, 139, 178, 0.3);
    }

    /* Wider container for ultra design UX */
    .container-xxl {
        max-width: 1440px;
        margin-left: auto;
        margin-right: auto;
    }

    @media (min-width: 1600px) {
        .container-xxl {
            max-width: 1536px;
        }
    }

    /* Floating background canvas */
    #three-bg {
        position: fixed;
        inset: 0;
        z-index: -1;
        pointer-events: none;
    }

    /* Consistent map marker styles */
    .cb-marker {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 4px solid #ffffff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        font-weight: 700;
        font-size: 11px;
    }

    .cb-marker-rose {
        background: #F28BB2;
    }

    .cb-marker-blue {
        background: #6CA9E0;
    }
</style>
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}

{% block page_header %}
<div class="welcome-section text-white py-8">
    <div class="container-xxl px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold">Bonjour {{ user.first_name|default:user.username }} ! üëã</h1>
                <p class="text-white/90 mt-2">D√©couvrez nos professionnels beaut√© et r√©servez votre prochain rendez-vous
                </p>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <p class="text-sm text-white/80">Connect√© en tant que</p>
                    <p class="font-semibold">{{ user.email }}</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-pink-50 via-white to-blue-50">
    <!-- Animated soft background (lightweight) -->
    <div id="three-bg"></div>

    <!-- Main Content -->
    <div class="container-xxl px-4 sm:px-6 lg:px-8 py-8">
        <!-- Search Bar -->
        <div class="glass rounded-2xl p-6 mb-6 sticky-bar shadow-md">
            <div class="flex items-center gap-4">
                <div class="flex-1 relative">
                    <i data-lucide="search"
                        class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                    <input type="text" id="searchInput" placeholder="Rechercher un professionnel, service..."
                        class="search-input w-full pl-10 pr-4 py-3 rounded-xl border-0 focus:ring-2 focus:ring-rosePastel/20 focus:outline-none">
                </div>
                <button id="filterBtn"
                    class="px-4 py-3 bg-white/60 hover:bg-white/80 rounded-xl border border-gray-200 transition-all shadow-sm">
                    <i data-lucide="filter" class="w-5 h-5 text-gray-600"></i>
                </button>
            </div>
        </div>

        <!-- Category Tabs -->
        <div class="glass rounded-2xl p-4 mb-6">
            <div class="flex flex-wrap gap-2" id="categoryTabs">
                <button class="category-tab active px-4 py-2 rounded-xl font-medium" data-category="all">
                    Tous
                </button>
                <!-- Categories will be loaded dynamically -->
            </div>
        </div>

        <!-- Map Section with Integrated Filters -->
        <div class="glass rounded-2xl p-8 mb-8">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold gradient-text mb-2">Professionnels pr√®s de vous</h2>
                    <p class="text-gray-600">Explorez la carte pour d√©couvrir les centres de beaut√©</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="stats-card px-4 py-2 rounded-xl">
                        <div class="flex items-center gap-2">
                            <i data-lucide="users" class="w-4 h-4 text-rosePastel"></i>
                            <span class="text-sm font-medium text-gray-700" id="professionalsCount">0</span>
                            <span class="text-xs text-gray-500">professionnels</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 text-sm text-gray-500">
                        <div class="w-3 h-3 bg-rosePastel rounded-full"></div>
                        <span>Votre position</span>
                        <div class="w-3 h-3 bg-blueLight rounded-full ml-4"></div>
                        <span>Professionnels</span>
                    </div>
                </div>
            </div>

            <!-- Quick Filters - Now above the map -->
            <div class="glass-strong rounded-2xl p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                        <i data-lucide="filter" class="w-5 h-5 text-rosePastel"></i>
                        Filtres rapides
                    </h3>
                    <button id="clearAllFilters"
                        class="text-sm text-rosePastel hover:text-rosePastel/80 font-medium flex items-center gap-1">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        Effacer tout
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-700 flex items-center gap-2">
                            <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                            Prix maximum
                        </label>
                        <select id="priceFilter"
                            class="bg-white/60 px-4 py-3 rounded-xl border-0 focus:ring-2 focus:ring-rosePastel/20 w-full">
                            <option value="0">Tous les prix</option>
                            <option value="50">50 DT max</option>
                            <option value="100">100 DT max</option>
                            <option value="150">150 DT max</option>
                            <option value="200">200 DT max</option>
                            <option value="300">300 DT max</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-700 flex items-center gap-2">
                            <i data-lucide="globe" class="w-4 h-4"></i>
                            Langues
                        </label>
                        <select id="languageFilter"
                            class="bg-white/60 px-4 py-3 rounded-xl border-0 focus:ring-2 focus:ring-rosePastel/20 w-full">
                            <option value="">Toutes les langues</option>
                            <option value="french">Fran√ßais</option>
                            <option value="english">Anglais</option>
                            <option value="arabic">Arabe</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-700 flex items-center gap-2">
                            <i data-lucide="star" class="w-4 h-4"></i>
                            Note minimum
                        </label>
                        <div class="flex items-center gap-3">
                            <div class="flex rating-stars" id="ratingFilter">
                                <i data-lucide="star"
                                    class="w-5 h-5 cursor-pointer hover:scale-110 transition-transform"
                                    data-rating="1"></i>
                                <i data-lucide="star"
                                    class="w-5 h-5 cursor-pointer hover:scale-110 transition-transform"
                                    data-rating="2"></i>
                                <i data-lucide="star"
                                    class="w-5 h-5 cursor-pointer hover:scale-110 transition-transform"
                                    data-rating="3"></i>
                                <i data-lucide="star"
                                    class="w-5 h-5 cursor-pointer hover:scale-110 transition-transform"
                                    data-rating="4"></i>
                                <i data-lucide="star"
                                    class="w-5 h-5 cursor-pointer hover:scale-110 transition-transform"
                                    data-rating="5"></i>
                            </div>
                            <span id="ratingValue" class="text-sm text-gray-600 font-medium">Toutes</span>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-700 flex items-center gap-2">
                            <i data-lucide="map-pin" class="w-4 h-4"></i>
                            Distance max
                        </label>
                        <select id="distanceFilter"
                            class="bg-white/60 px-4 py-3 rounded-xl border-0 focus:ring-2 focus:ring-rosePastel/20 w-full">
                            <option value="50">50 km</option>
                            <option value="25">25 km</option>
                            <option value="10">10 km</option>
                            <option value="5">5 km</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Map Container -->
            <div class="map-container">
                <div id="professionalsMap" style="height: 520px;"></div>
            </div>
        </div>

        <!-- Section Divider -->
        <div class="section-divider"></div>

        <!-- Professionals List Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold gradient-text mb-2">Professionnelles √† proximit√©</h2>
                <p class="text-gray-600">D√©couvrez nos experts en beaut√©</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="stats-card px-4 py-2 rounded-xl">
                    <div class="flex items-center gap-2">
                        <i data-lucide="map-pin" class="w-4 h-4 text-blueLight"></i>
                        <span class="text-sm font-medium text-gray-700" id="mapProfessionalsCount">0</span>
                        <span class="text-xs text-gray-500">sur la carte</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters Panel (Hidden by default) -->
        <div id="filtersPanel" class="filter-panel rounded-2xl p-6 mb-6 hidden">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Filtres</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Prix minimum</label>
                    <input type="range" id="priceMin" min="0" max="300" value="0" class="w-full">
                    <span id="priceMinValue" class="text-sm text-gray-600">0 DT</span>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Prix maximum</label>
                    <input type="range" id="priceMax" min="0" max="300" value="300" class="w-full">
                    <span id="priceMaxValue" class="text-sm text-gray-600">300 DT</span>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Note minimum</label>
                    <input type="range" id="minRating" min="0" max="5" step="0.1" value="0" class="w-full">
                    <span id="minRatingValue" class="text-sm text-gray-600">0.0 ‚≠ê</span>
                </div>
            </div>
            <div class="mt-4 flex gap-2">
                <button id="applyFilters" class="grad-btn text-white px-6 py-2 rounded-xl font-semibold">
                    Appliquer
                </button>
                <button id="clearFilters" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-xl font-semibold">
                    Effacer
                </button>
            </div>
        </div>

        <!-- Professionals List -->
        <div class="space-y-4" id="professionalsList">
            <!-- Professionals will be loaded dynamically -->
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="text-center py-12 hidden">
            <div class="glass-strong rounded-2xl p-8 max-w-md mx-auto">
                <div
                    class="loading-spinner w-12 h-12 border-4 border-rosePastel border-t-transparent rounded-full mx-auto mb-4">
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Chargement des professionnels</h3>
                <p class="text-gray-600">Recherche en cours...</p>
            </div>
        </div>

        <!-- No Results -->
        <div id="noResults" class="text-center py-16 hidden">
            <div class="glass-strong rounded-2xl p-12 max-w-lg mx-auto">
                <div
                    class="w-20 h-20 bg-gradient-to-br from-pink-100 to-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="search-x" class="w-10 h-10 text-gray-400"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-3">Aucun professionnel trouv√©</h3>
                <p class="text-gray-600 mb-6">Essayez de modifier vos crit√®res de recherche</p>
                <div class="glass rounded-xl p-6">
                    <div class="flex items-center gap-3 mb-3">
                        <i data-lucide="lightbulb" class="w-5 h-5 text-yellow-500"></i>
                        <span class="font-medium text-gray-900">Conseil</span>
                    </div>
                    <p class="text-sm text-gray-600">Assurez-vous que des professionnels sont enregistr√©s avec des
                        coordonn√©es GPS dans votre base de donn√©es.</p>
                </div>
                <button onclick="loadProfessionals()"
                    class="grad-btn text-white px-6 py-3 rounded-xl font-semibold mt-6">
                    <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                    R√©essayer
                </button>
            </div>
        </div>

    </div>

    <!-- Floating Action Button -->
    <button class="floating-action rounded-full p-4 text-white shadow-lg" onclick="scrollToTop()">
        <i data-lucide="arrow-up" class="w-6 h-6"></i>
    </button>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
<script>
    // Global variables
    let map, markers = [];
    let professionals = [];
    let currentFilters = {
        search: '',
        category: 'all',
        priceMin: 0,
        priceMax: 300,
        minRating: 0,
        maxDistance: 50
    };
    let userLocation = null;

    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', function () {
        initMap();
        loadCategories();
        loadProfessionals();
        setupEventListeners();
    });

    // Initialize map
    function initMap() {
        // Default to Nabeul center
        const defaultCenter = [36.4515, 10.7353];

        map = L.map('professionalsMap').setView(defaultCenter, 11);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // Fallback to server-provided client coordinates (if present)
        try {
            const sLat = parseFloat('{{ client_profile.latitude|default:"" }}');
            const sLng = parseFloat('{{ client_profile.longitude|default:"" }}');
            if (!isNaN(sLat) && !isNaN(sLng)) {
                userLocation = [sLat, sLng];
                map.setView(userLocation, 13);
            }
        } catch (e) { }

        // Try to get browser geolocation (preferred)
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function (position) {
                    userLocation = [position.coords.latitude, position.coords.longitude];
                    map.setView(userLocation, 13);
                    loadProfessionals();
                },
                function () {
                    // Fallback to default location
                    loadProfessionals();
                }
            );
        } else {
            loadProfessionals();
        }
    }

    // Load categories
    async function loadCategories() {
        try {
            let response = await fetch('/api/api/professionals/categories/');
            if (!response.ok) {
                // Fallback path
                response = await fetch('/users/api/professionals/categories/');
            }
            const data = await response.json();

            const tabsContainer = document.getElementById('categoryTabs');
            data.categories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-tab px-4 py-2 rounded-xl font-medium';
                button.textContent = category.label;
                button.dataset.category = category.code;
                button.addEventListener('click', () => selectCategory(category.code));
                tabsContainer.appendChild(button);
            });
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    // Select category
    function selectCategory(category) {
        // Update active tab
        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-category="${category}"]`).classList.add('active');

        // Update filters and reload
        currentFilters.category = category;
        loadProfessionals();
    }

    // Load professionals
    async function loadProfessionals() {
        showLoading(true);

        try {
            const center = userLocation || [36.4515, 10.7353]; // Nabeul par d√©faut
            const params = new URLSearchParams({
                center_lat: center[0],
                center_lng: center[1],
                within_km: currentFilters.maxDistance.toString(),
                price_min: currentFilters.priceMin,
                price_max: currentFilters.priceMax,
                min_rating: currentFilters.minRating,
                category: currentFilters.category !== 'all' ? currentFilters.category : '',
                search: currentFilters.search
            });

            console.log('Fetching professionals with params:', params.toString());

            let response = await fetch(`/api/api/professionals/simple/?${params}`);
            if (!response.ok) {
                // Fallback path if first URL fails (e.g., 404)
                response = await fetch(`/users/api/professionals/simple/?${params}`);
            }
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('API Response:', data);
            console.log('Debug info:', data.debug);

            professionals = enrichProfessionals(data.results || []);

            // Afficher les statistiques dans la console
            if (data.debug) {
                console.log(`üìä Statistiques: ${data.debug.with_coordinates || 0} professionnels avec coordonn√©es sur ${data.debug.total_professionals || 0} total`);
            }

            // Appliquer les filtres c√¥t√© client
            professionals = applyClientFilters(professionals);

            displayProfessionals();
            updateMap();

        } catch (error) {
            console.error('Error loading professionals:', error);
            console.log('API failed, showing empty state');

            // Afficher un √©tat vide au lieu de donn√©es statiques
            professionals = [];

            displayProfessionals();
            updateMap();
        } finally {
            showLoading(false);
        }
    }

    // Enrich professionals: fallback coordinates by city and compute distance
    function enrichProfessionals(list) {
        const cityToCoords = {
            'tunis': [36.8065, 10.1815],
            'nabeul': [36.4515, 10.7353],
            'hammamet': [36.4008, 10.6149],
            'sousse': [35.8256, 10.6360],
            'sfax': [34.7406, 10.7603],
            'bizerte': [37.2746, 9.8739],
            'gabes': [33.8815, 10.0982],
            'gafsa': [34.4250, 8.7842],
            'kairouan': [35.6781, 10.0963],
            'monastir': [35.7770, 10.8262],
            'medenine': [33.3547, 10.5055],
            'tozeur': [33.9197, 8.1335]
        };
        function computeDistanceKm(a, b) {
            if (!a || !b) return null;
            const [lat1, lon1] = a; const [lat2, lon2] = b;
            if ([lat1, lon1, lat2, lon2].some(v => v == null || isNaN(v))) return null;
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const s1 = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(s1), Math.sqrt(1 - s1));
            return R * c;
        }
        const center = userLocation || [36.4515, 10.7353];
        return (list || []).map(p => {
            // Normalize lat/lng to numbers
            let lat = (p.lat != null) ? parseFloat(p.lat) : null;
            let lng = (p.lng != null) ? parseFloat(p.lng) : null;
            if ((lat == null || lng == null || isNaN(lat) || isNaN(lng)) && p.city) {
                const k = String(p.city).toLowerCase();
                if (cityToCoords[k]) { [lat, lng] = cityToCoords[k]; }
            }
            p.lat = lat; p.lng = lng;
            const d = computeDistanceKm(center, (lat != null && lng != null) ? [lat, lng] : null);
            if (d != null) p.distanceKm = Math.round(d * 10) / 10;
            return p;
        });
    }

    // Appliquer les filtres c√¥t√© client
    function applyClientFilters(pros) {
        let filtered = pros;

        // Filtre par recherche
        if (currentFilters.search) {
            const searchTerm = currentFilters.search.toLowerCase();
            filtered = filtered.filter(pro =>
                pro.name.toLowerCase().includes(searchTerm) ||
                pro.service.toLowerCase().includes(searchTerm) ||
                pro.address.toLowerCase().includes(searchTerm)
            );
        }

        // Filtre par cat√©gorie
        if (currentFilters.category && currentFilters.category !== 'all') {
            filtered = filtered.filter(pro =>
                pro.service.toLowerCase().includes(currentFilters.category.toLowerCase())
            );
        }

        // Filtre par prix
        filtered = filtered.filter(pro =>
            pro.price >= currentFilters.priceMin &&
            pro.price <= currentFilters.priceMax
        );

        // Filtre par note minimum
        filtered = filtered.filter(pro =>
            pro.rating >= currentFilters.minRating
        );

        // Filtre par langue (si applicable)
        if (currentFilters.language) {
            // Pour l'instant, on ne filtre pas par langue car pas dans l'API
            // TODO: Ajouter le support des langues dans l'API
        }

        return filtered;
    }

    // Display professionals
    function displayProfessionals() {
        const container = document.getElementById('professionalsList');
        const noResults = document.getElementById('noResults');
        const professionalsCount = document.getElementById('professionalsCount');
        const mapProfessionalsCount = document.getElementById('mapProfessionalsCount');

        console.log('Displaying professionals:', professionals.length);

        // Update professionals count
        if (professionalsCount) {
            professionalsCount.textContent = professionals.length;
        }

        // Update map professionals count
        if (mapProfessionalsCount) {
            mapProfessionalsCount.textContent = professionals.length;
        }

        if (professionals.length === 0) {
            container.innerHTML = '';
            noResults.classList.remove('hidden');
            return;
        }

        noResults.classList.add('hidden');
        container.innerHTML = professionals.map((pro, index) => {
            // Assurer que toutes les valeurs existent
            const name = pro.name || 'Professionnel';
            const service = pro.service || 'Service';
            const services = pro.services || [];
            const rating = pro.rating || 0;
            const reviews = pro.reviews || 0;
            const price = pro.price || 0;
            const priceRange = pro.price_range || `${price} DT`;
            const distance = pro.distanceKm || 0;
            const address = pro.address || 'Adresse non disponible';
            const phone = pro.phone || '';
            const email = pro.email || '';
            const city = pro.city || '';
            const bio = pro.bio || '';
            const languages = pro.spoken_languages || [];
            const isVerified = pro.is_verified || false;

            return `
                <div class="pro-card rounded-2xl p-6 card-hover cursor-pointer group" onclick="viewProfessional(${pro.id})">
                    <div class="flex items-start gap-6">
                        <!-- Photo de profil principale -->
                        <div class="flex-shrink-0 relative">
                            ${pro.profile_photo ?
                    `<div class="relative group/photo">
                        <img src="${pro.profile_photo}" alt="${name}" class="w-20 h-20 rounded-2xl object-cover shadow-xl border-2 border-white">
                        <div class="absolute inset-0 rounded-2xl bg-gradient-to-t from-black/20 to-transparent opacity-0 group-hover/photo:opacity-100 transition-opacity duration-300"></div>
                        ${isVerified ? `<div class="absolute -top-1 -right-1 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                            <i data-lucide="check" class="w-3 h-3 text-white"></i>
                        </div>` : ''}
                    </div>` :
                    `<div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-pink-100 to-blue-100 flex items-center justify-center shadow-xl border-2 border-white">
                        <i data-lucide="user" class="w-10 h-10 text-gray-400"></i>
                    </div>`
                }
                            <div class="absolute -top-2 -right-2 w-6 h-6 bg-gradient-to-r from-pink-400 to-blue-400 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                ${index + 1}
                            </div>
                        </div>

                        <!-- Informations principales -->
                        <div class="flex-1">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <!-- Nom et statut -->
                                    <div class="flex items-center gap-3 mb-2">
                                        <h3 class="text-xl font-bold text-gray-900">${name}</h3>
                                        ${isVerified ? `<span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-medium rounded-full flex items-center gap-1">
                                            <i data-lucide="check-circle" class="w-3 h-3"></i>
                                            V√©rifi√©
                                        </span>` : ''}
                                    </div>

                                    <!-- Note et avis -->
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="flex rating-stars">
                                            ${Array(5).fill(0).map((_, i) =>
                    `<i data-lucide="star" class="w-4 h-4 ${i < Math.floor(rating) ? 'fill-current' : ''}"></i>`
                ).join('')}
                                        </div>
                                        <span class="text-sm text-gray-600 font-medium">${rating} (${reviews} avis)</span>
                                        <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">${city}</span>
                                    </div>

                                    <!-- Service principal -->
                                    <p class="text-gray-600 mb-2 flex items-center gap-2">
                                        <i data-lucide="scissors" class="w-4 h-4 text-rosePastel"></i>
                                        <span class="font-medium">${service}</span>
                                    </p>

                                    <!-- Services suppl√©mentaires -->
                                    ${services.length > 0 ? `<div class="flex flex-wrap gap-1 mb-2">
                                        ${services.slice(0, 3).map(s => `<span class=\"text-xs bg-pink-50 text-pink-700 px-2 py-1 rounded-full\">${serviceLabel(s)}</span>`).join('')}
                                        ${services.length > 3 ? `<span class="text-xs text-gray-500">+${services.length - 3} autres</span>` : ''}
                                    </div>` : ''}

                                    <!-- Adresse -->
                                    <p class="text-sm text-gray-500 mb-2 flex items-start gap-2">
                                        <i data-lucide="map-pin" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                                        <span class="line-clamp-2">${address}</span>
                                    </p>

                                    <!-- Contact -->
                                    <div class="flex items-center gap-4 text-sm text-gray-500">
                                        ${phone ? `<div class="flex items-center gap-1">
                                            <i data-lucide="phone" class="w-4 h-4"></i>
                                            <span>${phone}</span>
                                        </div>` : ''}
                                        ${languages.length > 0 ? `<div class="flex items-center gap-1">
                                            <i data-lucide="globe" class="w-4 h-4"></i>
                                            <span>${languages.slice(0, 2).join(', ')}</span>
                                        </div>` : ''}
                                    </div>

                                    <!-- Bio courte -->
                                    ${bio ? `<p class="text-sm text-gray-600 mt-2 line-clamp-2">${bio}</p>` : ''}
                                </div>

                                <!-- Informations de droite -->
                                <div class="text-right ml-6 flex-shrink-0">
                                    <div class="mb-3">
                                        <p class="text-sm text-gray-500">Distance</p>
                                        <p class="text-lg font-bold text-blueLight">${Number(distance).toFixed(1)} km</p>
                                    </div>
                                    <div class="mb-4">
                                        <p class="text-sm text-gray-500">Tarifs</p>
                                        <p class="text-xl font-bold gradient-text">${priceRange}</p>
                                    </div>
                                    <div class="flex items-center gap-2 justify-end">
                                        <button type="button" onclick="event.stopPropagation(); viewProfessional(${pro.id});" class="grad-btn text-white px-6 py-3 rounded-xl font-semibold text-sm group-hover:scale-105 transition-transform flex items-center gap-2">
                                            <i data-lucide="eye" class="w-4 h-4"></i>
                                            Voir profil
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        // Re-initialize icons
        if (window.lucide) window.lucide.createIcons();
    }

    // Update map with professionals
    function updateMap() {
        console.log('Updating map with', professionals.length, 'professionals');

        // Clear existing markers
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];

        // Add client location marker if available
        if (userLocation) {
            const clientIcon = L.divIcon({
                className: 'client-marker',
                html: '<div class="cb-marker cb-marker-rose">üë§</div>',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
            const clientMarker = L.marker(userLocation, { icon: clientIcon, title: 'Votre position' }).addTo(map);
            clientMarker.bindPopup(`
                <div class="p-3" style="min-width: 150px;">
                    <div class="flex items-center gap-2">
                        <div style="background: #F28BB2; width: 12px; height: 12px; border-radius: 50%;"></div>
                        <strong>Votre position</strong>
                    </div>
                    <p class="text-xs text-gray-600 mt-1">Lat: ${userLocation[0].toFixed(4)}, Lng: ${userLocation[1].toFixed(4)}</p>
                </div>
            `);
            markers.push(clientMarker);
        }

        // Add markers for each professional
        let validMarkers = 0;
        professionals.forEach((pro, index) => {
            if (pro.lat != null && pro.lng != null && !isNaN(pro.lat) && !isNaN(pro.lng)) {
                validMarkers++;

                // Ic√¥ne bleue pour les professionnels
                const proIcon = L.divIcon({
                    className: 'pro-marker',
                    html: `<div class="cb-marker cb-marker-blue">${index + 1}</div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                const marker = L.marker([pro.lat, pro.lng], { icon: proIcon, title: pro.name || 'Professionnel' }).addTo(map);

                // Popup am√©lior√©
                const popupContent = `
                    <div class="p-3" style="min-width: 200px;">
                        <div class="flex items-center gap-2 mb-2">
                            <div style="background: #6CA9E0; width: 12px; height: 12px; border-radius: 50%;"></div>
                            <h3 class="font-bold text-gray-900">${pro.name || 'Professionnel'}</h3>
                        </div>
                        <p class="text-sm text-gray-600 mb-1">${pro.service || 'Service'}</p>
                        <div class="flex items-center gap-2 mb-2">
                            <div class="flex rating-stars">
                                ${Array(5).fill(0).map((_, i) =>
                    `<span style="color: ${i < Math.floor(pro.rating || 0) ? '#FCD34D' : '#D1D5DB'};">‚≠ê</span>`
                ).join('')}
                            </div>
                            <span class="text-xs text-gray-600">${pro.rating || 0} (${pro.reviews || 0})</span>
                        </div>
                        <p class="text-sm font-semibold text-rosePastel mb-1">${pro.price || 0} DT</p>
                        <p class="text-xs text-gray-500 mb-2">üìç ${pro.distanceKm || 0} km</p>
                        ${pro.address ? `<p class="text-xs text-gray-600 mb-2">${pro.address}</p>` : ''}
                        <button onclick="viewProfessional(${pro.id})" 
                                class="w-full px-3 py-2 bg-rosePastel text-white rounded-lg text-sm hover:bg-opacity-80 transition-colors">
                            Voir profil complet
                        </button>
                    </div>
                `;

                marker.bindPopup(popupContent);
                markers.push(marker);
            } else {
                console.warn('Professional without valid coordinates:', pro.name, 'lat:', pro.lat, 'lng:', pro.lng);
            }
        });

        console.log(`Added ${validMarkers} professional markers to map`);

        // Update map professional count badge
        const mapProfessionalsCount = document.getElementById('mapProfessionalsCount');
        if (mapProfessionalsCount) mapProfessionalsCount.textContent = validMarkers;

        // Fit map to show all markers
        if (markers.length > 0) {
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        } else {
            // Si pas de marqueurs, centrer sur Nabeul
            map.setView([36.4515, 10.7353], 11);
        }
    }

    // View professional profile
    function viewProfessional(proId) {
        window.location.href = `/professional/${proId}/`;
    }

    // Reserve flow happens on the professional detail page after selecting a service

    // Setup event listeners
    function setupEventListeners() {
        // Search input
        const searchInput = document.getElementById('searchInput');
        let searchTimeout;
        searchInput.addEventListener('input', function () {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentFilters.search = this.value;
                loadProfessionals();
            }, 500);
        });

        // Quick filters
        const priceFilter = document.getElementById('priceFilter');
        const languageFilter = document.getElementById('languageFilter');
        const distanceFilter = document.getElementById('distanceFilter');
        const ratingStars = document.querySelectorAll('#ratingFilter i');

        if (priceFilter) {
            priceFilter.addEventListener('change', function () {
                const maxPrice = parseInt(this.value);
                currentFilters.priceMax = maxPrice;
                console.log('Price filter changed:', maxPrice);
                loadProfessionals();
            });
        }

        if (languageFilter) {
            languageFilter.addEventListener('change', function () {
                currentFilters.language = this.value;
                console.log('Language filter changed:', this.value);
                loadProfessionals();
            });
        }

        if (distanceFilter) {
            distanceFilter.addEventListener('change', function () {
                currentFilters.maxDistance = parseInt(this.value);
                console.log('Distance filter changed:', this.value);
                loadProfessionals();
            });
        }

        // Rating filter
        ratingStars.forEach((star, index) => {
            star.addEventListener('click', function () {
                const rating = parseInt(this.dataset.rating);
                currentFilters.minRating = rating;

                // Update star display
                ratingStars.forEach((s, i) => {
                    if (i < rating) {
                        s.classList.add('fill-current');
                    } else {
                        s.classList.remove('fill-current');
                    }
                });

                // Update rating text
                const ratingValue = document.getElementById('ratingValue');
                if (rating === 0) {
                    ratingValue.textContent = 'Toutes';
                } else {
                    ratingValue.textContent = `${rating}+ ‚≠ê`;
                }

                loadProfessionals();
            });
        });

        // Filter button
        document.getElementById('filterBtn').addEventListener('click', function () {
            const panel = document.getElementById('filtersPanel');
            panel.classList.toggle('hidden');
        });

        // Filter sliders
        const priceMin = document.getElementById('priceMin');
        const priceMax = document.getElementById('priceMax');
        const minRating = document.getElementById('minRating');

        priceMin.addEventListener('input', function () {
            document.getElementById('priceMinValue').textContent = this.value + ' DT';
        });

        priceMax.addEventListener('input', function () {
            document.getElementById('priceMaxValue').textContent = this.value + ' DT';
        });

        minRating.addEventListener('input', function () {
            document.getElementById('minRatingValue').textContent = this.value + ' ‚≠ê';
        });

        // Apply filters
        document.getElementById('applyFilters').addEventListener('click', function () {
            currentFilters.priceMin = parseInt(priceMin.value);
            currentFilters.priceMax = parseInt(priceMax.value);
            currentFilters.minRating = parseFloat(minRating.value);
            loadProfessionals();
            document.getElementById('filtersPanel').classList.add('hidden');
        });

        // Clear filters
        document.getElementById('clearFilters').addEventListener('click', function () {
            priceMin.value = 0;
            priceMax.value = 300;
            minRating.value = 0;
            document.getElementById('priceMinValue').textContent = '0 DT';
            document.getElementById('priceMaxValue').textContent = '300 DT';
            document.getElementById('minRatingValue').textContent = '0.0 ‚≠ê';

            currentFilters.priceMin = 0;
            currentFilters.priceMax = 300;
            currentFilters.minRating = 0;
            currentFilters.search = '';
            currentFilters.category = 'all';

            document.getElementById('searchInput').value = '';
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector('[data-category="all"]').classList.add('active');

            loadProfessionals();
        });
    }

    // Show/hide loading spinner
    function showLoading(show) {
        const spinner = document.getElementById('loadingSpinner');
        const list = document.getElementById('professionalsList');

        if (show) {
            spinner.classList.remove('hidden');
            list.innerHTML = '';
        } else {
            spinner.classList.add('hidden');
        }
    }

    // Show no results
    function showNoResults() {
        document.getElementById('professionalsList').innerHTML = '';
        document.getElementById('noResults').classList.remove('hidden');
    }

    // Scroll to top function
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    // Clear all filters
    function clearAllFilters() {
        // Reset search input
        document.getElementById('searchInput').value = '';

        // Reset price filter
        document.getElementById('priceFilter').value = '0';

        // Reset language filter
        document.getElementById('languageFilter').value = '';

        // Reset distance filter
        document.getElementById('distanceFilter').value = '50';

        // Reset rating filter
        const ratingStars = document.querySelectorAll('#ratingFilter i');
        ratingStars.forEach(star => {
            star.classList.remove('fill-current');
        });
        document.getElementById('ratingValue').textContent = 'Toutes';

        // Reset category to all
        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector('[data-category="all"]').classList.add('active');

        // Reset current filters
        currentFilters = {
            search: '',
            category: 'all',
            priceMin: 0,
            priceMax: 300,
            minRating: 0,
            maxDistance: 50,
            language: ''
        };

        // Reload professionals
        loadProfessionals();
    }

    // Add event listener for clear all filters button
    document.addEventListener('DOMContentLoaded', function () {
        const clearAllFiltersBtn = document.getElementById('clearAllFilters');
        if (clearAllFiltersBtn) {
            clearAllFiltersBtn.addEventListener('click', clearAllFilters);
        }
    });

    // Add smooth scroll behavior
    document.documentElement.style.scrollBehavior = 'smooth';

    // Helpers
    function serviceLabel(s) {
        if (typeof s === 'string') return s;
        if (!s || typeof s !== 'object') return 'Service';
        return s.name || s.Name || s.service || s.label || (Array.isArray(Object.values(s)) ? Object.values(s)[0] : 'Service');
    }
</script>

<!-- Lightweight animated accessories background (like admin login) -->
<script>
    (function () {
        const container = document.getElementById('three-bg'); if (!container || !window.THREE) return;
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.z = 7;
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.8));
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));

        function makeAccessoryTexture(kind, size = 192) {
            const c = document.createElement('canvas'); c.width = c.height = size; const ctx = c.getContext('2d');
            ctx.clearRect(0, 0, size, size); ctx.lineJoin = 'round'; ctx.lineCap = 'round';
            const grad = ctx.createLinearGradient(0, 0, size, size); grad.addColorStop(0, '#F28BB2'); grad.addColorStop(1, '#6CA9E0');
            ctx.fillStyle = grad; ctx.strokeStyle = grad; ctx.lineWidth = size * 0.07; ctx.shadowColor = 'rgba(0,0,0,0.15)'; ctx.shadowBlur = size * 0.06; ctx.shadowOffsetY = size * 0.02;
            if (kind === 'lipstick') { ctx.fillRect(size * 0.42, size * 0.48, size * 0.16, size * 0.28); ctx.fillRect(size * 0.40, size * 0.30, size * 0.20, size * 0.18); ctx.beginPath(); ctx.moveTo(size * 0.40, size * 0.30); ctx.lineTo(size * 0.60, size * 0.30); ctx.lineTo(size * 0.50, size * 0.15); ctx.closePath(); ctx.fill(); }
            else if (kind === 'comb') { ctx.fillRect(size * 0.22, size * 0.56, size * 0.56, size * 0.12); for (let i = 0; i < 12; i++) { ctx.fillRect(size * (0.24 + i * 0.045), size * 0.38, size * 0.02, size * 0.18); } }
            else if (kind === 'scissors') { ctx.lineWidth = size * 0.05; ctx.beginPath(); ctx.moveTo(size * 0.28, size * 0.66); ctx.lineTo(size * 0.74, size * 0.34); ctx.stroke(); ctx.beginPath(); ctx.moveTo(size * 0.28, size * 0.34); ctx.lineTo(size * 0.74, size * 0.66); ctx.stroke(); ctx.lineWidth = size * 0.06; ctx.beginPath(); ctx.arc(size * 0.28, size * 0.34, size * 0.10, 0, Math.PI * 2); ctx.stroke(); ctx.beginPath(); ctx.arc(size * 0.28, size * 0.66, size * 0.10, 0, Math.PI * 2); ctx.stroke(); }
            else if (kind === 'nail') { ctx.fillRect(size * 0.36, size * 0.44, size * 0.28, size * 0.26); ctx.fillRect(size * 0.44, size * 0.22, size * 0.12, size * 0.20); ctx.beginPath(); ctx.moveTo(size * 0.44, size * 0.22); ctx.lineTo(size * 0.56, size * 0.22); ctx.lineTo(size * 0.50, size * 0.12); ctx.closePath(); ctx.fill(); }
            else if (kind === 'dryer') { if (!ctx.roundRect) { ctx.roundRect = function (x, y, w, h, r) { this.beginPath(); this.moveTo(x + r, y); this.arcTo(x + w, y, x + w, y + h, r); this.arcTo(x + w, y + h, x, y + h, r); this.arcTo(x, y + h, x, y, r); this.arcTo(x, y, x + w, y, r); this.closePath(); }; } ctx.beginPath(); ctx.roundRect(size * 0.30, size * 0.30, size * 0.40, size * 0.22, size * 0.10); ctx.fill(); ctx.fillRect(size * 0.70, size * 0.36, size * 0.16, size * 0.10); ctx.beginPath(); ctx.roundRect(size * 0.36, size * 0.50, size * 0.12, size * 0.20, size * 0.06); ctx.fill(); }
            return new THREE.CanvasTexture(c);
        }
        const kinds = ['lipstick', 'comb', 'scissors', 'nail', 'dryer'];
        const accessories = new THREE.Group(); scene.add(accessories);
        for (let i = 0; i < 22; i++) { const k = kinds[i % kinds.length]; const tex = makeAccessoryTexture(k); const mat = new THREE.SpriteMaterial({ map: tex, transparent: true, depthWrite: false, opacity: 0.38 }); const sp = new THREE.Sprite(mat); sp.position.set((Math.random() - 0.5) * 20, (Math.random() - 0.3) * 10, -1.5 - Math.random()); const s = 0.9 + Math.random() * 1.7; sp.scale.set(s, s, 1); sp.userData = { vy: 0.003 + Math.random() * 0.004, vx: (Math.random() - 0.5) * 0.003, vr: (Math.random() - 0.5) * 0.006 }; accessories.add(sp); }
        let targetX = 0, targetY = 0; window.addEventListener('mousemove', (e) => { const nx = (e.clientX / window.innerWidth) * 2 - 1; const ny = (e.clientY / window.innerHeight) * 2 - 1; targetX = nx; targetY = ny; });
        function animate() { requestAnimationFrame(animate); for (const a of accessories.children) { a.position.x += a.userData.vx; a.position.y += a.userData.vy; a.rotation.z += a.userData.vr; if (a.position.y > 6) { a.position.y = -4 - Math.random() * 2; a.position.x = (Math.random() - 0.5) * 20; } } scene.position.x += (targetX * 0.35 - scene.position.x) * 0.02; scene.position.y += (-targetY * 0.25 - scene.position.y) * 0.02; renderer.render(scene, camera); }
        function onResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }
        window.addEventListener('resize', onResize);
        animate();
    })();
</script>
{% endblock %}