{% extends 'front_web/base_client.html' %}
{% load static %}
{% block template_id %}front_web/client_dashboard.html{% endblock %}
{% block title %}Tableau de bord Client - Coucou Beaut√©{% endblock %}
{% block extra_css %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    body {
        font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial;
    }

    .grad-btn {
        background: linear-gradient(135deg, #F28BB2 0%, #6CA9E0 100%);
        box-shadow: 0 8px 24px rgba(242, 139, 178, 0.3);
        transition: all 0.3s ease;
    }

    .grad-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(242, 139, 178, 0.4);
    }

    .glass {
        background: rgba(255, 255, 255, 0.55);
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 0 8px 24px rgba(16, 24, 40, 0.08);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 16px;
    }

    .glass-strong {
        background: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(255, 255, 255, 0.8);
        box-shadow: 0 12px 32px rgba(16, 24, 40, 0.12);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
    }

    .text-rosePastel {
        color: #F28BB2;
    }

    .text-blueLight {
        color: #6CA9E0;
    }

    .btn-elevated {
        box-shadow: 0 8px 24px rgba(108, 169, 224, 0.20);
        transition: all 0.3s ease;
    }

    .btn-elevated:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(242, 139, 178, 0.30);
    }

    .card-hover {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .card-hover:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 20px 48px rgba(16, 24, 40, 0.15);
        border-color: rgba(242, 139, 178, 0.3);
    }

    .pro-card {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }

    .category-tab {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .category-tab::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        transition: left 0.5s;
    }

    .category-tab:hover::before {
        left: 100%;
    }

    .category-tab.active {
        background: linear-gradient(135deg, #F28BB2 0%, #6CA9E0 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(242, 139, 178, 0.3);
    }

    .category-tab:not(.active) {
        background: rgba(255, 255, 255, 0.8);
        color: #6B7280;
        border: 1px solid rgba(226, 232, 240, 0.8);
    }

    .category-tab:not(.active):hover {
        background: rgba(255, 255, 255, 0.95);
        color: #374151;
        border-color: rgba(242, 139, 178, 0.3);
        transform: translateY(-1px);
    }

    /* Category groups accordion */
    .category-group {
        border-bottom: 1px solid rgba(226, 232, 240, 0.5);
    }

    .category-group:last-child {
        border-bottom: none;
    }

    .category-group-header {
        user-select: none;
    }

    .category-group-header:hover {
        background: rgba(242, 139, 178, 0.05);
    }

    .category-items {
        padding-bottom: 0.75rem;
        max-height: 200px;
        overflow-y: auto;
    }

    .category-items::-webkit-scrollbar {
        width: 4px;
    }

    .category-items::-webkit-scrollbar-thumb {
        background: rgba(242, 139, 178, 0.3);
        border-radius: 2px;
    }

    .filter-panel {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.6);
    }

    .glass-badge {
        background: rgba(255, 255, 255, 0.65);
        border: 1px solid rgba(226, 232, 240, 0.9);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border-radius: 9999px;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        line-height: 1rem;
    }

    .sticky-bar {
        position: sticky;
        top: 1rem;
        z-index: 20;
    }

    .map-container {
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(16, 24, 40, 0.12);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .search-input {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        transition: all 0.3s ease;
    }

    .search-input:focus {
        background: rgba(255, 255, 255, 0.95);
        border-color: #F28BB2;
        box-shadow: 0 0 0 3px rgba(242, 139, 178, 0.1);
    }

    .loading-spinner {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    .welcome-section {
        background: linear-gradient(135deg, #F28BB2 0%, #6CA9E0 100%);
        position: relative;
        overflow: hidden;
    }

    .welcome-section::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        animation: float 6s ease-in-out infinite;
    }

    @keyframes float {

        0%,
        100% {
            transform: translateY(0px) rotate(0deg);
        }

        50% {
            transform: translateY(-20px) rotate(180deg);
        }
    }

    .rating-stars {
        color: #FCD34D;
        filter: drop-shadow(0 2px 4px rgba(252, 211, 77, 0.3));
    }

    .stats-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
        border: 1px solid rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        transition: all 0.3s ease;
    }

    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(16, 24, 40, 0.15);
    }

    .floating-action {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 50;
        background: linear-gradient(135deg, #F28BB2 0%, #6CA9E0 100%);
        box-shadow: 0 8px 32px rgba(242, 139, 178, 0.4);
        transition: all 0.3s ease;
    }

    .floating-action:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 12px 40px rgba(242, 139, 178, 0.5);
    }

    .pulse-animation {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(242, 139, 178, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(242, 139, 178, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(242, 139, 178, 0);
        }
    }

    .gradient-text {
        background: linear-gradient(135deg, #F28BB2 0%, #6CA9E0 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .section-divider {
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(242, 139, 178, 0.3), transparent);
        margin: 2rem 0;
    }

    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .pro-card {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .pro-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 48px rgba(16, 24, 40, 0.15);
        border-color: rgba(242, 139, 178, 0.3);
    }

    /* Airbnb-style card animations */
    #professionalsResultsSection {
        animation: fadeInUp 0.5s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Smooth card hover effect */
    #professionalsList>div {
        transition: transform 0.2s ease;
    }

    #professionalsList>div:hover {
        transform: translateY(-4px);
    }

    /* Quick Booking Modal Styles */
    #quickBookModal {
        animation: fadeIn 0.3s ease-out;
    }

    #quickBookModal>div {
        animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }

        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* Quick search hints */
    .quick-search-hint {
        transition: all 0.2s ease;
    }

    .quick-search-hint:hover {
        background: rgba(242, 139, 178, 0.1);
        transform: scale(1.05);
    }

    /* Wider container for ultra design UX */
    .container-xxl {
        max-width: 1440px;
        margin-left: auto;
        margin-right: auto;
    }

    @media (min-width: 1600px) {
        .container-xxl {
            max-width: 1536px;
        }
    }

    /* Floating background canvas */
    #three-bg {
        position: fixed;
        inset: 0;
        z-index: -1;
        pointer-events: none;
    }

    /* Consistent map marker styles */
    .cb-marker {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 4px solid #ffffff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        font-weight: 700;
        font-size: 11px;
    }

    .cb-marker-rose {
        background: #F28BB2;
    }

    .cb-marker-blue {
        background: #6CA9E0;
    }

    /* ==========================
       RESPONSIVE MOBILE OPTIMIZATIONS
       ========================== */
    @media (max-width: 768px) {

        /* Disable three.js animation on mobile for performance */
        #three-bg {
            display: none !important;
        }

        /* Mobile-friendly body */
        body {
            font-size: 16px !important;
            /* Prevent iOS zoom */
            -webkit-text-size-adjust: 100%;
        }

        /* Container adjustments */
        .container-xxl {
            padding-left: 1rem !important;
            padding-right: 1rem !important;
        }

        /* Welcome section mobile */
        .welcome-section {
            padding: 1.5rem 1rem !important;
        }

        .welcome-section h1 {
            font-size: 1.5rem !important;
        }

        .welcome-section p {
            font-size: 0.875rem !important;
        }

        .welcome-section .flex {
            flex-direction: column !important;
            gap: 1rem !important;
            align-items: flex-start !important;
        }

        /* Glass cards mobile */
        .glass,
        .glass-strong {
            padding: 1rem !important;
            border-radius: 1rem !important;
        }

        /* Search bar mobile */
        .search-input {
            font-size: 16px !important;
            /* Critical: Prevents iOS zoom */
            padding: 0.875rem 0.75rem !important;
        }

        #searchInput {
            padding-left: 2.5rem !important;
        }

        /* Filter button touch-friendly */
        #filterBtn {
            min-height: 44px;
            min-width: 44px;
            padding: 0.75rem !important;
        }

        /* Category tabs mobile */
        .category-tab {
            font-size: 0.875rem !important;
            padding: 0.625rem 1rem !important;
            min-height: 44px;
            white-space: nowrap;
        }

        #categoryTabs {
            overflow-x: auto;
            flex-wrap: nowrap !important;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        #categoryTabs::-webkit-scrollbar {
            display: none;
        }

        /* Map section mobile */
        #professionalsMap {
            height: 400px !important;
        }

        .map-container {
            border-radius: 1rem !important;
        }

        /* Filters panel mobile */
        .glass-strong.rounded-2xl {
            padding: 1rem !important;
        }

        .grid.grid-cols-1.md\\:grid-cols-4 {
            grid-template-columns: 1fr !important;
            gap: 0.75rem !important;
        }

        /* Select inputs touch-friendly */
        select,
        input[type="date"] {
            font-size: 16px !important;
            padding: 0.875rem 0.75rem !important;
            min-height: 44px;
        }

        /* Stats cards mobile */
        .stats-card {
            padding: 0.5rem 0.75rem !important;
            font-size: 0.75rem !important;
        }

        /* Professional cards mobile */
        .pro-card {
            padding: 1rem !important;
            border-radius: 1rem !important;
        }

        .pro-card .flex {
            flex-direction: column !important;
            gap: 1rem !important;
        }

        .pro-card .flex-shrink-0 {
            flex-shrink: 1 !important;
        }

        .pro-card .w-20.h-20 {
            width: 4rem !important;
            height: 4rem !important;
        }

        .pro-card .flex-1 {
            width: 100%;
        }

        .pro-card .text-right {
            text-align: left !important;
        }

        .pro-card .ml-6 {
            margin-left: 0 !important;
            margin-top: 0.5rem;
            width: 100%;
        }

        /* Buttons touch-friendly */
        button,
        .grad-btn {
            min-height: 44px;
            padding: 0.875rem 1.25rem !important;
            font-size: 1rem !important;
            touch-action: manipulation;
        }

        /* Rating stars mobile */
        .rating-stars [data-lucide] {
            width: 1.125rem !important;
            height: 1.125rem !important;
        }

        /* Distance and price mobile */
        .pro-card .text-lg {
            font-size: 1rem !important;
        }

        .pro-card .text-xl {
            font-size: 1.125rem !important;
        }

        /* Hide decorative elements on mobile */
        .floating-action {
            bottom: 1rem;
            right: 1rem;
            width: 3rem;
            height: 3rem;
            padding: 0.75rem !important;
        }

        /* Loading spinner mobile */
        #loadingSpinner .glass-strong {
            padding: 1.5rem !important;
        }

        /* No results mobile */
        #noResults .glass-strong {
            padding: 1.5rem !important;
        }

        /* Section titles mobile */
        h2.text-2xl {
            font-size: 1.25rem !important;
        }

        h3.text-lg {
            font-size: 1rem !important;
        }

        /* Spacing adjustments */
        .space-y-4>*+* {
            margin-top: 1rem !important;
        }

        .gap-4 {
            gap: 0.75rem !important;
        }

        .gap-6 {
            gap: 1rem !important;
        }

        /* Icons sizing */
        [data-lucide] {
            width: 1.125rem !important;
            height: 1.125rem !important;
        }

        /* Badges mobile */
        .glass-badge {
            font-size: 0.6875rem !important;
            padding: 0.125rem 0.375rem !important;
        }

        /* Section divider mobile */
        .section-divider {
            margin: 1.5rem 0 !important;
        }

        /* Grid columns to single column */
        .grid.grid-cols-1.md\\:grid-cols-3 {
            grid-template-columns: 1fr !important;
        }

        /* Sticky bar adjustments */
        .sticky-bar {
            position: relative;
            top: 0;
        }
    }

    /* Small mobile (iPhone SE, etc.) */
    @media (max-width: 375px) {
        .welcome-section h1 {
            font-size: 1.25rem !important;
        }

        .glass,
        .glass-strong {
            padding: 0.75rem !important;
        }

        .pro-card {
            padding: 0.75rem !important;
        }

        #professionalsMap {
            height: 350px !important;
        }

        button {
            font-size: 0.9375rem !important;
        }
    }

    /* Floating filters panel responsive */
    #filtersPanel {
        max-height: 80vh;
        overflow-y: auto;
    }

    @media (max-width: 768px) {
        #filtersPanel {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            margin: 0 !important;
            border-radius: 0 !important;
            max-height: 100vh;
            z-index: 100;
        }
    }

    /* Landscape mobile optimization */
    @media (max-width: 768px) and (orientation: landscape) {
        .welcome-section {
            padding: 1rem !important;
        }

        #professionalsMap {
            height: 200px !important;
        }
    }

    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {

        /* Enhanced touch targets */
        button,
        a,
        label {
            cursor: pointer;
            -webkit-tap-highlight-color: rgba(242, 139, 178, 0.2);
        }

        /* Smooth scrolling */
        * {
            -webkit-overflow-scrolling: touch;
        }

        /* Active states */
        button:active,
        .grad-btn:active {
            opacity: 0.8;
            transform: scale(0.98);
        }
    }

    /* iOS Safari specific fixes */
    @supports (-webkit-touch-callout: none) {

        /* Fix iOS input zoom */
        input,
        select,
        textarea {
            font-size: max(16px, 1rem) !important;
        }

        /* Fix iOS viewport height */
        .min-h-screen {
            min-height: -webkit-fill-available;
        }
    }
</style>
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}

{% block page_header %}
<div class="welcome-section text-white py-8">
    <div class="container-xxl px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold">Bonjour {{ user.first_name|default:user.username }} ! üëã</h1>
                <p class="text-white/90 mt-2">D√©couvrez nos professionnels beaut√© et r√©servez votre prochain rendez-vous
                </p>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <p class="text-sm text-white/80">Connect√© en tant que</p>
                    <p class="font-semibold">{{ user.email }}</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-pink-50 via-white to-blue-50">
    <!-- Animated soft background (lightweight) -->
    <div id="three-bg"></div>

    <!-- Main Content -->
    <div class="container-xxl px-4 sm:px-6 lg:px-8 py-6">
        <!-- Enhanced Search Bar - Prominent and Smart -->
        <div class="mb-6 relative">
            <div class="glass rounded-2xl p-5 shadow-xl border-2 border-white/50">
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
                    <div class="flex-1 relative">
                        <i data-lucide="search"
                            class="absolute left-5 top-1/2 transform -translate-y-1/2 w-6 h-6 text-gray-400"></i>
                        <input type="text" id="searchInput"
                            placeholder="Ex: Coiffure demain, Manucure ce soir, Massage..."
                            class="search-input w-full pl-14 pr-4 py-4 rounded-xl border-0 focus:ring-2 focus:ring-rosePastel/50 focus:outline-none text-base font-medium bg-white/80 backdrop-blur-sm">
                        <div
                            class="absolute right-4 top-1/2 transform -translate-y-1/2 text-xs text-gray-400 hidden sm:block">
                            <kbd class="px-2 py-1 bg-gray-100 rounded">Entr√©e</kbd>
                        </div>
                    </div>
                    <button id="filterBtn"
                        class="px-6 py-4 grad-btn text-white rounded-xl font-semibold transition-all hover:scale-105 flex items-center justify-center gap-2 shadow-lg whitespace-nowrap">
                        <i data-lucide="sliders-horizontal" class="w-5 h-5"></i>
                        <span>Cat√©gories</span>
                    </button>
                </div>
                <!-- Quick search hints -->
                <div class="mt-3 flex flex-wrap items-center gap-2 text-xs text-gray-500">
                    <span class="font-medium">Recherche rapide :</span>
                    <button class="px-3 py-1 bg-white/60 rounded-full hover:bg-white/80 transition-colors"
                        onclick="quickSearch('demain')">Demain</button>
                    <button class="px-3 py-1 bg-white/60 rounded-full hover:bg-white/80 transition-colors"
                        onclick="quickSearch('aujourd\'hui')">Aujourd'hui</button>
                    <button class="px-3 py-1 bg-white/60 rounded-full hover:bg-white/80 transition-colors"
                        onclick="quickSearch('ce soir')">Ce soir</button>
                </div>
            </div>

            <!-- Floating Filters Panel (Hidden by default) -->
            <div id="filtersPanel"
                class="absolute top-full left-0 right-0 mt-2 glass-strong rounded-2xl p-6 shadow-2xl z-50 hidden transform transition-all duration-300">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                        <i data-lucide="grid" class="w-5 h-5 text-rosePastel"></i>
                        Cat√©gories
                    </h3>
                    <button id="closeFilters" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="mb-4 max-h-[60vh] overflow-y-auto">
                    <div class="flex flex-col gap-1" id="categoryTabs">
                        <button class="category-tab active px-4 py-2.5 rounded-xl text-sm font-medium w-fit"
                            data-category="all">
                            üè† Tous les services
                        </button>
                        <!-- Categories will be loaded dynamically -->
                    </div>
                </div>
                <div class="flex items-center justify-end pt-4 border-t border-gray-200">
                    <button id="clearAllFilters"
                        class="text-sm text-rosePastel hover:text-rosePastel/80 font-medium flex items-center gap-2 transition-colors">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        R√©initialiser
                    </button>
                </div>
            </div>
        </div>

        <!-- Professionals List - Airbnb Style (Shown when category/search selected, BEFORE map) -->
        <div id="professionalsResultsSection" class="mb-6 hidden transition-all duration-300">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-1">Professionnels disponibles</h2>
                    <p class="text-sm text-gray-600" id="resultsCount">0 r√©sultat(s) trouv√©(s)</p>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="professionalsList">
                <!-- Professionals will be loaded dynamically -->
            </div>
        </div>

        <!-- No Results - Shown BEFORE map when no professionals found -->
        <div id="noResults" class="text-center py-16 hidden mb-6">
            <div class="glass-strong rounded-2xl p-12 max-w-lg mx-auto">
                <div
                    class="w-20 h-20 bg-gradient-to-br from-pink-100 to-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="search-x" class="w-10 h-10 text-gray-400"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-3">Aucun professionnel trouv√©</h3>
                <p class="text-gray-600 mb-6">Essayez de modifier vos crit√®res de recherche</p>
                <div class="glass rounded-xl p-6">
                    <div class="flex items-center gap-3 mb-3">
                        <i data-lucide="lightbulb" class="w-5 h-5 text-yellow-500"></i>
                        <span class="font-medium text-gray-900">Conseil</span>
                    </div>
                    <p class="text-sm text-gray-600">Assurez-vous que des professionnels sont enregistr√©s avec des
                        coordonn√©es GPS dans votre base de donn√©es.</p>
                </div>
                <button onclick="loadProfessionals()"
                    class="grad-btn text-white px-6 py-3 rounded-xl font-semibold mt-6">
                    <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                    R√©essayer
                </button>
            </div>
        </div>

        <!-- Map Section - Full Width, Prominent -->
        <div class="glass rounded-3xl p-6 mb-6 shadow-xl overflow-hidden">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-2xl font-bold gradient-text mb-1">Professionnels pr√®s de vous</h2>
                    <p class="text-sm text-gray-500">Cliquez sur les marqueurs pour voir les d√©tails</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="stats-card px-4 py-2.5 rounded-xl">
                        <div class="flex items-center gap-2">
                            <i data-lucide="map-pin" class="w-4 h-4 text-rosePastel"></i>
                            <span class="text-sm font-semibold text-gray-800" id="professionalsCount">0</span>
                            <span class="text-xs text-gray-500">trouv√©s</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map Container - Larger and More Prominent -->
            <div class="map-container rounded-2xl overflow-hidden shadow-lg">
                <div id="professionalsMap" style="height: 600px;"></div>
            </div>

            <!-- Map Legend -->
            <div class="flex items-center justify-center gap-6 mt-4 text-sm">
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-rosePastel rounded-full shadow-sm"></div>
                    <span class="text-gray-600">Votre position</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-blueLight rounded-full shadow-sm"></div>
                    <span class="text-gray-600">Professionnels</span>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="text-center py-12 hidden">
            <div class="glass-strong rounded-2xl p-8 max-w-md mx-auto">
                <div
                    class="loading-spinner w-12 h-12 border-4 border-rosePastel border-t-transparent rounded-full mx-auto mb-4">
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Chargement des professionnels</h3>
                <p class="text-gray-600">Recherche en cours...</p>
            </div>
        </div>

        <!-- Quick Booking Modal -->
        <div id="quickBookModal"
            class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
            <div
                class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto transform transition-all">
                <div
                    class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between z-10">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">R√©server rapidement</h2>
                        <p class="text-sm text-gray-600 mt-1" id="quickBookProName"></p>
                    </div>
                    <button onclick="closeQuickBook()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <div class="p-6">
                    <!-- Service Info -->
                    <div class="mb-6 p-4 bg-gradient-to-r from-pink-50 to-blue-50 rounded-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Service</p>
                                <p class="text-lg font-semibold text-gray-900" id="quickBookService"></p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">Prix</p>
                                <p class="text-xl font-bold gradient-text" id="quickBookPrice"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Date Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-900 mb-3">
                            <i data-lucide="calendar" class="w-4 h-4 inline-block mr-2"></i>
                            Choisir une date
                        </label>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2" id="quickBookDates">
                            <!-- Dates will be loaded dynamically -->
                        </div>
                    </div>

                    <!-- Time Slots -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-900 mb-3">
                            <i data-lucide="clock" class="w-4 h-4 inline-block mr-2"></i>
                            Choisir un horaire
                        </label>
                        <div class="grid grid-cols-3 sm:grid-cols-4 gap-2" id="quickBookSlots">
                            <div class="text-center text-gray-400 py-8">
                                S√©lectionnez d'abord une date
                            </div>
                        </div>
                    </div>

                    <!-- Selected Slot Summary -->
                    <div id="quickBookSummary"
                        class="hidden mb-6 p-4 bg-gray-50 rounded-xl border-2 border-rosePastel/30">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-600 mb-1">R√©servation s√©lectionn√©e</p>
                                <p class="font-semibold text-gray-900" id="quickBookSelectedSlot"></p>
                            </div>
                            <button onclick="clearQuickBookSelection()"
                                class="text-sm text-rosePastel hover:text-rosePastel/80">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3">
                        <button onclick="closeQuickBook()"
                            class="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-xl font-semibold transition-all hover:bg-gray-200">
                            Annuler
                        </button>
                        <button onclick="submitQuickBooking()" id="quickBookSubmitBtn"
                            class="flex-1 px-6 py-3 grad-btn text-white rounded-xl font-semibold transition-all hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                            <i data-lucide="check" class="w-4 h-4 inline-block mr-2"></i>
                            Confirmer la r√©servation
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Floating Action Button -->
    <button class="floating-action rounded-full p-4 text-white shadow-lg" onclick="scrollToTop()">
        <i data-lucide="arrow-up" class="w-6 h-6"></i>
    </button>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
<script>
    // Global variables
    let map, markers = [];
    let professionals = [];
    let currentFilters = {
        search: '',
        category: 'all',
        priceMin: 0,
        priceMax: 300,
        minRating: 0,
        maxDistance: 5  // Default to 5km radius
    };
    let userLocation = null;

    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', function () {
        initMap();
        loadCategories();
        loadProfessionals();
        setupEventListeners();
    });

    // Helper function to set map view with 5km radius
    function setMapView5km(center) {
        if (!center || !map) return;

        // Calculate bounds for 5km radius (approximately)
        // 1 degree latitude ‚âà 111 km, so 5km ‚âà 0.045 degrees
        // For longitude, it varies by latitude, but we'll use a similar approximation
        const radiusKm = 5;
        const latDelta = radiusKm / 111; // ~0.045 degrees
        const lngDelta = radiusKm / (111 * Math.cos(center[0] * Math.PI / 180)); // Adjust for latitude

        const bounds = [
            [center[0] - latDelta, center[1] - lngDelta], // Southwest
            [center[0] + latDelta, center[1] + lngDelta]  // Northeast
        ];

        map.fitBounds(bounds, { padding: [20, 20] });
    }

    // Initialize map
    function initMap() {
        // Default to Nabeul center
        const defaultCenter = [36.4515, 10.7353];

        // Initialize map with default center (will be updated when location is available)
        map = L.map('professionalsMap').setView(defaultCenter, 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // Set initial view to 5km radius around default center
        setMapView5km(defaultCenter);

        // Fallback to server-provided client coordinates (if present)
        try {
            const sLat = parseFloat('{{ client_profile.latitude|default:"" }}');
            const sLng = parseFloat('{{ client_profile.longitude|default:"" }}');
            if (!isNaN(sLat) && !isNaN(sLng)) {
                userLocation = [sLat, sLng];
                // Update map view to 5km around user location
                setMapView5km(userLocation);
            }
        } catch (e) { }

        // Try to get browser geolocation (preferred)
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function (position) {
                    userLocation = [position.coords.latitude, position.coords.longitude];
                    // Always set view to 5km radius around user location
                    setMapView5km(userLocation);
                    loadProfessionals();
                },
                function (error) {
                    console.log('Geolocation error:', error);
                    // Fallback to default location with 5km view
                    setMapView5km(defaultCenter);
                    loadProfessionals();
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        } else {
            // Set default view with 5km radius
            setMapView5km(defaultCenter);
            loadProfessionals();
        }
    }

    // Load categories
    async function loadCategories() {
        try {
            let response = await fetch('/api/api/professionals/categories/');
            if (!response.ok) {
                // Fallback path
                response = await fetch('/users/api/professionals/categories/');
            }
            const data = await response.json();

            const tabsContainer = document.getElementById('categoryTabs');
            if (tabsContainer) {
                // Si on a des cat√©gories group√©es, les utiliser
                if (data.categories_grouped) {
                    // Vider le conteneur mais garder le bouton "Tous"
                    const allButton = tabsContainer.querySelector('[data-category="all"]');
                    tabsContainer.innerHTML = '';
                    if (allButton) tabsContainer.appendChild(allButton);

                    // Cr√©er les groupes avec accord√©on
                    Object.entries(data.categories_grouped).forEach(([groupName, items]) => {
                        const groupDiv = document.createElement('div');
                        groupDiv.className = 'category-group w-full';

                        // En-t√™te du groupe
                        const groupHeader = document.createElement('div');
                        groupHeader.className = 'category-group-header flex items-center gap-2 px-3 py-2 text-sm font-semibold text-gray-700 cursor-pointer hover:bg-gray-50 rounded-lg mt-2';
                        groupHeader.innerHTML = `
                            <i data-lucide="chevron-right" class="w-4 h-4 transition-transform group-chevron"></i>
                            <span>${groupName}</span>
                            <span class="text-xs text-gray-400">(${items.length})</span>
                        `;

                        // Conteneur des items (cach√© par d√©faut)
                        const itemsDiv = document.createElement('div');
                        itemsDiv.className = 'category-items flex flex-wrap gap-2 pl-6 hidden';

                        items.forEach(category => {
                            const button = document.createElement('button');
                            button.className = 'category-tab px-3 py-1.5 rounded-lg text-xs font-medium';
                            button.textContent = category.label;
                            button.dataset.category = category.code;
                            button.addEventListener('click', () => selectCategory(category.code));
                            itemsDiv.appendChild(button);
                        });

                        // Toggle accordion
                        groupHeader.addEventListener('click', () => {
                            itemsDiv.classList.toggle('hidden');
                            const chevron = groupHeader.querySelector('.group-chevron');
                            if (chevron) {
                                chevron.style.transform = itemsDiv.classList.contains('hidden') ? '' : 'rotate(90deg)';
                            }
                        });

                        groupDiv.appendChild(groupHeader);
                        groupDiv.appendChild(itemsDiv);
                        tabsContainer.appendChild(groupDiv);
                    });

                    // R√©initialiser les ic√¥nes Lucide
                    if (window.lucide) window.lucide.createIcons();
                } else {
                    // Fallback: affichage plat
                    data.categories.forEach(category => {
                        const button = document.createElement('button');
                        button.className = 'category-tab px-4 py-2.5 rounded-xl text-sm font-medium';
                        button.textContent = category.label;
                        button.dataset.category = category.code;
                        button.addEventListener('click', () => selectCategory(category.code));
                        tabsContainer.appendChild(button);
                    });
                }
            }
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    // Select category
    function selectCategory(category) {
        // Update active tab
        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        const selectedTab = document.querySelector(`[data-category="${category}"]`);
        if (selectedTab) {
            selectedTab.classList.add('active');
        }

        // Update filters and reload
        currentFilters.category = category;
        loadProfessionals();
    }

    // Load professionals
    async function loadProfessionals() {
        showLoading(true);

        try {
            const center = userLocation || [36.4515, 10.7353]; // Nabeul par d√©faut
            const params = new URLSearchParams({
                center_lat: center[0],
                center_lng: center[1],
                within_km: currentFilters.maxDistance.toString(),
                price_min: currentFilters.priceMin,
                price_max: currentFilters.priceMax,
                min_rating: currentFilters.minRating,
                category: currentFilters.category !== 'all' ? currentFilters.category : '',
                search: currentFilters.search
            });

            console.log('Fetching professionals with params:', params.toString());

            let response = await fetch(`/api/api/professionals/simple/?${params}`);
            if (!response.ok) {
                // Fallback path if first URL fails (e.g., 404)
                response = await fetch(`/users/api/professionals/simple/?${params}`);
            }
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('API Response:', data);
            console.log('Debug info:', data.debug);

            professionals = enrichProfessionals(data.results || []);

            // Afficher les statistiques dans la console
            if (data.debug) {
                console.log(`üìä Statistiques: ${data.debug.with_coordinates || 0} professionnels avec coordonn√©es sur ${data.debug.total_professionals || 0} total`);
            }

            // Appliquer les filtres c√¥t√© client
            professionals = applyClientFilters(professionals);

            displayProfessionals();
            updateMap();

        } catch (error) {
            console.error('Error loading professionals:', error);
            console.log('API failed, showing empty state');

            // Afficher un √©tat vide au lieu de donn√©es statiques
            professionals = [];

            displayProfessionals();
            updateMap();
        } finally {
            showLoading(false);
        }
    }

    // Enrich professionals: fallback coordinates by city and compute distance
    function enrichProfessionals(list) {
        const cityToCoords = {
            'tunis': [36.8065, 10.1815],
            'nabeul': [36.4515, 10.7353],
            'hammamet': [36.4008, 10.6149],
            'sousse': [35.8256, 10.6360],
            'sfax': [34.7406, 10.7603],
            'bizerte': [37.2746, 9.8739],
            'gabes': [33.8815, 10.0982],
            'gafsa': [34.4250, 8.7842],
            'kairouan': [35.6781, 10.0963],
            'monastir': [35.7770, 10.8262],
            'medenine': [33.3547, 10.5055],
            'tozeur': [33.9197, 8.1335]
        };
        function computeDistanceKm(a, b) {
            if (!a || !b) return null;
            const [lat1, lon1] = a; const [lat2, lon2] = b;
            if ([lat1, lon1, lat2, lon2].some(v => v == null || isNaN(v))) return null;
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const s1 = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(s1), Math.sqrt(1 - s1));
            return R * c;
        }
        const center = userLocation || [36.4515, 10.7353];
        return (list || []).map(p => {
            // Normalize lat/lng to numbers
            let lat = (p.lat != null) ? parseFloat(p.lat) : null;
            let lng = (p.lng != null) ? parseFloat(p.lng) : null;
            if ((lat == null || lng == null || isNaN(lat) || isNaN(lng)) && p.city) {
                const k = String(p.city).toLowerCase();
                if (cityToCoords[k]) { [lat, lng] = cityToCoords[k]; }
            }
            p.lat = lat; p.lng = lng;
            const d = computeDistanceKm(center, (lat != null && lng != null) ? [lat, lng] : null);
            if (d != null) p.distanceKm = Math.round(d * 10) / 10;
            return p;
        });
    }

    // Appliquer les filtres c√¥t√© client
    function applyClientFilters(pros) {
        let filtered = pros;

        // Filtre par recherche intelligente
        if (currentFilters.search) {
            const searchTerm = currentFilters.search.toLowerCase();

            // Extract date keywords (demain, aujourd'hui, ce soir, etc.)
            const dateKeywords = {
                'demain': 1,
                'aujourd\'hui': 0,
                'aujourdhui': 0,
                'ce soir': 0,
                'cesoir': 0,
                'maintenant': 0
            };

            // Remove date keywords from search for service matching
            let serviceSearch = searchTerm;
            for (const keyword in dateKeywords) {
                serviceSearch = serviceSearch.replace(keyword, '').trim();
            }

            // Filter by service/name/address
            filtered = filtered.filter(pro => {
                const matchesService = !serviceSearch ||
                    pro.name.toLowerCase().includes(serviceSearch) ||
                    pro.service.toLowerCase().includes(serviceSearch) ||
                    pro.address.toLowerCase().includes(serviceSearch);
                return matchesService;
            });
        }

        // Filtre par cat√©gorie
        if (currentFilters.category && currentFilters.category !== 'all') {
            filtered = filtered.filter(pro =>
                pro.service.toLowerCase().includes(currentFilters.category.toLowerCase())
            );
        }

        // Filtre par prix
        filtered = filtered.filter(pro =>
            pro.price >= currentFilters.priceMin &&
            pro.price <= currentFilters.priceMax
        );

        // Filtre par note minimum
        filtered = filtered.filter(pro =>
            pro.rating >= currentFilters.minRating
        );

        // Filtre par langue (si applicable)
        if (currentFilters.language) {
            // Pour l'instant, on ne filtre pas par langue car pas dans l'API
            // TODO: Ajouter le support des langues dans l'API
        }

        return filtered;
    }

    // Display professionals
    function displayProfessionals() {
        const container = document.getElementById('professionalsList');
        const noResults = document.getElementById('noResults');
        const professionalsCount = document.getElementById('professionalsCount');
        const resultsCount = document.getElementById('resultsCount');
        const resultsSection = document.getElementById('professionalsResultsSection');

        console.log('Displaying professionals:', professionals.length);

        // Check if a category is selected (not "all")
        const hasCategoryFilter = currentFilters.category && currentFilters.category !== 'all';
        const hasSearchFilter = currentFilters.search && currentFilters.search.trim() !== '';

        // Show/hide results section based on filters
        if (hasCategoryFilter || hasSearchFilter) {
            if (resultsSection) {
                resultsSection.classList.remove('hidden');
            }
        } else {
            if (resultsSection) {
                resultsSection.classList.add('hidden');
            }
            container.innerHTML = '';
            // Hide no results message when no search/filter is active
            if (noResults) noResults.classList.add('hidden');
            return;
        }

        // Update professionals count
        if (professionalsCount) {
            professionalsCount.textContent = professionals.length;
        }

        // Update results count
        if (resultsCount) {
            resultsCount.textContent = `${professionals.length} r√©sultat${professionals.length > 1 ? 's' : ''} trouv√©${professionals.length > 1 ? 's' : ''}`;
        }

        // Show no results message BEFORE map when no professionals found
        if (professionals.length === 0) {
            container.innerHTML = '';
            if (noResults) {
                noResults.classList.remove('hidden');
            }
            if (resultsSection) {
                resultsSection.classList.add('hidden');
            }
            return;
        }

        // Hide no results message when professionals are found
        if (noResults) noResults.classList.add('hidden');

        // Airbnb-style card design
        container.innerHTML = professionals.map((pro, index) => {
            // Assurer que toutes les valeurs existent
            const name = pro.name || 'Professionnel';
            const service = pro.service || 'Service';
            const rating = pro.rating || 0;
            const reviews = pro.reviews || 0;
            const price = pro.price || 0;
            const priceRange = pro.price_range || `${price} DT`;
            const distance = pro.distanceKm || 0;
            const address = pro.address || 'Adresse non disponible';
            const city = pro.city || '';
            const isVerified = pro.is_verified || false;

            return `
                <div class="group cursor-pointer" onclick="viewProfessional(${pro.id})">
                    <div class="relative overflow-hidden rounded-2xl bg-white shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-100 hover:border-gray-200">
                        <!-- Image Section -->
                        <div class="relative h-64 overflow-hidden bg-gradient-to-br from-pink-100 to-blue-100">
                            ${pro.profile_photo ?
                    `<img src="${pro.profile_photo}" alt="${name}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                    ${isVerified ? `<div class="absolute top-3 right-3 w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-lg">
                        <i data-lucide="check" class="w-4 h-4 text-green-500"></i>
                    </div>` : ''}` :
                    `<div class="w-full h-full flex items-center justify-center">
                        <i data-lucide="user" class="w-20 h-20 text-gray-300"></i>
                    </div>`
                }
                            <!-- Distance Badge -->
                            ${distance > 0 ? `<div class="absolute top-3 left-3 px-3 py-1.5 bg-white/90 backdrop-blur-sm rounded-full text-xs font-semibold text-gray-900 shadow-md">
                                <i data-lucide="map-pin" class="w-3 h-3 inline-block mr-1"></i>
                                ${Number(distance).toFixed(1)} km
                            </div>` : ''}
                        </div>

                        <!-- Content Section -->
                        <div class="p-4">
                            <!-- Title and Rating Row -->
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-lg font-semibold text-gray-900 truncate mb-1 group-hover:text-rosePastel transition-colors">
                                        ${name}
                                    </h3>
                                    <p class="text-sm text-gray-600 truncate">${service}</p>
                                </div>
                            </div>

                            <!-- Rating and Reviews -->
                            <div class="flex items-center gap-2 mb-3">
                                <div class="flex items-center gap-1">
                                    <i data-lucide="star" class="w-4 h-4 fill-current text-yellow-400"></i>
                                    <span class="text-sm font-medium text-gray-900">${rating.toFixed(1)}</span>
                                </div>
                                ${reviews > 0 ? `<span class="text-sm text-gray-500">(${reviews})</span>` : ''}
                                ${city ? `<span class="text-sm text-gray-500">‚Ä¢ ${city}</span>` : ''}
                            </div>

                            <!-- Location -->
                            <div class="flex items-center gap-1.5 mb-3 text-sm text-gray-600">
                                <i data-lucide="map-pin" class="w-3.5 h-3.5 flex-shrink-0"></i>
                                <span class="truncate">${address}</span>
                            </div>

                            <!-- Next Available Slots (Quick Preview) -->
                            <div class="mb-3 p-2 bg-gray-50 rounded-lg">
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="calendar" class="w-4 h-4 text-rosePastel"></i>
                                    <span class="text-xs font-semibold text-gray-700">Prochaines disponibilit√©s</span>
                                </div>
                                <div id="quickSlots_${pro.id}" class="flex flex-wrap gap-1.5">
                                    <div class="text-xs text-gray-500 animate-pulse">Chargement...</div>
                                </div>
                            </div>

                            <!-- Price and Actions -->
                            <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                                <div>
                                    <span class="text-xs text-gray-500">√Ä partir de</span>
                                    <p class="text-lg font-bold gradient-text">${priceRange}</p>
                                </div>
                            </div>
                            
                            <!-- Quick Book Button -->
                            <div class="mt-3 flex gap-2">
                                <button type="button" onclick="event.stopPropagation(); openQuickBook(${pro.id}, '${name}', '${service}', ${price});" 
                                    class="flex-1 px-4 py-2.5 grad-btn text-white rounded-lg font-semibold text-sm transition-all hover:scale-105 flex items-center justify-center gap-2 shadow-md">
                                    <i data-lucide="calendar-check" class="w-4 h-4"></i>
                                    R√©server maintenant
                                </button>
                                <button type="button" onclick="event.stopPropagation(); viewProfessional(${pro.id});" 
                                    class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium text-sm transition-all hover:bg-gray-200 flex items-center gap-1.5">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        // Re-initialize icons
        if (window.lucide) window.lucide.createIcons();

        // Load quick slots for each professional
        professionals.forEach(pro => {
            loadQuickSlots(pro.id);
        });
    }

    // Get CSRF token from cookies
    function getCsrf() {
        const name = 'csrftoken=';
        const parts = document.cookie.split(';');
        for (let p of parts) {
            p = p.trim();
            if (p.startsWith(name)) return p.substring(name.length);
        }
        return '';
    }

    // Quick search function
    function quickSearch(term) {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.value = term;
            currentFilters.search = term;
            loadProfessionals();
        }
    }

    // Quick booking state
    let quickBookState = {
        proId: null,
        proName: '',
        service: '',
        price: 0,
        selectedDate: null,
        selectedSlot: null
    };

    // Load quick slots preview on cards
    async function loadQuickSlots(proId) {
        const container = document.getElementById(`quickSlots_${proId}`);
        if (!container) return;

        try {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateStr = tomorrow.toISOString().split('T')[0];

            const response = await fetch(`/api/appointments/public/slots/?pro_id=${proId}&date=${dateStr}`);
            if (!response.ok) {
                container.innerHTML = '<span class="text-xs text-gray-400">Non disponible</span>';
                return;
            }

            const data = await response.json();
            const slots = data.results || [];

            // Filter out past slots - only show future slots
            const now = new Date();
            const futureSlots = slots.filter(slot => {
                const slotStart = new Date(slot.start);
                return slotStart > now; // Only keep slots that are in the future
            });

            if (futureSlots.length === 0) {
                container.innerHTML = '<span class="text-xs text-gray-400">Aucun cr√©neau disponible</span>';
                return;
            }

            // Show first 3 available future slots
            const previewSlots = futureSlots.slice(0, 3);
            container.innerHTML = previewSlots.map(slot => {
                const time = new Date(slot.start).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                return `<span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium">${time}</span>`;
            }).join('');
        } catch (error) {
            container.innerHTML = '<span class="text-xs text-gray-400">Chargement...</span>';
        }
    }

    // Open quick booking modal
    async function openQuickBook(proId, proName, service, price) {
        quickBookState = {
            proId: proId,
            proName: proName,
            service: service,
            price: price,
            selectedDate: null,
            selectedSlot: null
        };

        document.getElementById('quickBookProName').textContent = proName;
        document.getElementById('quickBookService').textContent = service;
        document.getElementById('quickBookPrice').textContent = `${price} DT`;

        const modal = document.getElementById('quickBookModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        // Load dates (next 7 days)
        loadQuickBookDates(proId);

        if (window.lucide) window.lucide.createIcons();
    }

    // Load available dates
    async function loadQuickBookDates(proId) {
        const container = document.getElementById('quickBookDates');
        container.innerHTML = '<div class="col-span-4 text-center py-4 text-gray-400">Chargement...</div>';

        const dates = [];
        const today = new Date();
        for (let i = 0; i < 7; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() + i);
            dates.push(date);
        }

        container.innerHTML = dates.map((date, index) => {
            const dateStr = date.toISOString().split('T')[0];
            const dayName = date.toLocaleDateString('fr-FR', { weekday: 'short' });
            const dayNum = date.getDate();
            const isToday = index === 0;

            return `
                <button onclick="selectQuickBookDate('${dateStr}', ${proId}, this)" 
                    class="p-3 rounded-xl border-2 border-gray-200 hover:border-rosePastel transition-all text-center ${isToday ? 'bg-rosePastel/10 border-rosePastel' : ''}">
                    <div class="text-xs text-gray-600">${dayName}</div>
                    <div class="text-lg font-bold text-gray-900">${dayNum}</div>
                </button>
            `;
        }).join('');

        if (window.lucide) window.lucide.createIcons();
    }

    // Select date and load slots
    async function selectQuickBookDate(dateStr, proId, buttonElement) {
        quickBookState.selectedDate = dateStr;
        quickBookState.selectedSlot = null;

        // Update date buttons
        document.querySelectorAll('#quickBookDates button').forEach(btn => {
            btn.classList.remove('bg-rosePastel/10', 'border-rosePastel');
            btn.classList.add('border-gray-200');
        });
        if (buttonElement) {
            buttonElement.classList.add('bg-rosePastel/10', 'border-rosePastel');
            buttonElement.classList.remove('border-gray-200');
        }

        // Load slots for selected date
        const container = document.getElementById('quickBookSlots');
        container.innerHTML = '<div class="col-span-4 text-center py-8 text-gray-400">Chargement...</div>';

        try {
            const response = await fetch(`/api/appointments/public/slots/?pro_id=${proId}&date=${dateStr}`);
            if (!response.ok) {
                container.innerHTML = '<div class="col-span-4 text-center py-8 text-gray-400">Aucun cr√©neau disponible</div>';
                return;
            }

            const data = await response.json();
            const slots = data.results || [];

            // Filter out past slots - only show future slots
            const now = new Date();
            const futureSlots = slots.filter(slot => {
                const slotStart = new Date(slot.start);
                return slotStart > now; // Only keep slots that are in the future
            });

            if (futureSlots.length === 0) {
                container.innerHTML = '<div class="col-span-4 text-center py-8 text-gray-400">Aucun cr√©neau disponible pour cette date</div>';
                return;
            }

            container.innerHTML = futureSlots.map(slot => {
                const start = new Date(slot.start);
                const end = new Date(slot.end);
                const timeStr = `${start.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })} - ${end.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;

                return `
                    <button onclick="selectQuickBookSlot('${slot.start}', '${slot.end}', this)" 
                        class="p-3 rounded-lg border-2 border-gray-200 hover:border-rosePastel hover:bg-rosePastel/5 transition-all text-center">
                        <div class="text-sm font-medium text-gray-900">${start.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</div>
                    </button>
                `;
            }).join('');
        } catch (error) {
            container.innerHTML = '<div class="col-span-4 text-center py-8 text-red-400">Erreur de chargement</div>';
        }
    }

    // Select time slot
    function selectQuickBookSlot(start, end, buttonElement) {
        quickBookState.selectedSlot = { start, end };

        // Update slot buttons
        document.querySelectorAll('#quickBookSlots button').forEach(btn => {
            btn.classList.remove('bg-rosePastel', 'text-white', 'border-rosePastel');
            btn.classList.add('border-gray-200');
        });
        if (buttonElement) {
            buttonElement.classList.add('bg-rosePastel', 'text-white', 'border-rosePastel');
            buttonElement.classList.remove('border-gray-200', 'hover:border-rosePastel', 'hover:bg-rosePastel/5');
        }

        // Show summary
        const startDate = new Date(start);
        const endDate = new Date(end);
        const dateStr = startDate.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
        const timeStr = `${startDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })} - ${endDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;

        document.getElementById('quickBookSelectedSlot').textContent = `${dateStr} √† ${timeStr}`;
        document.getElementById('quickBookSummary').classList.remove('hidden');
        document.getElementById('quickBookSubmitBtn').disabled = false;
    }

    // Clear selection
    function clearQuickBookSelection() {
        quickBookState.selectedSlot = null;
        document.getElementById('quickBookSummary').classList.add('hidden');
        document.getElementById('quickBookSubmitBtn').disabled = true;
        document.querySelectorAll('#quickBookSlots button').forEach(btn => {
            btn.classList.remove('bg-rosePastel', 'text-white', 'border-rosePastel');
            btn.classList.add('border-gray-200');
        });
    }

    // Submit quick booking
    async function submitQuickBooking() {
        if (!quickBookState.selectedSlot) {
            alert('Veuillez s√©lectionner un cr√©neau');
            return;
        }

        const submitBtn = document.getElementById('quickBookSubmitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 inline-block mr-2 animate-spin"></i>R√©servation en cours...';

        try {
            // Extract date and time from the selected slot (ISO format)
            const slotStart = new Date(quickBookState.selectedSlot.start);

            // Validate date parsing
            if (isNaN(slotStart.getTime())) {
                alert('‚ùå Erreur : Date invalide. Veuillez r√©essayer.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4 inline-block mr-2"></i>Confirmer la r√©servation';
                if (window.lucide) window.lucide.createIcons();
                return;
            }

            // Validate that the slot is not in the past
            const now = new Date();
            if (slotStart < now) {
                alert('‚ùå Erreur : Ce cr√©neau est dans le pass√©. Veuillez s√©lectionner un cr√©neau futur.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4 inline-block mr-2"></i>Confirmer la r√©servation';
                if (window.lucide) window.lucide.createIcons();
                return;
            }

            // Format date as YYYY-MM-DD (local date, not UTC)
            const year = slotStart.getFullYear();
            const month = String(slotStart.getMonth() + 1).padStart(2, '0');
            const day = String(slotStart.getDate()).padStart(2, '0');
            const appointmentDate = `${year}-${month}-${day}`;

            // Format time as HH:MM (24-hour format, local time)
            const hours = String(slotStart.getHours()).padStart(2, '0');
            const minutes = String(slotStart.getMinutes()).padStart(2, '0');
            const appointmentTime = `${hours}:${minutes}`;

            console.log('Booking data:', {
                proId: quickBookState.proId,
                date: appointmentDate,
                time: appointmentTime,
                service: quickBookState.service,
                price: quickBookState.price
            });

            const csrfToken = getCsrf();
            if (!csrfToken) {
                alert('‚ùå Erreur : Token de s√©curit√© manquant. Veuillez rafra√Æchir la page.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4 inline-block mr-2"></i>Confirmer la r√©servation';
                if (window.lucide) window.lucide.createIcons();
                return;
            }

            const response = await fetch(`/pro/${quickBookState.proId}/book/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                credentials: 'include',
                body: new URLSearchParams({
                    service_name: quickBookState.service,
                    service_price: quickBookState.price.toString(),
                    service_duration: '60',
                    appointment_date: appointmentDate,
                    appointment_time: appointmentTime,
                    client_notes: 'R√©servation rapide depuis le tableau de bord'
                })
            });

            if (response.ok) {
                const result = await response.json().catch(() => ({}));
                alert('‚úÖ R√©servation effectu√©e avec succ√®s ! Vous recevrez une confirmation par email.');
                closeQuickBook();
                // Optionally reload professionals
                loadProfessionals();
            } else {
                const errorData = await response.json().catch(() => ({ detail: 'Erreur lors de la r√©servation' }));
                const errorMessage = errorData.detail || errorData.error || 'Impossible de r√©server';
                console.error('Booking error response:', errorData);
                alert('‚ùå Erreur : ' + errorMessage);
            }
        } catch (error) {
            console.error('Booking error:', error);
            alert('‚ùå Erreur : Impossible de r√©server. Veuillez r√©essayer.');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4 inline-block mr-2"></i>Confirmer la r√©servation';
            if (window.lucide) window.lucide.createIcons();
        }
    }

    // Close quick book modal
    function closeQuickBook() {
        const modal = document.getElementById('quickBookModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        quickBookState = {
            proId: null,
            proName: '',
            service: '',
            price: 0,
            selectedDate: null,
            selectedSlot: null
        };
        document.getElementById('quickBookSummary').classList.add('hidden');
        document.getElementById('quickBookSubmitBtn').disabled = true;
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('quickBookModal');
            if (modal && !modal.classList.contains('hidden')) {
                closeQuickBook();
            }
        }
    });

    // Update map with professionals
    function updateMap() {
        console.log('Updating map with', professionals.length, 'professionals');

        // Clear existing markers
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];

        // Add client location marker if available
        if (userLocation) {
            const clientIcon = L.divIcon({
                className: 'client-marker',
                html: '<div class="cb-marker cb-marker-rose">üë§</div>',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
            const clientMarker = L.marker(userLocation, { icon: clientIcon, title: 'Votre position' }).addTo(map);
            clientMarker.bindPopup(`
                <div class="p-3" style="min-width: 150px;">
                    <div class="flex items-center gap-2">
                        <div style="background: #F28BB2; width: 12px; height: 12px; border-radius: 50%;"></div>
                        <strong>Votre position</strong>
                    </div>
                    <p class="text-xs text-gray-600 mt-1">Lat: ${userLocation[0].toFixed(4)}, Lng: ${userLocation[1].toFixed(4)}</p>
                </div>
            `);
            markers.push(clientMarker);
        }

        // Add markers for each professional
        let validMarkers = 0;
        professionals.forEach((pro, index) => {
            if (pro.lat != null && pro.lng != null && !isNaN(pro.lat) && !isNaN(pro.lng)) {
                validMarkers++;

                // Ic√¥ne bleue pour les professionnels
                const proIcon = L.divIcon({
                    className: 'pro-marker',
                    html: `<div class="cb-marker cb-marker-blue">${index + 1}</div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                const marker = L.marker([pro.lat, pro.lng], { icon: proIcon, title: pro.name || 'Professionnel' }).addTo(map);

                // Popup am√©lior√©
                const popupContent = `
                    <div class="p-3" style="min-width: 200px;">
                        <div class="flex items-center gap-2 mb-2">
                            <div style="background: #6CA9E0; width: 12px; height: 12px; border-radius: 50%;"></div>
                            <h3 class="font-bold text-gray-900">${pro.name || 'Professionnel'}</h3>
                        </div>
                        <p class="text-sm text-gray-600 mb-1">${pro.service || 'Service'}</p>
                        <div class="flex items-center gap-2 mb-2">
                            <div class="flex rating-stars">
                                ${Array(5).fill(0).map((_, i) =>
                    `<span style="color: ${i < Math.floor(pro.rating || 0) ? '#FCD34D' : '#D1D5DB'};">‚≠ê</span>`
                ).join('')}
                            </div>
                            <span class="text-xs text-gray-600">${pro.rating || 0} (${pro.reviews || 0})</span>
                        </div>
                        <p class="text-sm font-semibold text-rosePastel mb-1">${pro.price || 0} DT</p>
                        <p class="text-xs text-gray-500 mb-2">üìç ${pro.distanceKm || 0} km</p>
                        ${pro.address ? `<p class="text-xs text-gray-600 mb-2">${pro.address}</p>` : ''}
                        <button onclick="viewProfessional(${pro.id})" 
                                class="w-full px-3 py-2 bg-rosePastel text-white rounded-lg text-sm hover:bg-opacity-80 transition-colors">
                            Voir profil complet
                        </button>
                    </div>
                `;

                marker.bindPopup(popupContent);
                markers.push(marker);
            } else {
                console.warn('Professional without valid coordinates:', pro.name, 'lat:', pro.lat, 'lng:', pro.lng);
            }
        });

        console.log(`Added ${validMarkers} professional markers to map`);

        // Always maintain 5km radius view around user location when available
        if (userLocation) {
            // Always center on user location with 5km radius
            setMapView5km(userLocation);
        } else if (markers.length > 0) {
            // If no user location but we have markers, fit to markers
            const group = new L.featureGroup(markers);
            const bounds = group.getBounds();
            map.fitBounds(bounds.pad(0.1), { padding: [20, 20] });
        } else {
            // No markers and no user location, use default center with 5km view
            const defaultCenter = [36.4515, 10.7353];
            setMapView5km(defaultCenter);
        }
    }

    // View professional profile
    function viewProfessional(proId) {
        window.location.href = `/professional/${proId}/`;
    }

    // Reserve flow happens on the professional detail page after selecting a service

    // Setup event listeners
    function setupEventListeners() {
        // Search input - Enhanced with Enter key support
        const searchInput = document.getElementById('searchInput');
        let searchTimeout;

        // Real-time search with debounce
        searchInput.addEventListener('input', function () {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentFilters.search = this.value;
                loadProfessionals();
            }, 300); // Reduced delay for faster response
        });

        // Enter key for immediate search
        searchInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                clearTimeout(searchTimeout);
                currentFilters.search = this.value;
                loadProfessionals();
            }
        });

        // Focus search on page load for quick access
        if (searchInput && !searchInput.value) {
            setTimeout(() => {
                searchInput.focus();
            }, 300);
        }

        // Filter button - Toggle floating panel
        const filterBtn = document.getElementById('filterBtn');
        const filtersPanel = document.getElementById('filtersPanel');
        const closeFilters = document.getElementById('closeFilters');

        if (filterBtn) {
            filterBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                filtersPanel.classList.toggle('hidden');
            });
        }

        if (closeFilters) {
            closeFilters.addEventListener('click', function () {
                filtersPanel.classList.add('hidden');
            });
        }

        // Close filters panel when clicking outside
        document.addEventListener('click', function (e) {
            if (filtersPanel && filterBtn && !filtersPanel.contains(e.target) && !filterBtn.contains(e.target)) {
                filtersPanel.classList.add('hidden');
            }
        });
    }

    // Show/hide loading spinner
    function showLoading(show) {
        const spinner = document.getElementById('loadingSpinner');
        const list = document.getElementById('professionalsList');

        if (show) {
            spinner.classList.remove('hidden');
            list.innerHTML = '';
        } else {
            spinner.classList.add('hidden');
        }
    }

    // Show no results
    function showNoResults() {
        document.getElementById('professionalsList').innerHTML = '';
        document.getElementById('noResults').classList.remove('hidden');
    }

    // Scroll to top function
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    // Clear all filters - Only reset category and search
    function clearAllFilters() {
        // Reset search input
        const searchInput = document.getElementById('searchInput');
        if (searchInput) searchInput.value = '';

        // Reset category to all
        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        const allTab = document.querySelector('[data-category="all"]');
        if (allTab) allTab.classList.add('active');

        // Reset current filters
        currentFilters = {
            search: '',
            category: 'all',
            priceMin: 0,
            priceMax: 300,
            minRating: 0,
            maxDistance: 5,  // Keep default distance for API
            language: ''
        };

        // Reload professionals
        loadProfessionals();
    }

    // Add event listener for clear all filters button
    document.addEventListener('DOMContentLoaded', function () {
        const clearAllFiltersBtn = document.getElementById('clearAllFilters');
        if (clearAllFiltersBtn) {
            clearAllFiltersBtn.addEventListener('click', clearAllFilters);
        }
    });

    // Add smooth scroll behavior
    document.documentElement.style.scrollBehavior = 'smooth';

    // Helpers
    function serviceLabel(s) {
        if (typeof s === 'string') return s;
        if (!s || typeof s !== 'object') return 'Service';
        return s.name || s.Name || s.service || s.label || (Array.isArray(Object.values(s)) ? Object.values(s)[0] : 'Service');
    }
</script>

<!-- Lightweight animated accessories background (like admin login) -->
<script>
    (function () {
        const container = document.getElementById('three-bg'); if (!container || !window.THREE) return;
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.z = 7;
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.8));
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));

        function makeAccessoryTexture(kind, size = 192) {
            const c = document.createElement('canvas'); c.width = c.height = size; const ctx = c.getContext('2d');
            ctx.clearRect(0, 0, size, size); ctx.lineJoin = 'round'; ctx.lineCap = 'round';
            const grad = ctx.createLinearGradient(0, 0, size, size); grad.addColorStop(0, '#F28BB2'); grad.addColorStop(1, '#6CA9E0');
            ctx.fillStyle = grad; ctx.strokeStyle = grad; ctx.lineWidth = size * 0.07; ctx.shadowColor = 'rgba(0,0,0,0.15)'; ctx.shadowBlur = size * 0.06; ctx.shadowOffsetY = size * 0.02;
            if (kind === 'lipstick') { ctx.fillRect(size * 0.42, size * 0.48, size * 0.16, size * 0.28); ctx.fillRect(size * 0.40, size * 0.30, size * 0.20, size * 0.18); ctx.beginPath(); ctx.moveTo(size * 0.40, size * 0.30); ctx.lineTo(size * 0.60, size * 0.30); ctx.lineTo(size * 0.50, size * 0.15); ctx.closePath(); ctx.fill(); }
            else if (kind === 'comb') { ctx.fillRect(size * 0.22, size * 0.56, size * 0.56, size * 0.12); for (let i = 0; i < 12; i++) { ctx.fillRect(size * (0.24 + i * 0.045), size * 0.38, size * 0.02, size * 0.18); } }
            else if (kind === 'scissors') { ctx.lineWidth = size * 0.05; ctx.beginPath(); ctx.moveTo(size * 0.28, size * 0.66); ctx.lineTo(size * 0.74, size * 0.34); ctx.stroke(); ctx.beginPath(); ctx.moveTo(size * 0.28, size * 0.34); ctx.lineTo(size * 0.74, size * 0.66); ctx.stroke(); ctx.lineWidth = size * 0.06; ctx.beginPath(); ctx.arc(size * 0.28, size * 0.34, size * 0.10, 0, Math.PI * 2); ctx.stroke(); ctx.beginPath(); ctx.arc(size * 0.28, size * 0.66, size * 0.10, 0, Math.PI * 2); ctx.stroke(); }
            else if (kind === 'nail') { ctx.fillRect(size * 0.36, size * 0.44, size * 0.28, size * 0.26); ctx.fillRect(size * 0.44, size * 0.22, size * 0.12, size * 0.20); ctx.beginPath(); ctx.moveTo(size * 0.44, size * 0.22); ctx.lineTo(size * 0.56, size * 0.22); ctx.lineTo(size * 0.50, size * 0.12); ctx.closePath(); ctx.fill(); }
            else if (kind === 'dryer') { if (!ctx.roundRect) { ctx.roundRect = function (x, y, w, h, r) { this.beginPath(); this.moveTo(x + r, y); this.arcTo(x + w, y, x + w, y + h, r); this.arcTo(x + w, y + h, x, y + h, r); this.arcTo(x, y + h, x, y, r); this.arcTo(x, y, x + w, y, r); this.closePath(); }; } ctx.beginPath(); ctx.roundRect(size * 0.30, size * 0.30, size * 0.40, size * 0.22, size * 0.10); ctx.fill(); ctx.fillRect(size * 0.70, size * 0.36, size * 0.16, size * 0.10); ctx.beginPath(); ctx.roundRect(size * 0.36, size * 0.50, size * 0.12, size * 0.20, size * 0.06); ctx.fill(); }
            return new THREE.CanvasTexture(c);
        }
        const kinds = ['lipstick', 'comb', 'scissors', 'nail', 'dryer'];
        const accessories = new THREE.Group(); scene.add(accessories);
        for (let i = 0; i < 22; i++) { const k = kinds[i % kinds.length]; const tex = makeAccessoryTexture(k); const mat = new THREE.SpriteMaterial({ map: tex, transparent: true, depthWrite: false, opacity: 0.38 }); const sp = new THREE.Sprite(mat); sp.position.set((Math.random() - 0.5) * 20, (Math.random() - 0.3) * 10, -1.5 - Math.random()); const s = 0.9 + Math.random() * 1.7; sp.scale.set(s, s, 1); sp.userData = { vy: 0.003 + Math.random() * 0.004, vx: (Math.random() - 0.5) * 0.003, vr: (Math.random() - 0.5) * 0.006 }; accessories.add(sp); }
        let targetX = 0, targetY = 0; window.addEventListener('mousemove', (e) => { const nx = (e.clientX / window.innerWidth) * 2 - 1; const ny = (e.clientY / window.innerHeight) * 2 - 1; targetX = nx; targetY = ny; });
        function animate() { requestAnimationFrame(animate); for (const a of accessories.children) { a.position.x += a.userData.vx; a.position.y += a.userData.vy; a.rotation.z += a.userData.vr; if (a.position.y > 6) { a.position.y = -4 - Math.random() * 2; a.position.x = (Math.random() - 0.5) * 20; } } scene.position.x += (targetX * 0.35 - scene.position.x) * 0.02; scene.position.y += (-targetY * 0.25 - scene.position.y) * 0.02; renderer.render(scene, camera); }
        function onResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }
        window.addEventListener('resize', onResize);
        animate();
    })();
</script>
{% endblock %}