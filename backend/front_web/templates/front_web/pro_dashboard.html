{% extends 'front_web/base_prof.html' %}

{% block title %}Détail du Professionnel - Coucou Beauté{% endblock %}

{% block extra_css %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    .animate-pulse-slow {
        animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    .animate-fade-in {
        animation: fadeIn 0.6s ease-out;
    }

    .animate-slide-up {
        animation: slideUp 0.4s ease-out;
    }

    .animate-bounce-in {
        animation: bounceIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes bounceIn {
        0% {
            opacity: 0;
            transform: scale(0.3);
        }

        50% {
            opacity: 1;
            transform: scale(1.05);
        }

        70% {
            transform: scale(0.9);
        }

        100% {
            opacity: 1;
            transform: scale(1);
        }
    }

    .schedule-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        cursor: pointer;
    }

    .schedule-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
    }

    /* Créneaux réservés - Confirmé (Vert) */
    .schedule-card.confirmed {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-color: rgba(16, 185, 129, 0.3);
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.25);
    }

    .schedule-card.confirmed:hover {
        box-shadow: 0 8px 24px rgba(16, 185, 129, 0.35);
    }

    /* Créneaux en attente (Jaune) */
    .schedule-card.pending {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        border-color: rgba(245, 158, 11, 0.3);
        box-shadow: 0 4px 16px rgba(245, 158, 11, 0.25);
    }

    .schedule-card.pending:hover {
        box-shadow: 0 8px 24px rgba(245, 158, 11, 0.35);
    }

    /* Créneaux terminés */
    .schedule-card.completed {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        border-color: rgba(99, 102, 241, 0.3);
        box-shadow: 0 4px 16px rgba(99, 102, 241, 0.25);
    }

    /* Créneaux annulés */
    .schedule-card.cancelled {
        background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
        border-color: rgba(107, 114, 128, 0.3);
        box-shadow: 0 4px 16px rgba(107, 114, 128, 0.25);
        opacity: 0.7;
    }

    /* Créneaux disponibles (Gris clair vers blanc) */
    .schedule-card.available {
        background: linear-gradient(135deg, #f3f4f6 0%, #ffffff 100%);
        border: 2px dashed #d1d5db;
    }

    .schedule-card.available:hover {
        background: linear-gradient(135deg, #e5e7eb 0%, #f9fafb 100%);
        border-color: #9ca3af;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    /* Styles pour la vue calendrier */
    .view-toggle-btn {
        color: #6b7280;
        background: transparent;
    }

    .view-toggle-btn.active {
        color: white;
        background: linear-gradient(135deg, #ec4899 0%, #a855f7 100%);
        box-shadow: 0 2px 8px rgba(236, 72, 153, 0.3);
    }

    .time-slot-row {
        border-bottom: 1px solid #f3f4f6;
        min-height: 60px;
        transition: background-color 0.2s;
    }

    .time-slot-row:hover {
        background-color: #fafafa;
    }

    .appointment-block {
        border-radius: 0.75rem;
        padding: 0.75rem;
        margin: 0.25rem 0;
        cursor: pointer;
        transition: all 0.2s;
        border-left: 4px solid;
    }

    .appointment-block:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .appointment-block.confirmed {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        border-left-color: #10b981;
    }

    .appointment-block.pending {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-left-color: #f59e0b;
    }

    .appointment-block.cancelled {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-left-color: #ef4444;
        opacity: 0.7;
    }

    .empty-slot {
        min-height: 60px;
        border: 2px dashed #e5e7eb;
        border-radius: 0.5rem;
        background: #fafafa;
        transition: all 0.2s;
    }

    .empty-slot:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
    }

    .glassmorphism {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .particle-bg {
        position: relative;
        overflow: hidden;
    }

    .particle-bg::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
        animation: float 6s ease-in-out infinite;
    }

    @keyframes float {

        0%,
        100% {
            transform: translateY(0px) rotate(0deg);
        }

        33% {
            transform: translateY(-10px) rotate(1deg);
        }

        66% {
            transform: translateY(5px) rotate(-1deg);
        }
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        animation: pulse 2s infinite;
    }

    .status-indicator.confirmed {
        background-color: #ef4444;
    }

    .status-indicator.pending {
        background-color: #f59e0b;
    }

    .status-indicator.completed {
        background-color: #10b981;
    }

    .status-indicator.cancelled {
        background-color: #6b7280;
    }

    .time-slot {
        font-family: 'Inter', sans-serif;
        font-weight: 500;
    }

    .service-name {
        font-family: 'Inter', sans-serif;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .client-name {
        font-family: 'Inter', sans-serif;
        font-weight: 400;
        font-size: 0.75rem;
        opacity: 0.9;
    }

    .duration-badge {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* ==========================
       RESPONSIVE MOBILE OPTIMIZATIONS
       ========================== */
    @media (max-width: 768px) {

        /* Mobile-friendly body */
        body {
            font-size: 16px !important;
            /* Prevent iOS zoom */
            -webkit-text-size-adjust: 100%;
        }

        /* Page padding mobile */
        .p-6 {
            padding: 1rem !important;
        }

        /* Header mobile */
        .flex.items-center.justify-between.gap-3 {
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 1rem !important;
        }

        .w-12.h-12 {
            width: 2.5rem !important;
            height: 2.5rem !important;
        }

        h1.text-3xl {
            font-size: 1.5rem !important;
        }

        h2.text-2xl {
            font-size: 1.25rem !important;
        }

        h3.text-xl {
            font-size: 1.125rem !important;
        }

        /* KPI cards mobile */
        .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4 {
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 0.75rem !important;
        }

        .kpi-glass {
            padding: 0.75rem !important;
        }

        .kpi-glass .text-sm {
            font-size: 0.75rem !important;
        }

        .kpi-glass .text-xl {
            font-size: 1rem !important;
        }

        .kpi-glass .text-2xl {
            font-size: 1.125rem !important;
        }

        /* Glass cards mobile */
        .glass,
        .glass-card {
            padding: 1rem !important;
            border-radius: 1rem !important;
        }

        /* Analytics section mobile */
        .grid.grid-cols-1.xl\\:grid-cols-3 {
            grid-template-columns: 1fr !important;
            gap: 1rem !important;
        }

        .xl\\:col-span-2 {
            grid-column: span 1 !important;
        }

        /* Charts mobile */
        canvas {
            max-height: 200px !important;
        }

        /* Date inputs touch-friendly */
        input[type="date"],
        input[type="text"],
        select,
        textarea {
            font-size: 16px !important;
            padding: 0.75rem !important;
            min-height: 44px;
        }

        /* Buttons touch-friendly */
        button,
        .btn-glass,
        .btn-secondary-glass {
            min-height: 44px;
            padding: 0.75rem 1rem !important;
            font-size: 1rem !important;
            touch-action: manipulation;
        }

        /* Agenda section mobile */
        #dayPicker {
            width: 100% !important;
            max-width: 100% !important;
        }

        .flex.items-center.gap-3 {
            flex-direction: column !important;
            gap: 0.75rem !important;
            width: 100%;
        }

        .flex.items-center.gap-3>* {
            width: 100%;
        }

        /* Timeline/Schedule mobile */
        #timeline {
            padding: 1rem !important;
            border-radius: 1rem !important;
        }

        #scheduleGrid {
            gap: 0.5rem !important;
        }

        .schedule-card {
            padding: 0.75rem !important;
            border-radius: 0.75rem !important;
        }

        .schedule-card .time-slot {
            font-size: 0.75rem !important;
        }

        .schedule-card .service-name {
            font-size: 0.75rem !important;
        }

        .schedule-card .client-name {
            font-size: 0.6875rem !important;
        }

        .duration-badge {
            font-size: 0.6875rem !important;
            padding: 0.25rem 0.5rem !important;
        }

        /* Info section mobile */
        .grid.md\\:grid-cols-2 {
            grid-template-columns: 1fr !important;
            gap: 0.75rem !important;
        }

        .md\\:col-span-2 {
            grid-column: span 1 !important;
        }

        .grid.lg\\:grid-cols-3 {
            grid-template-columns: 1fr !important;
        }

        .grid.sm\\:grid-cols-2 {
            grid-template-columns: 1fr !important;
        }

        /* Services cards mobile */
        .p-3.rounded-lg {
            padding: 0.75rem !important;
            font-size: 0.875rem !important;
        }

        /* Gallery mobile */
        .w-24.h-24 {
            width: 5rem !important;
            height: 5rem !important;
        }

        /* Stats cards mobile */
        .stats-card {
            padding: 0.75rem !important;
        }

        /* Review section mobile */
        .grid.grid-cols-1.md\\:grid-cols-3 {
            grid-template-columns: 1fr !important;
            gap: 0.75rem !important;
        }

        /* Icons sizing */
        [data-lucide] {
            width: 1rem !important;
            height: 1rem !important;
        }

        .w-6.h-6 [data-lucide] {
            width: 1.25rem !important;
            height: 1.25rem !important;
        }

        /* Modal mobile */
        .modal .bg-white {
            width: calc(100% - 2rem) !important;
            max-width: calc(100% - 2rem) !important;
            margin: 1rem !important;
            padding: 1rem !important;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }

        /* Textarea mobile */
        textarea {
            font-size: 16px !important;
            min-height: 120px;
        }

        /* Action buttons mobile */
        .flex.flex-col.gap-2 {
            gap: 0.75rem !important;
        }

        .flex.flex-col.gap-2 button {
            width: 100%;
            justify-content: center;
        }

        /* Spacing adjustments */
        .space-y-6>*+* {
            margin-top: 1.5rem !important;
        }

        .gap-4 {
            gap: 0.75rem !important;
        }

        .gap-6 {
            gap: 1rem !important;
        }

        /* Animate adjustments for mobile */
        .animate-fade-in,
        .animate-slide-up,
        .animate-bounce-in {
            animation-duration: 0.3s !important;
        }

        /* Chart containers mobile */
        .bg-white\/40 {
            padding: 0.75rem !important;
        }

        /* Working days badges */
        .flex.flex-wrap.gap-2 {
            gap: 0.5rem !important;
        }

        .px-2.py-1 {
            padding: 0.375rem 0.625rem !important;
            font-size: 0.75rem !important;
        }

        /* Social links mobile */
        .space-y-1 {
            font-size: 0.875rem !important;
        }

        /* Image preview mobile */
        .w-16.h-16 {
            width: 3.5rem !important;
            height: 3.5rem !important;
        }
    }

    /* Small mobile (iPhone SE, etc.) */
    @media (max-width: 375px) {
        .p-6 {
            padding: 0.75rem !important;
        }

        h1.text-3xl {
            font-size: 1.25rem !important;
        }

        .kpi-glass {
            padding: 0.5rem !important;
        }

        .glass,
        .glass-card {
            padding: 0.75rem !important;
        }

        button {
            font-size: 0.9375rem !important;
            padding: 0.625rem 0.875rem !important;
        }

        .schedule-card {
            padding: 0.5rem !important;
        }

        canvas {
            max-height: 150px !important;
        }
    }

    /* Landscape mobile optimization */
    @media (max-width: 768px) and (orientation: landscape) {
        .p-6 {
            padding: 0.75rem !important;
        }

        h1.text-3xl {
            font-size: 1.25rem !important;
        }

        canvas {
            max-height: 150px !important;
        }

        #timeline {
            max-height: 300px;
            overflow-y: auto;
        }
    }

    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {

        /* Enhanced touch targets */
        button,
        a,
        label,
        .schedule-card {
            cursor: pointer;
            -webkit-tap-highlight-color: rgba(242, 139, 178, 0.2);
        }

        /* Smooth scrolling */
        * {
            -webkit-overflow-scrolling: touch;
        }

        /* Active states */
        button:active {
            opacity: 0.8;
            transform: scale(0.98);
        }

        .schedule-card:active {
            transform: scale(0.98) !important;
        }
    }

    /* iOS Safari specific fixes */
    @supports (-webkit-touch-callout: none) {

        /* Fix iOS input zoom */
        input,
        select,
        textarea {
            font-size: max(16px, 1rem) !important;
        }

        /* Fix iOS viewport height */
        .min-h-screen {
            min-height: -webkit-fill-available;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="p-6 space-y-6">
    <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
            <div
                class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-400 to-blue-400 flex items-center justify-center text-white">
                <i data-lucide="factory" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Centre professionnel</h1>
                <p class="text-gray-600 mt-1">Vue analytique et informations clés</p>
            </div>
        </div>

    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="kpi-glass flex items-center gap-4 p-5">
            <div
                class="w-12 h-12 rounded-xl overflow-hidden bg-gradient-to-br from-pink-300 to-blue-300 flex items-center justify-center">
                {% if pro.extra.profile_photo %}
                <img src="{{ pro.extra.profile_photo.url }}" class="w-12 h-12 object-cover" />
                {% else %}
                <i data-lucide="image" class="w-6 h-6 text-white"></i>
                {% endif %}
            </div>
            <div class="flex-1">
                <div class="text-sm text-gray-600">Photo</div>
                <div class="text-xs text-gray-500">Profil du centre</div>
            </div>
        </div>
        <div class="kpi-glass flex items-center gap-4 p-5">
            <div
                class="w-12 h-12 rounded-xl bg-gradient-to-br from-pink-300 to-blue-300 flex items-center justify-center text-white">
                <i data-lucide="building-2" class="w-6 h-6"></i>
            </div>
            <div class="flex-1">
                <div class="text-sm text-gray-600">Nom du centre</div>
                <div class="text-xl font-semibold">{{ pro.business_name|default:'—' }}</div>
            </div>
        </div>
        <div class="kpi-glass flex items-center gap-4 p-5">
            <div
                class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-300 to-teal-300 flex items-center justify-center text-white">
                <i data-lucide="badge-check" class="w-6 h-6"></i>
            </div>
            <div class="flex-1">
                <div class="text-sm text-gray-600">Vérifié</div>
                <div class="text-xl font-semibold">{{ pro.is_verified|yesno:'Oui,Non' }}</div>
            </div>
        </div>
        <div class="kpi-glass flex items-center gap-4 p-5">
            <div
                class="w-12 h-12 rounded-xl bg-gradient-to-br from-yellow-200 to-amber-300 flex items-center justify-center text-white">
                <i data-lucide="calendar-days" class="w-6 h-6"></i>
            </div>
            <div class="flex-1">
                <div class="text-sm text-gray-600">Total RDV</div>
                <div class="text-xl font-semibold">{{ total_appointments }}</div>
            </div>
        </div>
        <div class="kpi-glass flex items-center gap-4 p-5">
            <div
                class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-300 to-pink-300 flex items-center justify-center text-white">
                <i data-lucide="banknote" class="w-6 h-6"></i>
            </div>
            <div class="flex-1">
                <div class="text-sm text-gray-600">Revenus</div>
                <div class="text-xl font-semibold">{{ total_revenue }} DT</div>
            </div>
        </div>
        <div class="kpi-glass flex items-center gap-4 p-5">
            <div
                class="w-12 h-12 rounded-xl bg-gradient-to-br from-violet-300 to-pink-300 flex items-center justify-center text-white">
                <i data-lucide="mail" class="w-6 h-6"></i>
            </div>
            <div class="flex-1">
                <div class="text-sm text-gray-600">Email</div>
                <div class="text-xl font-semibold">{{ pro.user.email }}</div>
            </div>
        </div>
    </div>

    <!-- Section Avis -->
    <div class="glass-card p-6">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <div
                    class="w-12 h-12 rounded-xl bg-gradient-to-br from-yellow-400 to-orange-400 flex items-center justify-center text-white">
                    <i data-lucide="star" class="w-6 h-6"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-900">Gestion des Avis</h3>
                    <p class="text-gray-600">Gérez et répondez aux avis de vos clients</p>
                </div>
            </div>

        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl">
                <div class="text-2xl font-bold text-blue-600">{{ pro.extra.reviews|default:0 }}</div>
                <div class="text-sm text-gray-600">Total avis</div>
            </div>
            <div class="text-center p-4 bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl">
                <div class="text-2xl font-bold text-green-600">{{ pro.extra.rating|default:'—' }}</div>
                <div class="text-sm text-gray-600">Note moyenne</div>
            </div>
            <div class="text-center p-4 bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl">
                <div class="text-2xl font-bold text-purple-600">{% if pro.extra.reviews > 0 %}100{% else %}0{% endif %}%
                </div>
                <div class="text-sm text-gray-600">Satisfaction</div>
            </div>
        </div>
    </div>

    <div class="glass p-6">
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-xl font-semibold text-gray-900">Analytique</h2>
            <div class="flex items-center gap-2 text-sm">
                <input id="anFrom" type="date" class="border rounded-lg px-2 py-1" />
                <span>→</span>
                <input id="anTo" type="date" class="border rounded-lg px-2 py-1" />
                <button class="btn-secondary-glass" onclick="reloadAnalytics()">Appliquer</button>
            </div>
        </div>
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <div class="bg-white/40 rounded-xl border p-4 xl:col-span-2">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-medium text-gray-700">Tendance quotidienne</h3>
                    <div class="text-xs text-gray-500">Réservations par jour</div>
                </div>
                <canvas id="chartTrend" height="120"></canvas>
            </div>
            <div class="bg-white/40 rounded-xl border p-4">
                <h3 class="text-sm font-medium text-gray-700 mb-2">Répartition des services</h3>
                <canvas id="chartServices" height="120"></canvas>
            </div>
        </div>
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mt-6">
            <div class="bg-white/40 rounded-xl border p-4">
                <h3 class="text-sm font-medium text-gray-700 mb-2">Par heure de la journée</h3>
                <canvas id="chartHourly" height="120"></canvas>
            </div>
            <div class="bg-white/40 rounded-xl border p-4">
                <h3 class="text-sm font-medium text-gray-700 mb-2">Réservations par semaine</h3>
                <canvas id="chartReservations" height="120"></canvas>
            </div>
            <div class="bg-white/40 rounded-xl border p-4">
                <h3 class="text-sm font-medium text-gray-700 mb-2">Chiffre d'affaires</h3>
                <canvas id="chartRevenue" height="120"></canvas>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
            <div class="kpi-glass p-4">
                <div class="text-xs text-gray-500">En attente</div>
                <div id="kpiPending" class="text-2xl font-semibold">—</div>
            </div>
            <div class="kpi-glass p-4">
                <div class="text-xs text-gray-500">Confirmés</div>
                <div id="kpiConfirmed" class="text-2xl font-semibold">—</div>
            </div>
            <div class="kpi-glass p-4">
                <div class="text-xs text-gray-500">Annulés</div>
                <div id="kpiCancelled" class="text-2xl font-semibold">—</div>
            </div>
            <div class="kpi-glass p-4">
                <div class="text-xs text-gray-500">Terminés</div>
                <div id="kpiCompleted" class="text-2xl font-semibold">—</div>
            </div>
        </div>
    </div>
    <!-- Agenda du jour - Refonte complète avec vue calendrier -->
    <div class="glass p-6 relative">
        <!-- En-tête avec navigation et filtres -->
        <div
            class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6 pb-4 border-b border-pink-100">
            <div class="flex items-center gap-3">
                <div
                    class="w-12 h-12 rounded-xl bg-gradient-to-br from-pink-400 via-purple-400 to-pink-500 flex items-center justify-center shadow-lg">
                    <i data-lucide="calendar" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <h2
                        class="text-2xl font-bold bg-gradient-to-r from-pink-600 to-purple-600 bg-clip-text text-transparent mb-1">
                        Agenda professionnel
                    </h2>
                    <p class="text-gray-600 text-sm">Gestion des créneaux horaires en temps réel</p>
                </div>
            </div>

            <!-- Contrôles de navigation -->
            <div class="flex flex-wrap items-center gap-3">
                <!-- Sélecteur de date -->
                <div class="relative">
                    <input id="dayPicker" type="date"
                        class="bg-white/90 backdrop-blur-sm border-2 border-pink-200 rounded-xl px-4 py-2.5 pr-10 text-gray-700 focus:border-pink-400 focus:ring-2 focus:ring-pink-100 transition-all duration-200 shadow-sm hover:shadow-md w-full md:w-auto" />
                    <i data-lucide="calendar"
                        class="w-5 h-5 text-pink-400 absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none"></i>
                </div>

                <!-- Toggle Vue Jour/Semaine -->
                <div class="flex items-center gap-2 bg-white/80 backdrop-blur-sm border border-pink-200 rounded-xl p-1">
                    <button id="viewDayBtn" onclick="switchView('day')"
                        class="view-toggle-btn active px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                        <i data-lucide="calendar-days" class="w-4 h-4 inline mr-1"></i>
                        Jour
                    </button>
                    <button id="viewWeekBtn" onclick="switchView('week')"
                        class="view-toggle-btn px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                        <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>
                        Semaine
                    </button>
                </div>

                <!-- Bouton Actualiser -->
                <button onclick="reloadAgenda()"
                    class="bg-gradient-to-r from-pink-500 to-purple-600 text-white px-4 py-2.5 rounded-xl font-medium shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 flex items-center gap-2">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">Actualiser</span>
                </button>
            </div>
        </div>

        <!-- Filtres et recherche -->
        <div class="flex flex-wrap items-center gap-3 mb-6">
            <div class="flex-1 min-w-[200px]">
                <div class="relative">
                    <i data-lucide="search"
                        class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"></i>
                    <input type="text" id="searchClient" placeholder="Rechercher un client..."
                        class="w-full pl-10 pr-4 py-2 bg-white/90 border-2 border-pink-200 rounded-xl text-sm focus:border-pink-400 focus:ring-2 focus:ring-pink-100 transition-all">
                </div>
            </div>
            <select id="filterService"
                class="px-4 py-2 bg-white/90 border-2 border-pink-200 rounded-xl text-sm focus:border-pink-400 focus:ring-2 focus:ring-pink-100 transition-all">
                <option value="">Tous les services</option>
            </select>
            <select id="filterStatus"
                class="px-4 py-2 bg-white/90 border-2 border-pink-200 rounded-xl text-sm focus:border-pink-400 focus:ring-2 focus:ring-pink-100 transition-all">
                <option value="">Tous les statuts</option>
                <option value="confirmed">Confirmés</option>
                <option value="pending">En attente</option>
                <option value="cancelled">Annulés</option>
            </select>
        </div>

        <!-- Légende des statuts -->
        <div
            class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-gradient-to-r from-pink-50 to-purple-50 rounded-xl border border-pink-100">
            <span class="text-xs font-semibold text-gray-600 uppercase tracking-wider">Statuts :</span>
            <span class="flex items-center gap-2 text-xs">
                <span class="w-3 h-3 rounded-full bg-green-400 shadow-sm"></span>
                <span class="text-gray-700">Confirmé</span>
            </span>
            <span class="flex items-center gap-2 text-xs">
                <span class="w-3 h-3 rounded-full bg-yellow-400 shadow-sm"></span>
                <span class="text-gray-700">En attente</span>
            </span>
            <span class="flex items-center gap-2 text-xs">
                <span class="w-3 h-3 rounded-full bg-gray-300 shadow-sm"></span>
                <span class="text-gray-700">Disponible</span>
            </span>
            <span class="flex items-center gap-2 text-xs">
                <span class="w-3 h-3 rounded-full bg-red-400 shadow-sm"></span>
                <span class="text-gray-700">Annulé</span>
            </span>
        </div>

        <!-- Vue Calendrier - Jour -->
        <div id="calendarViewDay" class="calendar-view">
            <div class="bg-white rounded-2xl border border-pink-100 shadow-sm overflow-hidden">
                <!-- En-tête avec heures -->
                <div
                    class="grid grid-cols-12 gap-2 p-4 bg-gradient-to-r from-pink-50 to-purple-50 border-b border-pink-100">
                    <div class="col-span-2 text-xs font-semibold text-gray-600 uppercase tracking-wider">Heure</div>
                    <div class="col-span-10 text-xs font-semibold text-gray-600 uppercase tracking-wider text-center"
                        id="currentDateLabel">
                        <!-- Date actuelle -->
                    </div>
                </div>

                <!-- Grille horaire -->
                <div id="dayTimeGrid" class="relative" style="max-height: 600px; overflow-y: auto;">
                    <!-- Créneaux horaires seront générés ici -->
                </div>
            </div>
        </div>

        <!-- Vue Calendrier - Semaine -->
        <div id="calendarViewWeek" class="calendar-view hidden">
            <div class="bg-white rounded-2xl border border-pink-100 shadow-sm overflow-hidden">
                <!-- En-tête avec jours -->
                <div
                    class="grid grid-cols-8 gap-2 p-4 bg-gradient-to-r from-pink-50 to-purple-50 border-b border-pink-100">
                    <div class="text-xs font-semibold text-gray-600 uppercase tracking-wider">Heure</div>
                    <div id="weekDaysHeader" class="col-span-7 grid grid-cols-7 gap-2">
                        <!-- Jours de la semaine -->
                    </div>
                </div>

                <!-- Grille horaire semaine -->
                <div id="weekTimeGrid" class="relative" style="max-height: 600px; overflow-y: auto;">
                    <!-- Créneaux horaires seront générés ici -->
                </div>
            </div>
        </div>
    </div>

    <!-- Side Panel / Drawer pour détails du rendez-vous -->
    <div id="appointmentDrawer"
        class="fixed right-0 top-0 h-full w-full md:w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50 overflow-y-auto">
        <div
            class="sticky top-0 bg-gradient-to-r from-pink-500 to-purple-600 text-white p-6 flex items-center justify-between z-10">
            <h3 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="calendar-check" class="w-6 h-6"></i>
                Détails du rendez-vous
            </h3>
            <button onclick="closeAppointmentDrawer()"
                class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 transition-colors flex items-center justify-center">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div id="appointmentDrawerContent" class="p-6">
            <!-- Contenu sera injecté ici -->
        </div>
    </div>
    <div id="drawerOverlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-40"
        onclick="closeAppointmentDrawer()"></div>

    <!-- Modal pour les détails du rendez-vous -->
    <div id="appointmentModal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 items-center justify-center p-4"
        onclick="if(event.target === this) closeAppointmentModal();">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto animate-slide-up"
            onclick="event.stopPropagation();">
            <div
                class="sticky top-0 bg-gradient-to-r from-pink-500 to-purple-600 text-white p-6 rounded-t-2xl flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
                        <i data-lucide="calendar-check" class="w-5 h-5"></i>
                    </div>
                    <h3 class="text-xl font-bold">Détails du rendez-vous</h3>
                </div>
                <button onclick="closeAppointmentModal()"
                    class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 transition-colors flex items-center justify-center">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="appointmentModalContent" class="p-6">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="glass p-6 lg:col-span-2">
            <h2 class="text-xl font-semibold text-gray-900 mb-3">Informations du centre</h2>
            <div class="grid md:grid-cols-2 gap-4">
                <div class="p-4 rounded-xl border bg-white/50 flex items-center gap-3">
                    <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="image"
                            class="w-4 h-4"></i> Photo</div>
                    <div class="ml-auto">
                        {% if pro.extra.profile_photo %}
                        <img src="{{ pro.extra.profile_photo.url }}" class="w-16 h-16 rounded-lg object-cover border" />
                        {% else %}
                        <span class="text-gray-500">—</span>
                        {% endif %}
                    </div>
                </div>
                <div class="p-4 rounded-xl border bg-white/50">
                    <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="map-pin"
                            class="w-4 h-4"></i> Adresse</div>
                    <div class="text-gray-900 mt-1">{{ pro.extra.city|default:'—' }}</div>
                </div>
                <div class="p-4 rounded-xl border bg-white/50">
                    <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="phone"
                            class="w-4 h-4"></i> Téléphone</div>
                    <div class="text-gray-900 mt-1">{{ pro.user.phone|default:'—' }}</div>
                </div>
                <div class="p-4 rounded-xl border bg-white/50">
                    <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="mail"
                            class="w-4 h-4"></i> Email</div>
                    <div class="text-gray-900 mt-1">{{ pro.user.email }}</div>
                </div>
                <div class="p-4 rounded-xl border bg-white/50">
                    <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="calendar"
                            class="w-4 h-4"></i> Créé le</div>
                    <div class="text-gray-900 mt-1">{{ pro.created_at }}</div>
                </div>
                {% if pro.extra %}
                <div class="md:col-span-2 p-4 rounded-xl border bg-white/50">
                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="user-round"
                                class="w-4 h-4"></i> Biographie</div>

                    </div>
                    <div id="bioText" class="text-gray-900 mt-1">{{ pro.extra.bio|default:'—' }}</div>
                </div>
                <div class="p-4 rounded-xl border bg-white/50">
                    <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="calendar-check"
                            class="w-4 h-4"></i> Jours de travail</div>
                    <div class="text-gray-900 mt-2 flex flex-wrap gap-2">
                        {% for d in pro.extra.working_days %}
                        <span class="px-2 py-1 rounded-full text-xs bg-pink-50 text-pink-700 border border-pink-200">
                            {{ d|upper }}</span>
                        {% empty %}
                        <span class="text-gray-500">—</span>
                        {% endfor %}
                    </div>
                </div>
                <div class="p-4 rounded-xl border bg-white/50">
                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="clock-8"
                                class="w-4 h-4"></i> Horaires</div>

                    </div>
                    <div id="hoursText" class="text-gray-900 mt-1">{{ pro.extra.working_hours.start }} - {{
                        pro.extra.working_hours.end }}</div>






                </div>
                <div class="md:col-span-2 p-4 rounded-xl border bg-white/50">
                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="share-2"
                                class="w-4 h-4"></i> Réseaux sociaux</div>

                    </div>
                    <div class="text-gray-900 mt-1 space-y-1">
                        <div class="flex items-center gap-2"><i data-lucide="instagram"
                                class="w-4 h-4 text-pink-600"></i> Instagram : <a class="text-blue-600"
                                href="{{ pro.extra.social_instagram }}" target="_blank">
                                {{ pro.extra.social_instagram|default:'—' }}</a></div>
                        <div class="flex items-center gap-2"><i data-lucide="facebook"
                                class="w-4 h-4 text-blue-600"></i> Facebook : <a class="text-blue-600"
                                href="{{ pro.extra.social_facebook }}" target="_blank">
                                {{ pro.extra.social_facebook|default:'—' }}</a></div>
                        <div class="flex items-center gap-2"><i data-lucide="music-2" class="w-4 h-4 text-gray-700"></i>
                            TikTok : <a class="text-blue-600" href="{{ pro.extra.social_tiktok }}" target="_blank">
                                {{pro.extra.social_tiktok|default:'—' }}</a></div>
                    </div>
                </div>
                <div class="md:col-span-2 p-4 rounded-xl border bg-white/50">
                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="sparkles"
                                class="w-4 h-4"></i> Services proposés</div>

                    </div>
                    <div class="mt-2 grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
                        {% for s in pro.extra.services %}
                        <div class="p-3 rounded-lg border bg-white/60 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i data-lucide="scissors" class="w-4 h-4 text-pink-600"></i>
                                <div>
                                    <div class="font-medium">{{ s.name }}</div>
                                    <div class="text-xs text-gray-500">Durée : {{ s.duration_min }} min</div>
                                </div>
                            </div>
                            <div class="text-pink-600 font-semibold">{{ s.price }} DT</div>
                        </div>
                        {% empty %}
                        <div class="text-gray-500">—</div>
                        {% endfor %}
                    </div>
                </div>
                <div class="md:col-span-2 p-4 rounded-xl border bg-white/50">
                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-500 flex items-center gap-2"><i data-lucide="images"
                                class="w-4 h-4"></i> Galerie</div>

                    </div>
                    <div class="mt-2 flex flex-wrap gap-3">
                        {% for g in pro.extra.gallery %}
                        <img src="{{ g }}" class="w-24 h-24 object-cover rounded-lg border" />
                        {% empty %}
                        <div class="text-gray-500">—</div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

    </div>



    <!-- Modals -->
    <div id="modalBio" class="hidden fixed inset-0 bg-black/40 z-50 items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg">
            < <textarea id="inputBio" rows="5" class="w-full border rounded-xl p-3" placeholder="Biographie"></textarea>
                <div class="mt-4 flex justify-end gap-2">
                    <button class="btn-secondary-glass" onclick="closeModal('modalBio')">Annuler</button>
                    <button class="btn-glass"
                        onclick="saveExtras({bio: document.getElementById('inputBio').value})">Enregistrer</button>
                </div>
        </div>
    </div>
    <div id="modalHours" class="hidden fixed inset-0 bg-black/40 z-50 items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg">

            <div class="grid grid-cols-2 gap-3">
                <input id="inputStart" class="border rounded-xl p-3" placeholder="Début (HH:MM)" />
                <input id="inputEnd" class="border rounded-xl p-3" placeholder="Fin (HH:MM)" />
            </div>
            <div class="mt-4 flex justify-end gap-2">
                <button class="btn-secondary-glass" onclick="closeModal('modalHours')">Annuler</button>
                <button class="btn-glass"
                    onclick="saveExtras({working_hours: {start: document.getElementById('inputStart').value, end: document.getElementById('inputEnd').value}})">Enregistrer</button>
            </div>
        </div>
    </div>
    <div id="modalSocials" class="hidden fixed inset-0 bg-black/40 z-50 items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg">
            <h3 class="text-lg font-semibold mb-3">Modifier les réseaux sociaux</h3>
            <input id="inputIG" class="border rounded-xl p-3 mb-2 w-full" placeholder="Instagram (https://...)" />
            <input id="inputFB" class="border rounded-xl p-3 mb-2 w-full" placeholder="Facebook (https://...)" />
            <input id="inputTT" class="border rounded-xl p-3 mb-2 w-full" placeholder="TikTok (https://...)" />
            <div class="mt-2 flex justify-end gap-2">
                <button class="btn-secondary-glass" onclick="closeModal('modalSocials')">Annuler</button>
                <button class="btn-glass"
                    onclick="saveExtras({social_instagram: document.getElementById('inputIG').value, social_facebook: document.getElementById('inputFB').value, social_tiktok: document.getElementById('inputTT').value})">Enregistrer</button>
            </div>
        </div>
    </div>
    <div id="modalServices" class="hidden fixed inset-0 bg-black/40 z-50 items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-full max-w-2xl">
            <h3 class="text-lg font-semibold mb-3">Modifier les services</h3>
            <textarea id="inputServices" rows="6" class="w-full border rounded-xl p-3"
                placeholder="JSON ex: [{&quot;name&quot;:&quot;Soin&quot;,&quot;duration_min&quot;:45,&quot;price&quot;:80}]"></textarea>
            <div class="mt-2 flex justify-end gap-2">
                <button class="btn-secondary-glass" onclick="closeModal('modalServices')">Annuler</button>
                <button class="btn-glass" onclick="saveServices()">Enregistrer</button>
            </div>
        </div>
    </div>
    <div id="modalGallery" class="hidden fixed inset-0 bg-black/40 z-50 items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg">
            <h3 class="text-lg font-semibold mb-3">Ajouter à la galerie</h3>
            <input id="inputGallery" type="file" multiple accept="image/*" class="block w-full text-sm" />
            <div class="mt-2 flex justify-end gap-2">
                <button class="btn-secondary-glass" onclick="closeModal('modalGallery')">Annuler</button>
                <button class="btn-glass" onclick="saveGallery()">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let chartReservations, chartServices, chartTrend, chartHourly, chartRevenue;

    function fmt(d) {
        return d.toISOString().slice(0, 10);
    }

    async function reloadAnalytics() {
        const f = document.getElementById('anFrom').value;
        const t = document.getElementById('anTo').value;
        const params = new URLSearchParams();
        params.set('pro_id', '{{ pro.id }}');
        if (f) params.set('from', f);
        if (t) params.set('to', t);
        const res = await fetch(`/api/appointments/analytics/overview/?${params.toString()}`);
        if (!res.ok) return;
        const data = await res.json();
        const labels = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
        const week = data.reservations_by_weekday || [0, 0, 0, 0, 0, 0, 0];
        const dist = data.services_distribution || [];

        // Trend chart
        const tLabels = (data.trend_daily || []).map(x => x.date);
        const tValues = (data.trend_daily || []).map(x => x.count);
        const ctxT = document.getElementById('chartTrend').getContext('2d');
        if (chartTrend) chartTrend.destroy();
        chartTrend = new Chart(ctxT, {
            type: 'line',
            data: { labels: tLabels, datasets: [{ data: tValues, borderColor: 'rgb(236,72,153)', backgroundColor: 'rgba(236,72,153,0.12)', tension: 0.35, fill: true }] },
            options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true } } }
        });

        // Services chart
        const ctx2 = document.getElementById('chartServices').getContext('2d');
        if (chartServices) chartServices.destroy();
        chartServices = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: dist.map(x => x.label), datasets: [{
                    data: dist.map(x => x.value), backgroundColor: [
                        'rgba(236,72,153,0.8)', 'rgba(108,169,224,0.8)', 'rgba(34,197,94,0.8)', 'rgba(251,146,60,0.8)', 'rgba(168,85,247,0.8)', 'rgba(14,165,233,0.8)', 'rgba(234,88,12,0.8)', 'rgba(34,197,94,0.5)'], borderWidth: 2
                }]
            },
            options: { plugins: { legend: { position: 'bottom' } } }
        });

        // Hourly distribution
        const ctxH = document.getElementById('chartHourly').getContext('2d');
        if (chartHourly) chartHourly.destroy();
        chartHourly = new Chart(ctxH, {
            type: 'bar',
            data: { labels: Array.from({ length: 24 }, (_, i) => (i < 10 ? ('0' + i) : i) + ':00'), datasets: [{ data: data.hourly_distribution || [], backgroundColor: 'rgba(108,169,224,0.6)' }] },
            options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });

        // Weekday reservations
        const ctx1 = document.getElementById('chartReservations').getContext('2d');
        if (chartReservations) chartReservations.destroy();
        chartReservations = new Chart(ctx1, {
            type: 'bar',
            data: { labels, datasets: [{ data: week, backgroundColor: 'rgba(236,72,153,0.6)' }] },
            options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });

        // Revenue daily
        const rLabels = (data.revenue_daily || []).map(x => x.date);
        const rValues = (data.revenue_daily || []).map(x => x.value);
        const ctxR = document.getElementById('chartRevenue').getContext('2d');
        if (chartRevenue) chartRevenue.destroy();
        chartRevenue = new Chart(ctxR, {
            type: 'line',
            data: { labels: rLabels, datasets: [{ data: rValues, borderColor: 'rgb(34,197,94)', backgroundColor: 'rgba(34,197,94,0.12)', tension: 0.35, fill: true }] },
            options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });

        // KPIs
        const sb = data.status_breakdown || {};
        document.getElementById('kpiPending').textContent = sb.pending ?? 0;
        document.getElementById('kpiConfirmed').textContent = sb.confirmed ?? 0;
        document.getElementById('kpiCancelled').textContent = sb.cancelled ?? 0;
        document.getElementById('kpiCompleted').textContent = sb.completed ?? 0;
    }

    function hourLabel(h) { return (h < 10 ? '0' + h : '' + h) + ':00'; }
    function statusColor(s) { if (s === 'confirmed') return 'bg-red-500'; if (s === 'pending') return 'bg-amber-400'; return 'bg-emerald-500'; }

    // Fonction pour basculer entre les vues
    function switchView(view) {
        currentView = view;
        const dayView = document.getElementById('calendarViewDay');
        const weekView = document.getElementById('calendarViewWeek');
        const dayBtn = document.getElementById('viewDayBtn');
        const weekBtn = document.getElementById('viewWeekBtn');

        if (view === 'day') {
            dayView.classList.remove('hidden');
            weekView.classList.add('hidden');
            dayBtn.classList.add('active');
            weekBtn.classList.remove('active');
        } else {
            dayView.classList.add('hidden');
            weekView.classList.remove('hidden');
            dayBtn.classList.remove('active');
            weekBtn.classList.add('active');
        }

        reloadAgenda();
    }

    function renderTimeline(items) {
        currentAppointments = items;

        if (currentView === 'day') {
            renderDayView(items);
        } else {
            renderWeekView(items);
        }
    }

    function renderDayView(items) {
        const grid = document.getElementById('dayTimeGrid');
        const dateLabel = document.getElementById('currentDateLabel');
        const dayPicker = document.getElementById('dayPicker');

        if (!grid) return;

        const selectedDate = dayPicker ? new Date(dayPicker.value) : new Date();
        dateLabel.textContent = selectedDate.toLocaleDateString('fr-FR', {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });

        grid.innerHTML = '';

        // Créer les créneaux horaires de 8h à 20h
        for (let h = 8; h <= 20; h++) {
            const hourRow = document.createElement('div');
            hourRow.className = 'time-slot-row grid grid-cols-12 gap-2 p-2';

            // Colonne heure
            const hourCol = document.createElement('div');
            hourCol.className = 'col-span-2 flex items-center justify-end pr-4';
            hourCol.innerHTML = `<span class="text-sm font-semibold text-gray-600">${h.toString().padStart(2, '0')}:00</span>`;

            // Colonne créneaux
            const slotsCol = document.createElement('div');
            slotsCol.className = 'col-span-10 relative';

            // Trouver les rendez-vous pour cette heure
            const hourAppointments = items.filter(apt => {
                const aptTime = new Date(apt.start);
                return aptTime.getHours() === h;
            });

            if (hourAppointments.length > 0) {
                hourAppointments.forEach(apt => {
                    const aptBlock = createAppointmentBlock(apt);
                    slotsCol.appendChild(aptBlock);
                });
            } else {
                const emptySlot = document.createElement('div');
                emptySlot.className = 'empty-slot flex items-center justify-center p-2';
                emptySlot.innerHTML = `<span class="text-xs text-gray-400">Disponible</span>`;
                slotsCol.appendChild(emptySlot);
            }

            hourRow.appendChild(hourCol);
            hourRow.appendChild(slotsCol);
            grid.appendChild(hourRow);
        }

        if (window.lucide) window.lucide.createIcons();
    }

    function renderWeekView(items) {
        const grid = document.getElementById('weekTimeGrid');
        const weekHeader = document.getElementById('weekDaysHeader');
        const dayPicker = document.getElementById('dayPicker');

        if (!grid || !weekHeader) return;

        const selectedDate = dayPicker ? new Date(dayPicker.value + 'T12:00:00') : new Date();
        const dayOfWeek = selectedDate.getDay();
        const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        const startOfWeek = new Date(selectedDate);
        startOfWeek.setDate(selectedDate.getDate() + diffToMonday);

        // Générer les en-têtes des jours
        weekHeader.innerHTML = '';
        const weekDays = [];
        for (let i = 0; i < 7; i++) {
            const day = new Date(startOfWeek);
            day.setDate(startOfWeek.getDate() + i);
            weekDays.push(day);

            const dayHeader = document.createElement('div');
            dayHeader.className = 'text-center';
            dayHeader.innerHTML = `
                <div class="text-xs font-semibold text-gray-600 uppercase">${day.toLocaleDateString('fr-FR', { weekday: 'short' })}</div>
                <div class="text-sm font-bold text-gray-900 mt-1">${day.getDate()}</div>
            `;
            weekHeader.appendChild(dayHeader);
        }

        grid.innerHTML = '';

        // Créer les créneaux horaires de 8h à 20h
        for (let h = 8; h <= 20; h++) {
            const hourRow = document.createElement('div');
            hourRow.className = 'time-slot-row grid grid-cols-8 gap-2 p-2';

            // Colonne heure
            const hourCol = document.createElement('div');
            hourCol.className = 'flex items-center justify-end pr-4';
            hourCol.innerHTML = `<span class="text-sm font-semibold text-gray-600">${h.toString().padStart(2, '0')}:00</span>`;
            hourRow.appendChild(hourCol);

            // Colonnes pour chaque jour
            weekDays.forEach(day => {
                const dayCol = document.createElement('div');
                dayCol.className = 'relative';

                const dayStr = day.toISOString().split('T')[0];
                const dayAppointments = items.filter(apt => {
                    const aptDate = new Date(apt.start).toISOString().split('T')[0];
                    const aptHour = new Date(apt.start).getHours();
                    return aptDate === dayStr && aptHour === h;
                });

                if (dayAppointments.length > 0) {
                    dayAppointments.forEach(apt => {
                        const aptBlock = createAppointmentBlock(apt);
                        dayCol.appendChild(aptBlock);
                    });
                } else {
                    const emptySlot = document.createElement('div');
                    emptySlot.className = 'empty-slot';
                    dayCol.appendChild(emptySlot);
                }

                hourRow.appendChild(dayCol);
            });

            grid.appendChild(hourRow);
        }

        if (window.lucide) window.lucide.createIcons();
    }

    function createAppointmentBlock(appointment) {
        const block = document.createElement('div');
        block.className = `appointment-block ${appointment.status} cursor-pointer`;
        block.onclick = () => viewAppointment(appointment.id);

        const startTime = new Date(appointment.start);
        const endTime = new Date(appointment.end);
        const duration = Math.round((endTime - startTime) / (1000 * 60));

        block.innerHTML = `
            <div class="flex items-start justify-between mb-1">
                <div class="flex-1">
                    <div class="text-xs font-bold text-gray-900 mb-0.5">
                        ${startTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}
                    </div>
                    <div class="text-xs font-semibold text-gray-800">${appointment.service_name || 'Service'}</div>
                </div>
            </div>
            <div class="text-xs text-gray-700 flex items-center gap-1 mb-1">
                <i data-lucide="user" class="w-3 h-3"></i>
                ${appointment.client_name || 'Client'}
            </div>
            <div class="text-xs text-gray-600 flex items-center gap-1">
                <i data-lucide="timer" class="w-3 h-3"></i>
                ${duration} min
            </div>
        `;

        return block;
    }

    function renderTimelineOld(items) {
        const container = document.getElementById('scheduleGrid');

        // Clear container
        if (container) container.innerHTML = '';

        // Create time slots from 8:00 to 20:00
        const timeSlots = [];
        for (let h = 8; h <= 20; h++) {
            timeSlots.push({
                hour: h,
                start: `${h.toString().padStart(2, '0')}:00`,
                end: `${(h + 1).toString().padStart(2, '0')}:00`,
                hasAppointment: false,
                appointment: null
            });
        }

        // Map appointments to time slots
        items.forEach(appointment => {
            const startTime = new Date(appointment.start);
            const hour = startTime.getHours();
            if (hour >= 8 && hour <= 20) {
                const slotIndex = hour - 8;
                if (timeSlots[slotIndex]) {
                    timeSlots[slotIndex].hasAppointment = true;
                    timeSlots[slotIndex].appointment = appointment;
                }
            }
        });

        // Render time slots as modern cards
        if (container) {
            timeSlots.forEach((slot, index) => {
                const slotCard = document.createElement('div');
                slotCard.className = `schedule-card p-4 animate-slide-up`;
                slotCard.style.animationDelay = `${index * 0.03}s`;

                if (slot.hasAppointment && slot.appointment) {
                    const appointment = slot.appointment;
                    const startTime = new Date(appointment.start);
                    const endTime = new Date(appointment.end);
                    const duration = Math.round((endTime - startTime) / (1000 * 60));
                    const statusBadges = {
                        'confirmed': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-white/20 text-white border border-white/30">Confirmé</span>',
                        'pending': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-white/20 text-white border border-white/30">En attente</span>',
                        'completed': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-white/20 text-white border border-white/30">Terminé</span>',
                        'cancelled': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-white/20 text-white border border-white/30">Annulé</span>'
                    };
                    const statusBadge = statusBadges[appointment.status] || '';

                    slotCard.className += ` ${appointment.status}`;
                    slotCard.onclick = () => viewAppointment(appointment.id);
                    slotCard.innerHTML = `
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <div class="w-10 h-10 rounded-lg bg-white/20 backdrop-blur-sm flex items-center justify-center">
                                    <i data-lucide="clock" class="w-5 h-5 text-white"></i>
                                </div>
                                <div>
                                    <div class="time-slot text-white font-bold text-base">${slot.start} - ${slot.end}</div>
                                    <div class="text-xs text-white/80 flex items-center gap-1 mt-0.5">
                                        <i data-lucide="timer" class="w-3 h-3"></i>
                                        ${duration} minutes
                                    </div>
                                </div>
                            </div>
                            ${statusBadge}
                        </div>
                        <div class="space-y-2 mb-3">
                            <div class="flex items-center gap-2">
                                <i data-lucide="scissors" class="w-4 h-4 text-white/90"></i>
                                <span class="service-name text-white font-semibold text-sm">${appointment.service_name || 'Service'}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="user" class="w-4 h-4 text-white/90"></i>
                                <span class="client-name text-white/90 text-sm">${appointment.client_name || 'Client non spécifié'}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="calendar" class="w-4 h-4 text-white/90"></i>
                                <span class="text-xs text-white/80">${startTime.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' })}</span>
                            </div>
                            ${appointment.notes ? `
                            <div class="mt-2 p-2 bg-white/15 backdrop-blur-sm rounded-lg border border-white/20">
                                <div class="flex items-start gap-2">
                                    <i data-lucide="message-square" class="w-4 h-4 text-white/90 mt-0.5"></i>
                                    <p class="text-xs text-white/90 leading-relaxed">${appointment.notes}</p>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="flex items-center justify-end gap-2 pt-3 border-t border-white/20">
                            <button onclick="event.stopPropagation(); editAppointment('${appointment.id}')" 
                                    class="px-3 py-1.5 rounded-lg bg-white/20 hover:bg-white/30 text-white text-xs font-medium transition-all duration-200 flex items-center gap-1.5">
                                <i data-lucide="edit" class="w-3.5 h-3.5"></i>
                                Modifier
                            </button>
                            <button onclick="event.stopPropagation(); viewAppointment('${appointment.id}')" 
                                    class="px-3 py-1.5 rounded-lg bg-white/30 hover:bg-white/40 text-white text-xs font-medium transition-all duration-200 flex items-center gap-1.5">
                                <i data-lucide="eye" class="w-3.5 h-3.5"></i>
                                Détails
                            </button>
                        </div>
                    `;
                } else {
                    slotCard.className += ' available';
                    slotCard.onclick = () => bookSlot(slot.start, slot.end);
                    slotCard.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-gray-200 flex items-center justify-center">
                                    <i data-lucide="clock" class="w-5 h-5 text-gray-500"></i>
                                </div>
                                <div>
                                    <div class="time-slot text-gray-800 font-bold text-base">${slot.start} - ${slot.end}</div>
                                    <div class="text-xs text-gray-500 mt-0.5">Créneau disponible</div>
                                </div>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 border border-gray-200">
                                Disponible
                            </span>
                        </div>
                        <div class="text-center py-2">
                            <div class="text-xs text-gray-500 italic">
                                Créneau disponible
                            </div>
                        </div>
                    `;
                }

                container.appendChild(slotCard);
            });

            // Add empty state if no appointments
            if (items.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'text-center py-12 animate-fade-in';
                emptyState.innerHTML = `
                    <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-pink-100 to-purple-100 rounded-full flex items-center justify-center">
                        <i data-lucide="calendar-x" class="w-8 h-8 text-pink-500"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Aucun rendez-vous</h3>
                    <p class="text-gray-500 text-sm mb-4">Aucun rendez-vous n'est programmé pour cette date.</p>
                    <button onclick="bookNewAppointment()"
                            class="px-6 py-2.5 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-lg hover:from-pink-600 hover:to-purple-700 transition-all duration-200 text-sm font-medium shadow-md hover:shadow-lg transform hover:scale-105 inline-flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Ajouter un rendez-vous
                    </button>
                `;
                container.appendChild(emptyState);
            }

            // Initialize Lucide icons after rendering
            if (window.lucide) window.lucide.createIcons();
        }
    }


    // Event listeners pour les filtres
    document.getElementById('searchClient')?.addEventListener('input', (e) => {
        clearTimeout(window.searchTimeout);
        window.searchTimeout = setTimeout(() => reloadAgenda(), 300);
    });

    document.getElementById('filterService')?.addEventListener('change', () => reloadAgenda());
    document.getElementById('filterStatus')?.addEventListener('change', () => reloadAgenda());
    document.getElementById('dayPicker')?.addEventListener('change', () => reloadAgenda());

    // Init defaults on load
    (function init() {
        const today = fmt(new Date());
        const dayPicker = document.getElementById('dayPicker');
        if (dayPicker) dayPicker.value = today;

        const from = new Date();
        from.setDate(from.getDate() - 6);
        const anFrom = document.getElementById('anFrom');
        const anTo = document.getElementById('anTo');
        if (anFrom) anFrom.value = fmt(from);
        if (anTo) anTo.value = today;

        reloadAnalytics();
        reloadAgenda();
    })();

    function getCsrf() {
        const name = 'csrftoken=';
        const parts = document.cookie.split(';');
        for (let p of parts) { p = p.trim(); if (p.startsWith(name)) return p.substring(name.length); }
        return '';
    }
    function openModal(id) { const m = document.getElementById(id); m.classList.remove('hidden'); m.classList.add('flex'); }
    function closeModal(id) { const m = document.getElementById(id); m.classList.add('hidden'); m.classList.remove('flex'); }
    async function saveExtras(payload) {
        const res = await fetch("{% url 'front_web:pro_onboarding_save' %}", {
            method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrf() }, body: JSON.stringify(payload)
        });
        if (res.ok) { location.reload(); }
    }
    function saveServices() {
        try { const data = JSON.parse(document.getElementById('inputServices').value || '[]'); saveExtras({ services: data }); } catch (e) { alert('JSON invalide'); }
    }
    async function saveGallery() {
        const input = document.getElementById('inputGallery');
        const files = input.files; const list = [];
        for (const f of files) { const b64 = await toBase64(f); list.push(b64); }
        await saveExtras({ gallery: list });
    }
    function toBase64(file) { return new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file); }); }

    // Modern agenda utility functions
    function editAppointment(appointmentId) {
        // TODO: Implement edit appointment modal
        console.log('Edit appointment:', appointmentId);
        alert('Fonctionnalité de modification en cours de développement');
    }

    // Variable globale pour stocker les rendez-vous
    let currentAppointments = [];
    let currentView = 'day';

    function viewAppointment(appointmentId) {
        // Chercher dans les données actuelles
        let appointment = currentAppointments.find(apt => apt.id == appointmentId);

        if (!appointment) {
            // Fallback: fetch from API
            fetch(`/api/appointments/${appointmentId}/`)
                .then(res => res.json())
                .then(data => {
                    currentAppointments.push(data);
                    openAppointmentDrawer(data);
                })
                .catch(err => {
                    console.error('Error fetching appointment:', err);
                    alert('Impossible de charger les détails du rendez-vous');
                });
        } else {
            openAppointmentDrawer(appointment);
        }
    }

    function openAppointmentDrawer(appointment) {
        const drawer = document.getElementById('appointmentDrawer');
        const overlay = document.getElementById('drawerOverlay');
        const content = document.getElementById('appointmentDrawerContent');

        if (!drawer || !content) return;

        const startTime = appointment.start ? new Date(appointment.start) : null;
        const endTime = appointment.end ? new Date(appointment.end) : null;
        const duration = startTime && endTime ? Math.round((endTime - startTime) / (1000 * 60)) : 0;

        const statusLabels = {
            'confirmed': { label: 'Confirmé', color: 'bg-green-100 text-green-700', icon: 'check-circle' },
            'pending': { label: 'En attente', color: 'bg-yellow-100 text-yellow-700', icon: 'clock' },
            'cancelled': { label: 'Annulé', color: 'bg-red-100 text-red-700', icon: 'x-circle' },
            'completed': { label: 'Terminé', color: 'bg-blue-100 text-blue-700', icon: 'check-circle-2' }
        };
        const statusInfo = statusLabels[appointment.status] || statusLabels.confirmed;

        content.innerHTML = `
            <div class="space-y-6">
                <!-- En-tête avec statut -->
                <div class="p-4 bg-gradient-to-br from-pink-50 to-purple-50 rounded-xl border border-pink-100">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-semibold text-gray-900 flex items-center gap-2">
                            <i data-lucide="clock" class="w-5 h-5 text-pink-500"></i>
                            Horaires
                        </h4>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusInfo.color} flex items-center gap-1">
                            <i data-lucide="${statusInfo.icon}" class="w-3 h-3"></i>
                            ${statusInfo.label}
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-gray-900 mb-2">
                        ${startTime ? startTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '—'} 
                        ${endTime ? `- ${endTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}` : ''}
                    </div>
                    ${duration ? `<div class="text-sm text-gray-600 flex items-center gap-1">
                        <i data-lucide="timer" class="w-4 h-4"></i>
                        Durée : ${duration} minutes
                    </div>` : ''}
                    ${startTime ? `<div class="text-sm text-gray-600 mt-2 flex items-center gap-1">
                        <i data-lucide="calendar" class="w-4 h-4"></i>
                        ${startTime.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                    </div>` : ''}
                </div>
                
                <!-- Informations Service -->
                <div class="p-4 bg-white rounded-xl border border-gray-100 shadow-sm">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-10 h-10 rounded-lg bg-pink-100 flex items-center justify-center">
                            <i data-lucide="scissors" class="w-5 h-5 text-pink-500"></i>
                        </div>
                        <h4 class="font-semibold text-gray-900">Service réservé</h4>
                    </div>
                    <div class="pl-12">
                        <div class="text-lg font-bold text-gray-900 mb-1">${appointment.service_name || '—'}</div>
                        ${appointment.price ? `<div class="text-sm text-gray-600 flex items-center gap-1">
                            <i data-lucide="banknote" class="w-4 h-4"></i>
                            Prix : ${appointment.price} DT
                        </div>` : ''}
                    </div>
                </div>
                
                <!-- Informations Client -->
                <div class="p-4 bg-white rounded-xl border border-gray-100 shadow-sm">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center">
                            <i data-lucide="user" class="w-5 h-5 text-purple-500"></i>
                        </div>
                        <h4 class="font-semibold text-gray-900">Informations client</h4>
                    </div>
                    <div class="pl-12 space-y-2">
                        <div>
                            <span class="text-xs text-gray-500 uppercase tracking-wider">Nom complet</span>
                            <div class="text-base font-semibold text-gray-900">${appointment.client_name || '—'}</div>
                        </div>
                        ${appointment.client_email ? `
                        <div>
                            <span class="text-xs text-gray-500 uppercase tracking-wider">Email</span>
                            <div class="text-sm text-gray-700 flex items-center gap-1">
                                <i data-lucide="mail" class="w-4 h-4"></i>
                                <a href="mailto:${appointment.client_email}" class="text-pink-600 hover:text-pink-700">${appointment.client_email}</a>
                            </div>
                        </div>
                        ` : ''}
                        ${appointment.client_phone ? `
                        <div>
                            <span class="text-xs text-gray-500 uppercase tracking-wider">Téléphone</span>
                            <div class="text-sm text-gray-700 flex items-center gap-1">
                                <i data-lucide="phone" class="w-4 h-4"></i>
                                <a href="tel:${appointment.client_phone}" class="text-pink-600 hover:text-pink-700">${appointment.client_phone}</a>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Notes du client -->
                ${appointment.notes ? `
                <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="message-square" class="w-5 h-5 text-blue-500"></i>
                        <span class="text-sm font-semibold text-gray-700">Note du client</span>
                    </div>
                    <p class="text-gray-700 text-sm leading-relaxed">${appointment.notes}</p>
                </div>
                ` : ''}
                
                <!-- Actions -->
                <div class="flex flex-col gap-3 pt-4 border-t border-gray-200">
                    ${appointment.status !== 'cancelled' ? `
                    <button onclick="cancelAppointment('${appointment.id}')"
                            class="w-full px-4 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl font-medium hover:from-red-600 hover:to-red-700 transition-all duration-200 shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                        <i data-lucide="x-circle" class="w-4 h-4"></i>
                        Annuler le rendez-vous
                    </button>
                    ` : ''}
                   
                    <button onclick="closeAppointmentDrawer()"
                            class="w-full px-4 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-all duration-200">
                        Fermer
                    </button>
                </div>
            </div>
        `;

        drawer.classList.remove('translate-x-full');
        overlay.classList.remove('hidden');

        // Initialize Lucide icons
        if (window.lucide) window.lucide.createIcons();
    }

    function closeAppointmentDrawer() {
        const drawer = document.getElementById('appointmentDrawer');
        const overlay = document.getElementById('drawerOverlay');
        if (drawer) drawer.classList.add('translate-x-full');
        if (overlay) overlay.classList.add('hidden');
    }

    function cancelAppointment(appointmentId) {
        if (!confirm('Êtes-vous sûr de vouloir annuler ce rendez-vous ? Le client sera notifié.')) return;

        fetch(`/api/appointments/update/${appointmentId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrf()
            },
            body: JSON.stringify({
                status: 'cancelled'
            })
        })
            .then(res => {
                if (!res.ok) {
                    return res.json().then(err => Promise.reject(err));
                }
                return res.json();
            })
            .then(data => {
                if (data.ok || data.id) {
                    alert('Rendez-vous annulé avec succès. Le client a été notifié.');
                    closeAppointmentDrawer();
                    reloadAgenda();
                } else {
                    alert('Erreur lors de l\'annulation : ' + (data.detail || data.error || 'Erreur inconnue'));
                }
            })
            .catch(err => {
                console.error('Error cancelling appointment:', err);
                const errorMsg = err.detail || err.error || 'Erreur lors de l\'annulation du rendez-vous';
                alert(errorMsg);
            });
    }

    function openAppointmentModal(appointment) {
        const modal = document.getElementById('appointmentModal');
        const content = document.getElementById('appointmentModalContent');

        if (!modal || !content) return;

        const startTime = appointment.start ? new Date(appointment.start) : null;
        const endTime = appointment.end ? new Date(appointment.end) : null;
        const duration = startTime && endTime ? Math.round((endTime - startTime) / (1000 * 60)) : 0;

        content.innerHTML = `
            <div class="space-y-4">
                <div class="p-4 bg-gradient-to-br from-pink-50 to-purple-50 rounded-xl border border-pink-100">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-semibold text-gray-900 flex items-center gap-2">
                            <i data-lucide="clock" class="w-5 h-5 text-pink-500"></i>
                            Horaires
                        </h4>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold bg-pink-100 text-pink-700">
                            ${appointment.status === 'confirmed' ? 'Confirmé' : appointment.status === 'pending' ? 'En attente' : appointment.status || 'Confirmé'}
                        </span>
                    </div>
                    <div class="text-lg font-bold text-gray-900">
                        ${startTime ? startTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : appointment.time || '—'}
                    </div>
                    ${duration ? `<div class="text-sm text-gray-600 mt-1">Durée : ${duration} minutes</div>` : ''}
                    ${startTime ? `<div class="text-sm text-gray-600 mt-1">${startTime.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</div>` : ''}
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="p-4 bg-white rounded-xl border border-gray-100">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="scissors" class="w-4 h-4 text-pink-500"></i>
                            <span class="text-xs text-gray-500 uppercase tracking-wider">Service</span>
                        </div>
                        <div class="font-semibold text-gray-900">${appointment.service_name || '—'}</div>
                    </div>
                    
                    <div class="p-4 bg-white rounded-xl border border-gray-100">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="user" class="w-4 h-4 text-pink-500"></i>
                            <span class="text-xs text-gray-500 uppercase tracking-wider">Client</span>
                        </div>
                        <div class="font-semibold text-gray-900">${appointment.client_name || '—'}</div>
                    </div>
                </div>
                
                ${appointment.notes ? `
                <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="message-square" class="w-4 h-4 text-blue-500"></i>
                        <span class="text-xs text-gray-600 font-medium">Note du client</span>
                    </div>
                    <p class="text-gray-700 text-sm">${appointment.notes}</p>
                </div>
                ` : ''}
                
                <div class="flex gap-3 pt-4">
                    <button onclick="editAppointment('${appointment.id}'); closeAppointmentModal();"
                            class="flex-1 px-4 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-xl font-medium hover:from-pink-600 hover:to-purple-700 transition-all duration-200 shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                        <i data-lucide="edit" class="w-4 h-4"></i>
                        Modifier
                    </button>
                    <button onclick="closeAppointmentModal()"
                            class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-all duration-200">
                        Fermer
                    </button>
                </div>
            </div>
        `;

        modal.classList.remove('hidden');
        modal.classList.add('flex');

        // Initialize Lucide icons in modal
        if (window.lucide) window.lucide.createIcons();
    }

    function closeAppointmentModal() {
        const modal = document.getElementById('appointmentModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    }

    function bookSlot(startTime, endTime) {
        // Le professionnel ne réserve pas de créneaux - cette fonction n'est pas utilisée
        // Les clients réservent via la page de réservation publique
        console.log('Slot disponible:', startTime, 'to', endTime);
    }

    function bookNewAppointment() {
        // Le professionnel ne crée pas de rendez-vous directement
        // Les rendez-vous sont créés par les clients via la page de réservation
        alert('Les rendez-vous sont créés par les clients via la page de réservation publique.');
    }

    // Enhanced reload with loading state and filters
    async function reloadAgenda() {
        const button = document.querySelector('button[onclick="reloadAgenda()"]');
        const originalText = button?.innerHTML;

        // Show loading state
        if (button) {
            button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Chargement...';
            button.disabled = true;
        }

        try {
            const dayPicker = document.getElementById('dayPicker');
            const selectedDate = dayPicker?.value || fmt(new Date());

            // Récupérer les rendez-vous
            let url = `/api/appointments/agenda/day/?pro_id={{ pro.id }}&date=${selectedDate}`;

            // Si vue semaine, récupérer toute la semaine
            if (currentView === 'week') {
                const date = new Date(selectedDate + 'T12:00:00'); // Ajouter l'heure pour éviter les problèmes de timezone
                const dayOfWeek = date.getDay(); // 0 = Dimanche, 1 = Lundi, etc.
                // Calculer le décalage vers le lundi (1)
                const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                const startOfWeek = new Date(date);
                startOfWeek.setDate(date.getDate() + diffToMonday);
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6); // Dimanche

                url = `/api/appointments/agenda/day/?pro_id={{ pro.id }}&date_from=${fmt(startOfWeek)}&date_to=${fmt(endOfWeek)}`;
            }

            const res = await fetch(url);
            if (!res.ok) throw new Error('Erreur de chargement');
            const data = await res.json();
            let appointments = data.results || [];

            // Appliquer les filtres
            const searchTerm = (document.getElementById('searchClient')?.value || '').toLowerCase();
            const serviceFilter = document.getElementById('filterService')?.value || '';
            const statusFilter = document.getElementById('filterStatus')?.value || '';

            if (searchTerm || serviceFilter || statusFilter) {
                appointments = appointments.filter(apt => {
                    const matchSearch = !searchTerm || (apt.client_name || '').toLowerCase().includes(searchTerm);
                    const matchService = !serviceFilter || apt.service_name === serviceFilter;
                    const matchStatus = !statusFilter || apt.status === statusFilter;
                    return matchSearch && matchService && matchStatus;
                });
            }

            // Populer le filtre de service
            populateServiceFilter(appointments);

            renderTimeline(appointments);
        } catch (error) {
            console.error('Error loading agenda:', error);
            // Show error state
            const dayGrid = document.getElementById('dayTimeGrid');
            const weekGrid = document.getElementById('weekTimeGrid');
            const errorHtml = `
                <div class="text-center py-12 animate-fade-in">
                    <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                        <i data-lucide="alert-circle" class="w-8 h-8 text-red-500"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Erreur de chargement</h3>
                    <p class="text-gray-500 text-sm mb-4">Impossible de charger l'agenda pour cette date.</p>
                    <button class="px-4 py-2 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-lg hover:from-pink-600 hover:to-purple-700 transition-colors text-sm font-medium"
                            onclick="reloadAgenda()">
                        <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-1"></i>
                        Réessayer
                    </button>
                </div>
            `;
            if (dayGrid) dayGrid.innerHTML = errorHtml;
            if (weekGrid) weekGrid.innerHTML = errorHtml;
        } finally {
            // Restore button state
            if (button) {
                button.innerHTML = originalText;
                button.disabled = false;
            }
            if (window.lucide) window.lucide.createIcons();
        }
    }

    function populateServiceFilter(appointments) {
        const select = document.getElementById('filterService');
        if (!select) return;

        const services = [...new Set(appointments.map(apt => apt.service_name).filter(s => s))].sort();
        const currentValue = select.value;

        select.innerHTML = '<option value="">Tous les services</option>' +
            services.map(s => `<option value="${s}">${s}</option>`).join('');

        if (currentValue && services.includes(currentValue)) {
            select.value = currentValue;
        }
    }
</script>
{% endblock %}